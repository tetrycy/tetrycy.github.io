<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytor RTF</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f3f4f6;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .editor-container {
            min-height: 600px;
            width: 100%;
            max-width: 80rem;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        
        .toolbar {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f9fafb;
        }
        
        .btn {
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            background: #e5e7eb;
        }
        
        .btn.active {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }
        
        .separator {
            width: 1px;
            height: 1.5rem;
            background: #d1d5db;
            margin: 0 0.25rem;
        }
        
        .select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background: white;
        }
        
        .filename {
            margin-left: auto;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .search-panel {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            background: #fef3c7;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        
        .search-panel.show {
            display: flex;
        }
        
        .search-input {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            flex: 1;
            max-width: 20rem;
        }
        
        .search-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-btn.primary {
            background: #3b82f6;
            color: white;
        }
        
        .search-btn.primary:hover {
            background: #2563eb;
        }
        
        .search-btn.secondary {
            background: #6b7280;
            color: white;
        }
        
        .search-btn.secondary:hover {
            background: #4b5563;
        }
        
        .editor-area {
            flex: 1;
            padding: 1.5rem;
        }
        
        .editor {
            min-height: 100%;
            outline: none;
            color: black;
            line-height: 1.8;
        }
        
        .editor p {
            margin-bottom: 1em;
        }
        
        .editor p:last-child {
            margin-bottom: 0;
        }
        
        .reading-highlight {
            background: rgba(255, 235, 59, 0.2);
            transition: background 0.3s ease;
            border-radius: 0.25rem;
            padding: 0.25rem 0;
        }
        
        /* TRYB FOCUS */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a1a;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow: hidden;
        }
        
        .focus-mode.active {
            display: flex;
        }
        
        .focus-mode.active ~ * {
            display: none !important;
        }
        
        body.focus-active {
            overflow: hidden;
        }
        
        body.focus-active > *:not(.focus-mode) {
            display: none !important;
        }
        
        .focus-editor {
            width: 100%;
            max-width: 50rem;
            min-height: 60vh;
            background: transparent;
            border: none;
            outline: none;
            color: #e5e5e5;
            font-size: 18px;
            line-height: 1.8;
            padding: 2rem;
            resize: none;
            font-family: inherit;
            overflow: hidden;
        }
        
        .focus-editor::placeholder {
            color: #666;
        }
        
        .focus-mode::-webkit-scrollbar,
        .focus-editor::-webkit-scrollbar {
            display: none;
        }
        
        .focus-mode {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .focus-editor {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .focus-controls {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        
        .focus-controls.hidden-controls {
            opacity: 0;
            pointer-events: none;
        }
        
        .focus-hover-zone {
            position: fixed;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            z-index: 9999;
        }
        
        .focus-hover-zone:hover ~ .focus-controls.hidden-controls {
            opacity: 1;
            pointer-events: all;
        }
        
        .focus-controls.hidden-controls:hover {
            opacity: 1;
            pointer-events: all;
        }
        
        .focus-read-btn {
            width: 2.5rem;
            height: 2.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }
        
        .focus-read-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .focus-read-btn.active {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
        }
        
        .focus-read-btn svg {
            width: 1.25rem;
            height: 1.25rem;
            stroke: #e5e5e5;
        }
        
        .focus-hide-btn {
            width: 2.5rem;
            height: 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 0.625rem;
            transition: color 0.2s;
            text-align: center;
        }
        
        .focus-hide-btn:hover {
            color: #999;
        }
        
        .hidden {
            display: none;
        }
        
        .options-menu-container {
            position: relative;
        }
        
        .options-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.25rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: none;
            min-width: 12rem;
            z-index: 1000;
        }
        
        .options-menu.show {
            display: block;
        }
        
        .options-menu-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.875rem;
            color: #374151;
        }
        
        .options-menu-item:first-child {
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }
        
        .options-menu-item:last-child {
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
        
        .options-menu-item:hover {
            background: #f3f4f6;
        }
        
        .word-count-display {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .word-count-display.hidden {
            display: none;
        }
        
        .focus-word-count {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            font-size: 0.75rem;
            color: #999;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 10000;
            transition: opacity 0.3s ease;
        }
        
        .focus-word-count.hidden-counter {
            opacity: 0;
            pointer-events: none;
        }
        
        .focus-counter-hover-zone {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 150px;
            height: 150px;
            z-index: 9999;
        }
        
        .focus-counter-hover-zone:hover ~ .focus-word-count.hidden-counter {
            opacity: 1;
        }
        
        .focus-word-count.hidden-counter:hover {
            opacity: 1;
        }
        
        .focus-counter-hide-btn {
            margin-top: 0.25rem;
            font-size: 0.625rem;
            color: #666;
            cursor: pointer;
            text-align: center;
            transition: color 0.2s;
        }
        
        .focus-counter-hide-btn:hover {
            color: #999;
        }
        
        /* TIMER */
        .timer-setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }
        
        .timer-setup-modal.show {
            display: flex;
        }
        
        .timer-setup-box {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            min-width: 20rem;
        }
        
        .timer-setup-title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .timer-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .timer-preset-btn {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .timer-preset-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        
        .timer-preset-btn.selected {
            background: #f3f4f6;
            border-color: #6b7280;
            color: #1f2937;
        }
        
        .timer-custom {
            margin-bottom: 1rem;
        }
        
        .timer-custom-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .timer-custom-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .timer-setup-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .timer-setup-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .timer-setup-btn.start {
            background: #6b7280;
            color: white;
        }
        
        .timer-setup-btn.start:hover {
            background: #4b5563;
        }
        
        .timer-setup-btn.cancel {
            background: #e5e7eb;
            color: #374151;
        }
        
        .timer-setup-btn.cancel:hover {
            background: #d1d5db;
        }
        
        .timer-display {
            position: fixed;
            bottom: 1.5rem;
            right: 11rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: #6b7280;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }
        
        .timer-display.active {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timer-display.finished {
            border-color: #10b981;
            background: #d1fae5;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .timer-time {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .timer-controls {
            display: none;
        }
        
        .timer-close-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            font-size: 0.875rem;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .timer-close-btn:hover {
            color: #6b7280;
        }
        
        .timer-message {
            font-size: 0.75rem;
            color: #059669;
            font-style: italic;
            line-height: 1.4;
            width: 100%;
        }
        
        /* Timer w trybie Focus */
        .focus-timer {
            position: fixed;
            bottom: 1.5rem;
             left: 1.5rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: #999;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: none;
            transition: opacity 0.3s ease;
        }
        
        .focus-timer.active {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .focus-timer.hidden-timer {
            opacity: 0;
            pointer-events: none;
        }
        
        .focus-timer.hidden-timer:hover {
            opacity: 1;
            pointer-events: all;
        }
        
        .focus-timer.finished {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.2);
            flex-direction: column;
            align-items: flex-start;
        }
        
        .focus-timer .timer-time {
            color: #e5e5e5;
            font-size: 0.875rem;
        }
        
        .focus-timer .timer-controls {
            display: none;
        }
        
        .focus-timer .timer-close-btn {
            color: #666;
        }
        
        .focus-timer .timer-close-btn:hover {
            color: #999;
        }
        
        .focus-timer .timer-message {
            color: #6ee7b7;
            width: 100%;
        }

        .focus-timer-hover-zone {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 150px;
            height: 150px;
            z-index: 9999;
        }
        
        .focus-timer-hover-zone:hover ~ .focus-timer.hidden-timer {
            opacity: 1;
            pointer-events: all;
        }
        
        .focus-timer-hide-btn {
            margin-top: 0.5rem;
            font-size: 0.625rem;
            color: #666;
            cursor: pointer;
            text-align: center;
            transition: color 0.2s;
        }
        
        .focus-timer-hide-btn:hover {
            color: #999;
        }
        
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="toolbar">
            <div class="options-menu-container">
                <button class="btn" id="optionsBtn" title="Menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <div class="options-menu" id="optionsMenu">
                    <div class="options-menu-item" id="newBtn">Nowy</div>
                    <div class="options-menu-item" id="openBtn">Otwórz</div>
                    <div class="options-menu-item" id="saveBtn">Zapisz jako RTF</div>
                    <div class="options-menu-item" id="exportTxtBtn">Export do TXT</div>
                    <div class="options-menu-item" id="openAsTextBtn">Otwórz jako tekst</div>
                    <div class="options-menu-item" id="exportPdfBtn">Export do PDF</div>
                </div>
            </div>
            
            <div class="separator"></div>
            
            <button class="btn" id="undoBtn" title="Cofnij (Ctrl+Z)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"/>
                    <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <button class="btn" id="boldBtn" title="Pogrubienie (Ctrl+B)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>
                    <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>
                </svg>
            </button>
            
            <button class="btn" id="italicBtn" title="Kursywa (Ctrl+I)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="4" x2="10" y2="4"/>
                    <line x1="14" y1="20" x2="5" y2="20"/>
                    <line x1="15" y1="4" x2="9" y2="20"/>
                </svg>
            </button>
            
            <button class="btn" id="underlineBtn" title="Podkreślenie (Ctrl+U)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/>
                    <line x1="4" y1="21" x2="20" y2="21"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <button class="btn" id="focusBtn" title="Tryb Focus (F11)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <select class="select" id="fontSelect" title="Czcionka">
                <option value="Libre Baskerville" selected>Libre Baskerville</option>
                <option value="Times New Roman">Times New Roman</option>
            </select>
            
            <select class="select" id="fontSizeSelect" title="Rozmiar" style="width: 4rem;">
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12" selected>12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="18">18</option>
                <option value="20">20</option>
                <option value="24">24</option>
                <option value="28">28</option>
                <option value="32">32</option>
                <option value="36">36</option>
            </select>
            
            <select class="select" id="speechRateSelect" title="Szybkość czytania" style="width: 4rem;">
                <option value="0.75">0.75x</option>
                <option value="1.0" selected>1.0x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2.0">2.0x</option>
            </select>
            
            <div class="separator"></div>
            
            <button class="btn" id="readBtn" title="Czytaj od miejsca kursora (Ctrl+R)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <button class="btn" id="searchBtn" title="Wyszukaj (Ctrl+F)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <button class="btn" id="timerBtn" title="Timer pisania">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </button>
            
            <button class="btn" id="toggleCounterBtn" title="Pokaż/ukryj licznik">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                    <path d="m15 5 4 4"/>
                </svg>
            </button>
            
            <div class="filename" id="fileName">dokument.rtf</div>
        </div>
        
        <div class="search-panel" id="searchPanel">
            <input type="text" class="search-input" id="searchInput" placeholder="Wyszukaj...">
            <button class="search-btn primary" id="findBtn">Znajdź</button>
            <button class="search-btn secondary" id="closeSearchBtn">Zamknij</button>
        </div>
        
        <div class="editor-area">
            <div class="editor" id="editor" contenteditable="true">
                <p>Windows 11 pozbawił mnie Wordpada, postanowiłem więc napisać swojego.</p>
                 <p> Piszpad posiada tryb Focus, umiejętność czytania tekstu, a także dwie moje ulubione czcionki.</p>
                 <p> Z czym Piszpad ma problemy, to z otwieraniem plików nienapisanych w nim. Na razie lepiej skopiować tekst i mu wkleić ręcznie.</p>
            </div>
        </div>
        
        <div class="word-count-display" id="wordCountDisplay">0 słów | 0 znaków</div>
        
        <div class="timer-display" id="timerDisplay">
            <div class="timer-time" id="timerTime">25:00</div>
            <button class="timer-close-btn" id="timerCloseBtn">×</button>
            <div class="timer-message" id="timerMessage"></div>
        </div>
        
        <input type="file" class="hidden" id="fileInput" accept=".rtf">
        <input type="file" class="hidden" id="textFileInput" accept=".txt,.rtf">
    </div>

    <!-- Modal ustawień timera -->
    <div class="timer-setup-modal" id="timerSetupModal">
        <div class="timer-setup-box">
            <div class="timer-setup-title">Ustaw czas</div>
            <div class="timer-presets">
                <button class="timer-preset-btn" data-minutes="5">5 min</button>
                <button class="timer-preset-btn" data-minutes="10">10 min</button>
                <button class="timer-preset-btn" data-minutes="15">15 min</button>
                <button class="timer-preset-btn" data-minutes="25">25 min</button>
                <button class="timer-preset-btn" data-minutes="30">30 min</button>
                <button class="timer-preset-btn" data-minutes="45">45 min</button>
                <button class="timer-preset-btn" data-minutes="60">60 min</button>
                <button class="timer-preset-btn" data-minutes="90">90 min</button>
                <button class="timer-preset-btn" data-minutes="120">120 min</button>
            </div>
            <div class="timer-custom">
                <div class="timer-custom-label">Lub własny czas (minuty):</div>
                <input type="number" class="timer-custom-input" id="timerCustomInput" min="1" max="999" placeholder="np. 45">
            </div>
            <div class="timer-setup-buttons">
                <button class="timer-setup-btn cancel" id="timerCancelBtn">Anuluj</button>
                <button class="timer-setup-btn start" id="timerStartBtn">Start</button>
            </div>
        </div>
    </div>

    <!-- TRYB FOCUS -->
    <div class="focus-mode" id="focusMode">
        <div class="focus-hover-zone"></div>
        <div class="focus-controls" id="focusControls">
            <button class="focus-read-btn" id="focusReadBtn" title="Czytaj / Stop">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            </button>
            <button class="focus-hide-btn" id="focusHideBtn">ukryj</button>
        </div>
        
        <div class="focus-counter-hover-zone"></div>
        <div class="focus-word-count" id="focusWordCount">
            <div id="focusCounterText">0 słów | 0 znaków</div>
            <div class="focus-counter-hide-btn" id="focusCounterHideBtn">ukryj</div>
        </div>
        <div class="focus-timer-hover-zone"></div>
        <div class="focus-timer" id="focusTimer">
            <div class="timer-time" id="focusTimerTime">25:00</div>
            <button class="timer-close-btn" id="focusTimerCloseBtn">×</button>
            <div class="timer-message" id="focusTimerMessage"></div>
            <div class="focus-timer-hide-btn" id="focusTimerHideBtn">ukryj</div>
        </div>
        
        <textarea class="focus-editor" id="focusEditor" placeholder=""></textarea>
    </div>

    <script>
        var editor, fileName, isReading, fontFamily, fontSize, speechRate, isFocusMode, undoHistory, historyIndex, readingParagraphs, currentParagraphIndex, focusControlsHidden, selectedVoice, lastCursorPosition, openAsTextMode, wordCountVisible, focusCounterHidden;
        var timerMinutes, timerSeconds, timerInterval, timerRunning, focusTimerHidden;
        
        // Gratulacje w stylu 100 pisarzy (90 światowych + 10 polskich)
        // Prawdziwe cytaty o pisaniu od 100 pisarzy
        var writerCongratulations = [
            // 1-10
            "Pisanie jest łatwe. Wystarczyusiąść przed pustą kartką papieru i czekać, aż na czole wykrwawią się krople krwi.\n— Ernest Hemingway",
            "Nie ma nic do pisania. Wszystko, co musisz zrobić, to usiąść przy maszynie do pisania i krwawić.\n— Ernest Hemingway",
            "Pisanie to nie jest praca. To jest coś, co robisz, aby przetrwać.\n— Charles Bukowski",
            "Pierwszy szkic czegokolwiek jest gównem.\n— Ernest Hemingway",
            "Piszę, aby dowiedzieć się, co myślę.\n— Joan Didion",
            "Słowa są źródłem zarówno nieporozumień, jak i zrozumienia.\n— Antoine de Saint-Exupéry",
            "Pisanie jest aktem wiary, a nie sztuczką gramatyczną.\n— E.B. White",
            "Jeśli nie możesz tego jasno napisać, prawdopodobnie nie myślisz o tym jasno.\n— Saul Bellow",
            "Zamknij drzwi. Pisarz, który się boi swojego wydawcy, matki, żony, prawników - pisarz, który się boi czegokolwiek - jest stracony.\n— Philip Roth",
            "Nie możesz czekać na inspirację. Musisz za nią gonić kijem.\n— Jack London",
            
            // 11-20
            "Pisanie jest odkrywaniem. Nie możesz wiedzieć, co się stanie, dopóki nie napiszesz.\n— E.L. Doctorow",
            "Jeśli historia nie wywołuje uczuć w pisarzu, nie może wywołać ich w czytelniku.\n— Roald Dahl",
            "Pisanie to jedyny sposób, w jaki mogę uporządkować chaos w mojej głowie.\n— Francesca Lia Block",
            "Nie pisz tego, co wiesz. Pisz to, co chcesz poznać.\n— Don DeLillo",
            "Każdy pierwszy szkic jest doskonały, ponieważ wszystko, co musi zrobić, to istnieć.\n— Jane Smiley",
            "Pisarstwo to samotność w towarzystwie słów.\n— William Styron",
            "Piszę po to, by uczynić życie dwukrotnym.\n— Anais Nin",
            "Pisanie książki to straszna, wyczerpująca walka, jak długi atak bolesnej choroby.\n— George Orwell",
            "Pisanie to sposób na rozmowę, gdy nikt nie pozwoli ci przerwać.\n— Fran Lebowitz",
            "Aby pisać, musisz mieć dużo czasu wolnego głowy.\n— Brenda Ueland",
            
            // 21-30
            "Pisanie to odkrywanie tego, co już wiesz.\n— Flannery O'Connor",
            "Najpierw zapomnij o inspiracji. Nawyk jest trwalszy. Nawyk będzie podtrzymywał cię, czy jesteś zainspirowany, czy nie.\n— Octavia Butler",
            "Jeśli moja pisownia jest zła, nie jestem głupi. Po prostu nie mogę przeliterować.\n— Mark Twain",
            "Wypełnij swój papier wydechem serca.\n— William Wordsworth",
            "Pisanie to pokonywanie codziennego oporu.\n— Steven Pressfield",
            "Nie ma przyjemności większej niż ta, którą daje pisanie, gdy udaje się udane zdanie.\n— Barbara Tuchman",
            "Pisanie to sposób na życie dwukrotnym.\n— Catherine Drinker Bowen",
            "Każdy sekret duszy poety, każde doświadczenie jego życia, każda cecha jego umysłu jest w jego wierszach.\n— Virginia Woolf",
            "Pisanie jest aktem dumy.\n— Janet Frame",
            "Pisanie to brudna robota, ale ktoś musi to robić.\n— Rita Mae Brown",
            
            // 31-40
            "Sztuka pisania polega na tym, by pozwolić, aby słowa wyszły z ciebie.\n— Natalie Goldberg",
            "Pisanie nie jest życiem, ale myślę, że czasami może być sposobem na życie.\n— Stephen King",
            "Dobrze pisać, to prawie myśleć.\n— Gustave Flaubert",
            "Pisanie to jedyny zawód, w którym nikt nie uważa cię za aroganta, jeśli mówisz, że jesteś dobry.\n— John Updike",
            "Pisanie to robienie znaczenia.\n— Robert Frost",
            "Pisanie jest samotne. To towarzystwo tylko z tym, co napisałeś.\n— James Baldwin",
            "Jeśli chcesz być pisarzem, przede wszystkim musisz robić dwie rzeczy: dużo czytać i dużo pisać.\n— Stephen King",
            "Nie ma reguły, jak pisać. Czasami przychodzi jak ciepły deszcz. Czasami jak kawałek kory z drzewa.\n— Charles Bukowski",
            "Pisanie to łagodny, intymny rozmowa między tobą a stroną.\n— Maya Angelou",
            "Jedyna zasada pisania: nie nudzić.\n— Kingsley Amis",
            
            // 41-50
            "Pisanie to akt nadziei.\n— John Steinbeck",
            "Każda pierwsza wersja jest do niczego.\n— Hemingway parafrazowany",
            "Pisanie niczym się nie różni od medytacji lub modlitwy.\n— Paulo Coelho",
            "Jeśli nie masz czasu na przeczytanie, nie masz czasu ani narzędzi do pisania.\n— Stephen King",
            "Pisanie to droga do siebie.\n— Hermann Hesse",
            "Bądź sobą. Każdy inny jest już zajęty.\n— Oscar Wilde",
            "Pisanie jest łatwe: wystarczy wpatrywać się w pustą kartkę, aż na czole pojawią się krople krwi.\n— Gene Fowler",
            "Sekret dobrego pisania to mówienie prawdy.\n— Gordon Lish",
            "Zastanawiam się, czy to, co napisałem ma znaczenie dla kogokolwiek poza mną.\n— Franz Kafka",
            "Pisanie to sposób wyrażania tego, kim jesteś.\n— Muriel Spark",
            
            // 51-60
            "Pisanie to tworzenie świata z niczego.\n— Margaret Atwood",
            "Pozbądź się wszystkiego, co nie jest opowieścią.\n— Anton Chekhov",
            "Pisanie jest formą terapii.\n— Graham Greene",
            "Czytamy, żeby wiedzieć, że nie jesteśmy sami.\n— C.S. Lewis",
            "Pisanie to najgłębsza forma czytania życia.\n— Marguerite Duras",
            "Pisanie wymaga ciszy, ale cisza wymaga odwagi.\n— Alice Munro",
            "Jeśli chcesz być pisarzem, musisz robić dwie rzeczy ponad wszystko inne: dużo czytać i dużo pisać.\n— Stephen King",
            "Dobra proza jest jak szyba okienna.\n— George Orwell",
            "Piękno pisania polega na tym, że nie musisz czekać na odpowiedź.\n— Gabriel García Márquez",
            "Pisanie to podróż w nieznane.\n— Umberto Eco",
            
            // 61-70
            "Musisz pisać książkę, która chce być napisana.\n— Madeleine L'Engle",
            "Pisanie jest łatwe. Wystarczy skreślić złe słowa.\n— Mark Twain",
            "Sztuka pisania polega na usuwaniu.\n— Ezra Pound",
            "Perfekcja nie istnieje. Po prostu przestań pisać.\n— Charles Bukowski parafrazowany",
            "Pisanie to przekształcanie życia w coś prawdziwszego niż rzeczywistość.\n— Ernest Hemingway parafrazowany",
            "Pisać znaczy zostawiać ślad.\n— Hélène Cixous",
            "Nigdy nie pisz o miejscu, dopóki nie opuścisz go.\n— Ernest Hemingway",
            "Pisanie to delikatna, ale mięsista sztuka.\n— Vladimir Nabokov",
            "Pisanie jest najlepszym sposobem rozmowy z ludźmi, których nie znasz.\n— Larry McMurtry",
            "Jeśli nie masz wrogów, nie masz charakteru.\n— Paul Newman",
            
            // 71-80
            "Pisanie jest społecznym aktem.\n— Anne Lamott",
            "Pisanie to nie jest praca. To jest sposób życia.\n— John Irving",
            "Trudne pisanie sprawia łatwą lekturę.\n— William Zinsser",
            "Pisanie jest jak prowadzenie samochodu w nocy. Widzisz tylko to, co znajduje się w światłach reflektorów.\n— E.L. Doctorow",
            "Muszę pisać każdego dnia. Jeśli podróżuję, piszę w hotelach.\n— Graham Greene",
            "Pisanie to ekstremalna forma samotności.\n— Paul Auster",
            "Pisanie to ucieczka w fikcję.\n— Jhumpa Lahiri",
            "To, co naprawdę chcę powiedzieć, to to, że pisanie jest trudne.\n— Zadie Smith",
            "Pisanie wymaga dyscypliny i cierpliwości.\n— Haruki Murakami",
            "Pisanie jest jak medytacja. Musisz być obecny.\n— Natalie Goldberg",
            
            // 81-90
            "Pisanie to praca ciężka. Dzień po dniu, słowo po słowie.\n— Octavia Butler",
            "Pisz pijany, edytuj trzeźwy.\n— Peter De Vries",
            "Nie pisz tego, co się sprzedaje. Pisz to, co kochasz.\n— Ray Bradbury",
            "Pisanie jest aktem wsłuchiwania się w to, co chce zostać powiedziane.\n— Don Murray",
            "Pisanie to sposób na porządkowanie chaosu.\n— Toni Morrison",
            "Dobry pisarz posiada nie tylko własną duszę, ale i dusze swoich przyjaciół.\n— Friedrich Nietzsche",
            "Pisanie to jedna trzecia talent, dwie trzecie dyscyplina.\n— John Irving",
            "Pisanie książek jest najbardziej samotną profesją na świecie.\n— Sinclair Lewis",
            "Pisanie nie jest o zarabianiu pieniędzy. To o czynieniu cudów.\n— Francesca Lia Block",
            "Pisanie to myślenie na papierze.\n— William Zinsser",
            
            // 91-100: Polscy pisarze
            "Pisanie to nieustanne przezwyciężanie własnej przeciętności.\n— Witold Gombrowicz",
            "Wszystko, co napisane, jest kłamstwem. Wszystko, co niewypowiedziane, jest prawdą.\n— Wisława Szymborska",
            "Pisanie jest przede wszystkim milczeniem.\n— Zbigniew Herbert",
            "Słowo raz wypowiedziane, jak kamień rzucony w wodę - krąg za kręgiem się rozchodzi.\n— Czesław Miłosz",
            "Pisarz musi być głosem tych, którzy nie mogą mówić.\n— Ryszard Kapuściński",
            "Pisanie to odkrywanie tajemnic, które się w nas kryją.\n— Olga Tokarczuk",
            "Literatura jest grą, którą toczymy z nieuchronnością losu.\n— Stanisław Lem",
            "Pisać - to znaczy podróżować bez trudu zmęczenia.\n— Julian Tuwim",
            "Trzeba pisać tak, jakby się było pierwszym człowiekiem, który to robi.\n— Witold Gombrowicz",
            "Pisanie jest jak oddychanie - jeśli przestanę, umrę.\n— Wisława Szymborska"
        ];
        
        function init() {
            editor = document.getElementById('editor');
            fileName = 'dokument.rtf';
            isReading = false;
            fontFamily = 'Libre Baskerville';
            fontSize = 12;
            speechRate = 1.0;
            isFocusMode = false;
            undoHistory = [];
            historyIndex = -1;
            readingParagraphs = [];
            currentParagraphIndex = -1;
            focusControlsHidden = false;
            selectedVoice = null;
            lastCursorPosition = 0;
            openAsTextMode = false;
            wordCountVisible = true;
            focusCounterHidden = false;
            timerMinutes = 0;
            timerSeconds = 0;
            timerInterval = null;
            timerRunning = false;
            focusTimerHidden = false;
            
            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            
            saveState();
            
            document.getElementById('newBtn').onclick = newDoc;
            document.getElementById('openBtn').onclick = openDoc;
            document.getElementById('saveBtn').onclick = saveDoc;
            document.getElementById('undoBtn').onclick = undo;
            document.getElementById('boldBtn').onclick = function() { formatText('bold'); };
            document.getElementById('italicBtn').onclick = function() { formatText('italic'); };
            document.getElementById('underlineBtn').onclick = function() { formatText('underline'); };
            document.getElementById('searchBtn').onclick = toggleSearch;
            document.getElementById('readBtn').onclick = toggleReading;
            document.getElementById('focusBtn').onclick = toggleFocusMode;
            document.getElementById('toggleCounterBtn').onclick = toggleWordCount;
            document.getElementById('timerBtn').onclick = openTimerSetup;
            
            document.getElementById('fontSelect').onchange = function() { 
                fontFamily = this.value; 
                updateStyle();
            };
            document.getElementById('fontSizeSelect').onchange = function() { 
                fontSize = parseInt(this.value); 
                updateStyle();
            };
            document.getElementById('speechRateSelect').onchange = function() { 
                speechRate = parseFloat(this.value); 
            };
            
            document.getElementById('findBtn').onclick = doSearch;
            document.getElementById('closeSearchBtn').onclick = toggleSearch;
            document.getElementById('searchInput').onkeydown = function(e) {
                if (e.key === 'Enter') doSearch();
            };
            
            document.getElementById('fileInput').onchange = loadFile;
            document.getElementById('textFileInput').onchange = loadFileAsText;
            document.getElementById('optionsBtn').onclick = toggleOptionsMenu;
            document.getElementById('exportTxtBtn').onclick = exportToTxt;
            document.getElementById('openAsTextBtn').onclick = openAsText;
            document.getElementById('exportPdfBtn').onclick = exportToPdf;
            
            // Timer setup
            var presetBtns = document.querySelectorAll('.timer-preset-btn');
            for (var i = 0; i < presetBtns.length; i++) {
                presetBtns[i].onclick = function() {
                    var allBtns = document.querySelectorAll('.timer-preset-btn');
                    for (var j = 0; j < allBtns.length; j++) {
                        allBtns[j].classList.remove('selected');
                    }
                    this.classList.add('selected');
                    document.getElementById('timerCustomInput').value = '';
                };
            }
            
document.getElementById('timerCancelBtn').onclick = closeTimerSetup;
            document.getElementById('timerStartBtn').onclick = startTimer;
            document.getElementById('timerCloseBtn').onclick = resetTimer;
            document.getElementById('focusTimerCloseBtn').onclick = resetTimer;
            document.getElementById('focusTimerHideBtn').onclick = function() {
                document.getElementById('focusTimer').classList.add('hidden-timer');
                focusTimerHidden = true;
            };
            
            document.onkeydown = keyHandler;
            
            editor.addEventListener('input', function() {
                saveState();
                updateWordCount();
            });
            
            editor.addEventListener('mouseup', updateFormatButtons);
            editor.addEventListener('keyup', updateFormatButtons);
            
            updateStyle();
            updateWordCount();
            
            document.addEventListener('click', function(e) {
                var optionsMenu = document.getElementById('optionsMenu');
                var optionsBtn = document.getElementById('optionsBtn');
                var timerSetupModal = document.getElementById('timerSetupModal');
                
                if (!optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
                    optionsMenu.classList.remove('show');
                }
                
                if (e.target === timerSetupModal) {
                    closeTimerSetup();
                }
            });
        }
        
        function loadVoices() {
            var voices = speechSynthesis.getVoices();
            if (voices.length === 0) return;
            
            for (var i = 0; i < voices.length; i++) {
                if (voices[i].lang.includes('pl') && voices[i].name.includes('Paulina')) {
                    selectedVoice = voices[i];
                    console.log('Używam głosu:', voices[i].name);
                    return;
                }
            }
            
            for (var i = 0; i < voices.length; i++) {
                if (voices[i].lang.includes('pl')) {
                    selectedVoice = voices[i];
                    console.log('Używam głosu:', voices[i].name);
                    return;
                }
            }
            
            console.log('Brak polskiego głosu, używam domyślnego');
        }
        
        function updateFormatButtons() {
            var commands = ['bold', 'italic', 'underline'];
            for (var i = 0; i < commands.length; i++) {
                var cmd = commands[i];
                var btn = document.getElementById(cmd + 'Btn');
                if (btn) {
                    if (document.queryCommandState(cmd)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                }
            }
        }
        
        function saveState() {
            var currentState = editor.innerHTML;
            
            if (undoHistory.length === 0 || undoHistory[historyIndex] !== currentState) {
                undoHistory = undoHistory.slice(0, historyIndex + 1);
                undoHistory.push(currentState);
                historyIndex = undoHistory.length - 1;
                
                if (undoHistory.length > 50) {
                    undoHistory = undoHistory.slice(-50);
                    historyIndex = undoHistory.length - 1;
                }
            }
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                editor.innerHTML = undoHistory[historyIndex];
                editor.focus();
                
                var range = document.createRange();
                var sel = window.getSelection();
                range.selectNodeContents(editor);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        
        function formatText(command) {
            document.execCommand(command, false, null);
            editor.focus();
            
            var btnId = command + 'Btn';
            var btn = document.getElementById(btnId);
            if (btn) {
                var isFormatted = document.queryCommandState(command);
                if (isFormatted) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            
            saveState();
        }
        
        function keyHandler(e) {
            if (e.ctrlKey) {
                if (e.key === 'n') { e.preventDefault(); newDoc(); }
                if (e.key === 's') { e.preventDefault(); saveDoc(); }
                if (e.key === 'o') { e.preventDefault(); openDoc(); }
                if (e.key === 'f') { e.preventDefault(); toggleSearch(); }
                if (e.key === 'r') { e.preventDefault(); toggleReading(); }
                if (e.key === 'z') { e.preventDefault(); undo(); }
                if (e.key === 'b') { e.preventDefault(); formatText('bold'); }
                if (e.key === 'i') { e.preventDefault(); formatText('italic'); }
                if (e.key === 'u') { e.preventDefault(); formatText('underline'); }
            }
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFocusMode();
            }
            if (e.key === 'Escape') {
                if (isFocusMode) {
                    exitFocusMode();
                } else {
                    closeSearch();
                    if (isReading) stopReading();
                }
            }
        }
        
        function newDoc() {
            editor.innerHTML = '<p>Zacznij pisać swój dokument...</p>';
            fileName = 'dokument.rtf';
            document.getElementById('fileName').textContent = fileName;
            
            undoHistory = [];
            historyIndex = -1;
            saveState();
            updateWordCount();
            document.getElementById('optionsMenu').classList.remove('show');
        }
        
        function openDoc() {
            document.getElementById('fileInput').click();
            document.getElementById('optionsMenu').classList.remove('show');
        }
        
        function saveDoc() {
            var html = editor.innerHTML;
            var rtf = toRTF(html);
            var blob = new Blob([rtf], { type: 'application/rtf' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('optionsMenu').classList.remove('show');
        }
        
        function loadFile(e) {
            var file = e.target.files[0];
            if (file) {
                fileName = file.name;
                document.getElementById('fileName').textContent = fileName;
                var reader = new FileReader();
                reader.onload = function(e) {
                    var rtf = e.target.result;
                    var html = fromRTF(rtf);
                    editor.innerHTML = html;
                    
                    undoHistory = [];
                    historyIndex = -1;
                    saveState();
                    updateWordCount();
                };
                reader.readAsText(file);
            }
        }
        
        function toggleSearch() {
            var panel = document.getElementById('searchPanel');
            var btn = document.getElementById('searchBtn');
            if (panel.classList.contains('show')) {
                closeSearch();
            } else {
                panel.classList.add('show');
                btn.classList.add('active');
                document.getElementById('searchInput').focus();
            }
        }
        
        function closeSearch() {
            document.getElementById('searchPanel').classList.remove('show');
            document.getElementById('searchBtn').classList.remove('active');
        }
        
        function doSearch() {
            var term = document.getElementById('searchInput').value;
            if (term && window.find) {
                window.find(term, false, false, true);
            }
        }
        
        function updateStyle() {
            var family = fontFamily === 'Times New Roman' ? 'Times New Roman, serif' : 'Libre Baskerville, serif';
            editor.style.fontFamily = family;
            editor.style.fontSize = fontSize + 'pt';
        }
        
        function updateWordCount() {
            var text = editor.innerText || editor.textContent || '';
            var words = text.trim().split(/\s+/).filter(function(w) { return w.length > 0; });
            var chars = text.length;
            var countText = words.length + ' słów | ' + chars + ' znaków';
            
            document.getElementById('wordCountDisplay').textContent = countText;
            
            if (isFocusMode) {
                document.getElementById('focusCounterText').textContent = countText;
            }
        }
        
        function toggleWordCount() {
            wordCountVisible = !wordCountVisible;
            var display = document.getElementById('wordCountDisplay');
            var btn = document.getElementById('toggleCounterBtn');
            
            if (wordCountVisible) {
                display.classList.remove('hidden');
                btn.classList.add('active');
            } else {
                display.classList.add('hidden');
                btn.classList.remove('active');
            }
        }
        
        function toggleOptionsMenu() {
            var menu = document.getElementById('optionsMenu');
            menu.classList.toggle('show');
        }
        
        function exportToTxt() {
            var text = editor.innerText || editor.textContent || '';
            var blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName.replace(/\.rtf$/, '.txt');
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('optionsMenu').classList.remove('show');
        }
        
        function openAsText() {
            openAsTextMode = true;
            document.getElementById('textFileInput').click();
            document.getElementById('optionsMenu').classList.remove('show');
        }
        
        function loadFileAsText(e) {
            var file = e.target.files[0];
            if (file) {
                fileName = file.name;
                document.getElementById('fileName').textContent = fileName;
                var reader = new FileReader();
                reader.onload = function(e) {
                    var text = e.target.result;
                    var htmlContent = '<p>' + text.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
                    editor.innerHTML = htmlContent;
                    
                    undoHistory = [];
                    historyIndex = -1;
                    saveState();
                    updateWordCount();
                };
                reader.readAsText(file);
            }
            openAsTextMode = false;
        }
        
        function exportToPdf() {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            
            var text = editor.innerText || editor.textContent || '';
            
            var pageHeight = doc.internal.pageSize.height;
            var lineHeight = 7;
            var margin = 20;
            var maxWidth = 170;
            var yPosition = margin;
            
            var lines = doc.splitTextToSize(text, maxWidth);
            
            for (var i = 0; i < lines.length; i++) {
                if (yPosition + lineHeight > pageHeight - margin) {
                    doc.addPage();
                    yPosition = margin;
                }
                doc.text(lines[i], margin, yPosition);
                yPosition += lineHeight;
            }
            
            doc.save(fileName.replace(/\.rtf$/, '.pdf'));
            document.getElementById('optionsMenu').classList.remove('show');
        }
        
        // TIMER FUNCTIONS
        function openTimerSetup() {
            document.getElementById('timerSetupModal').classList.add('show');
        }
        
        function closeTimerSetup() {
            document.getElementById('timerSetupModal').classList.remove('show');
            var allBtns = document.querySelectorAll('.timer-preset-btn');
            for (var i = 0; i < allBtns.length; i++) {
                allBtns[i].classList.remove('selected');
            }
            document.getElementById('timerCustomInput').value = '';
        }
        
        function startTimer() {
            var selectedBtn = document.querySelector('.timer-preset-btn.selected');
            var customInput = document.getElementById('timerCustomInput');
            var minutes = 0;
            
            if (customInput.value) {
                minutes = parseInt(customInput.value);
            } else if (selectedBtn) {
                minutes = parseInt(selectedBtn.getAttribute('data-minutes'));
            } else {
                alert('Wybierz czas lub wpisz własny');
                return;
            }
            
            if (minutes < 1) {
                alert('Czas musi być większy niż 0');
                return;
            }
            
            timerMinutes = minutes;
            timerSeconds = 0;
            timerRunning = true;
            
            updateTimerDisplay();
            
            var normalDisplay = document.getElementById('timerDisplay');
            var focusDisplay = document.getElementById('focusTimer');
            
            normalDisplay.classList.add('active');
            normalDisplay.classList.remove('finished');
            document.getElementById('timerMessage').textContent = '';
            
            if (isFocusMode) {
                focusDisplay.classList.add('active');
                focusDisplay.classList.remove('finished');
                focusDisplay.classList.remove('hidden-timer');
                focusTimerHidden = false;
                document.getElementById('focusTimerMessage').textContent = '';
            }
            
            closeTimerSetup();
            
            timerInterval = setInterval(function() {
                if (timerSeconds === 0) {
                    if (timerMinutes === 0) {
                        finishTimer();
                        return;
                    }
                    timerMinutes--;
                    timerSeconds = 59;
                } else {
                    timerSeconds--;
                }
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            var timeStr = timerMinutes + ':' + (timerSeconds < 10 ? '0' : '') + timerSeconds;
            document.getElementById('timerTime').textContent = timeStr;
            document.getElementById('focusTimerTime').textContent = timeStr;
        }
        
        function resetTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            timerRunning = false;
            timerMinutes = 0;
            timerSeconds = 0;
            
            document.getElementById('timerDisplay').classList.remove('active');
            document.getElementById('timerDisplay').classList.remove('finished');
            document.getElementById('focusTimer').classList.remove('active');
            document.getElementById('focusTimer').classList.remove('finished');
            document.getElementById('timerMessage').textContent = '';
            document.getElementById('focusTimerMessage').textContent = '';
        }
        
        function finishTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            timerRunning = false;
            
            var randomIndex = Math.floor(Math.random() * writerCongratulations.length);
            var congratulation = writerCongratulations[randomIndex];
            
            document.getElementById('timerDisplay').classList.add('finished');
            document.getElementById('timerMessage').textContent = congratulation;
            
            if (isFocusMode) {
                document.getElementById('focusTimer').classList.add('finished');
                document.getElementById('focusTimerMessage').textContent = congratulation;
            }
        }
        
        function getCursor() {
            var sel = window.getSelection();
            if (sel.rangeCount === 0) return 0;
            var range = sel.getRangeAt(0);
            var pre = range.cloneRange();
            pre.selectNodeContents(editor);
            pre.setEnd(range.startContainer, range.startOffset);
            return pre.toString().length;
        }
        
        function toggleReading() {
            if (isReading) {
                stopReading();
            } else {
                startReading();
            }
        }
        
        function startReading() {
            if (!speechSynthesis) {
                alert('Brak obsługi czytania.');
                return;
            }
            
            var allParagraphs = editor.querySelectorAll('p');
            var cursorPos = getCursor();
            
            var textSoFar = 0;
            var startParagraphIndex = 0;
            
            for (var i = 0; i < allParagraphs.length; i++) {
                var paraText = allParagraphs[i].innerText || allParagraphs[i].textContent || '';
                if (textSoFar + paraText.length >= cursorPos) {
                    startParagraphIndex = i;
                    break;
                }
                textSoFar += paraText.length;
            }
            
            readingParagraphs = [];
            for (var j = startParagraphIndex; j < allParagraphs.length; j++) {
                var text = allParagraphs[j].innerText || allParagraphs[j].textContent || '';
                if (text.trim()) {
                    readingParagraphs.push({
                        element: allParagraphs[j],
                        text: text.trim()
                    });
                }
            }
            
            if (readingParagraphs.length === 0) {
                alert('Brak tekstu do czytania od pozycji kursora.');
                return;
            }
            
            currentParagraphIndex = 0;
            isReading = true;
            
            var btn = document.getElementById('readBtn');
            btn.classList.add('active');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
            
            readNextParagraph();
        }
        
        function readNextParagraph() {
            if (!isReading || currentParagraphIndex >= readingParagraphs.length) {
                stopReading();
                return;
            }
            
            var currentPara = readingParagraphs[currentParagraphIndex];
            
            var highlighted = editor.querySelectorAll('.reading-highlight');
            for (var i = 0; i < highlighted.length; i++) {
                highlighted[i].classList.remove('reading-highlight');
            }
            
            currentPara.element.classList.add('reading-highlight');
            currentPara.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            var utterance = new SpeechSynthesisUtterance(currentPara.text);
            utterance.lang = 'pl-PL';
            utterance.rate = speechRate;
            utterance.pitch = 1;
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.onend = function() {
                if (isReading) {
                    currentParagraphIndex++;
                    readNextParagraph();
                }
            };
            
            utterance.onerror = function(e) {
                if (e.error === 'canceled' || e.error === 'interrupted') {
                    return;
                }
                stopReading();
                alert('Błąd podczas czytania: ' + e.error);
            };
            
            speechSynthesis.speak(utterance);
        }
        
        function stopReading() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            isReading = false;
            
            var highlighted = editor.querySelectorAll('.reading-highlight');
            for (var i = 0; i < highlighted.length; i++) {
                highlighted[i].classList.remove('reading-highlight');
            }
            
            readingParagraphs = [];
            currentParagraphIndex = -1;
            
            var btn = document.getElementById('readBtn');
            btn.classList.remove('active');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
        }
        
        function toRTF(html) {
            var font = fontFamily === 'Times New Roman' ? 'Times New Roman' : 'Libre Baskerville';
            var rtf = '{\\rtf1\\ansi\\ansicpg1250\\deff0 {\\fonttbl {\\f0 ' + font + ';}}\\f0\\fs' + (fontSize * 2) + ' ';
            
            var cleanText = html
                .replace(/<br\s*\/?>/gi, '\\line ')
                .replace(/<\/p>/gi, '\\par ')
                .replace(/<p[^>]*>/gi, '')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '{\\b $1}')
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '{\\b $1}')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '{\\i $1}')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '{\\i $1}')
                .replace(/<u[^>]*>(.*?)<\/u>/gi, '{\\ul $1}')
                .replace(/<[^>]+>/g, '');
            
            cleanText = cleanText
                .replace(/ą/g, "\\'b1")
                .replace(/Ą/g, "\\'a1")
                .replace(/ć/g, "\\'e6")
                .replace(/Ć/g, "\\'c6")
                .replace(/ę/g, "\\'ea")
                .replace(/Ę/g, "\\'ca")
                .replace(/ł/g, "\\'b3")
                .replace(/Ł/g, "\\'a3")
                .replace(/ń/g, "\\'f1")
                .replace(/Ń/g, "\\'d1")
                .replace(/ó/g, "\\'f3")
                .replace(/Ó/g, "\\'d3")
                .replace(/ś/g, "\\'9c")
                .replace(/Ś/g, "\\'8c")
                .replace(/ź/g, "\\'9f")
                .replace(/Ź/g, "\\'8f")
                .replace(/ż/g, "\\'bf")
                .replace(/Ż/g, "\\'af");
            
            rtf += cleanText + '}';
            return rtf;
        }
        
        function parseRTFFormatting(text) {
            var result = '';
            var i = 0;
            
            while (i < text.length) {
                if (text[i] === '{' && text[i+1] === '\\') {
                    var formatType = '';
                    if (text.substr(i, 3) === '{\\b' && text[i+3] !== '0') {
                        formatType = 'BOLD';
                    } else if (text.substr(i, 3) === '{\\i' && text[i+3] !== '0') {
                        formatType = 'ITALIC';
                    } else if (text.substr(i, 4) === '{\\ul' && text[i+4] !== '0') {
                        formatType = 'UNDERLINE';
                    }
                    
                    if (formatType) {
                        var depth = 1;
                        var start = i + (formatType === 'UNDERLINE' ? 4 : 3);
                        while (start < text.length && text[start] === ' ') start++;
                        
                        var j = start;
                        var content = '';
                        
                        while (j < text.length && depth > 0) {
                            if (text[j] === '{') {
                                depth++;
                            } else if (text[j] === '}') {
                                depth--;
                                if (depth === 0) break;
                            }
                            content += text[j];
                            j++;
                        }
                        
                        var parsedContent = parseRTFFormatting(content);
                        
                        if (formatType === 'BOLD') {
                            result += '|||BOLD_START|||' + parsedContent + '|||BOLD_END|||';
                        } else if (formatType === 'ITALIC') {
                            result += '|||ITALIC_START|||' + parsedContent + '|||ITALIC_END|||';
                        } else if (formatType === 'UNDERLINE') {
                            result += '|||UNDERLINE_START|||' + parsedContent + '|||UNDERLINE_END|||';
                        }
                        
                        i = j + 1;
                        continue;
                    }
                }
                
                result += text[i];
                i++;
            }
            
            return result;
        }
        
        function fromRTF(rtf) {
            if (rtf.indexOf('\\rtf') === -1) {
                return '<p>' + rtf.replace(/\n/g, '</p><p>') + '</p>';
            }
            
            var text = rtf;
            
            text = text.replace(/\\par\s*/g, '|||PARAGRAPH|||');
            text = text.replace(/\\line\s*/g, '|||LINEBREAK|||');
            
            text = text
                .replace(/\\'b1/g, 'ą').replace(/'b1/g, 'ą').replace(/\\u185\?/g, 'ą')
                .replace(/\\'a1/g, 'Ą').replace(/'a1/g, 'Ą').replace(/\\u260\?/g, 'Ą')
                .replace(/\\'e6/g, 'ć').replace(/'e6/g, 'ć').replace(/\\u263\?/g, 'ć')
                .replace(/\\'c6/g, 'Ć').replace(/'c6/g, 'Ć').replace(/\\u262\?/g, 'Ć')
                .replace(/\\'ea/g, 'ę').replace(/'ea/g, 'ę').replace(/\\u281\?/g, 'ę')
                .replace(/\\'ca/g, 'Ę').replace(/'ca/g, 'Ę').replace(/\\u280\?/g, 'Ę')
                .replace(/\\'b3/g, 'ł').replace(/'b3/g, 'ł').replace(/\\u322\?/g, 'ł')
                .replace(/\\'a3/g, 'Ł').replace(/'a3/g, 'Ł').replace(/\\u321\?/g, 'Ł')
                .replace(/\\'f1/g, 'ń').replace(/'f1/g, 'ń').replace(/\\u324\?/g, 'ń')
                .replace(/\\'d1/g, 'Ń').replace(/'d1/g, 'Ń').replace(/\\u323\?/g, 'Ń')
                .replace(/\\'f3/g, 'ó').replace(/'f3/g, 'ó').replace(/\\u243\?/g, 'ó')
                .replace(/\\'d3/g, 'Ó').replace(/'d3/g, 'Ó').replace(/\\u211\?/g, 'Ó')
                .replace(/\\'9c/g, 'ś').replace(/'9c/g, 'ś').replace(/\\u347\?/g, 'ś')
                .replace(/\\'8c/g, 'Ś').replace(/'8c/g, 'Ś').replace(/\\u346\?/g, 'Ś')
                .replace(/\\'9f/g, 'ź').replace(/'9f/g, 'ź').replace(/\\u378\?/g, 'ź')
                .replace(/\\'8f/g, 'Ź').replace(/'8f/g, 'Ź').replace(/\\u377\?/g, 'Ź')
                .replace(/\\'bf/g, 'ż').replace(/'bf/g, 'ż').replace(/\\u380\?/g, 'ż')
                .replace(/\\'af/g, 'Ż').replace(/'af/g, 'Ż').replace(/\\u379\?/g, 'Ż')
                .replace(/\\'84/g, '"').replace(/'84/g, '"')
                .replace(/\\'94/g, '"').replace(/'94/g, '"')
                .replace(/\\'96/g, '–').replace(/'96/g, '–')
                .replace(/\\'97/g, '—').replace(/'97/g, '—');
            
            text = text.replace(/^\{\\rtf[^{}]*/, '');
            text = text.replace(/\}$/, '');
            
            text = parseRTFFormatting(text);
            
            text = text.replace(/\\[a-z]+\d*\s*/gi, ' ');
            text = text.replace(/\{[^}]*\}/g, '');
            text = text.replace(/\\/g, '');
            
            text = text.replace(/\s+/g, ' ').trim();
            text = text.replace(/^\{+/, '').replace(/\}+$/, '');
            
            text = text.replace(/\|\|\|BOLD_START\|\|\|/g, '<strong>');
            text = text.replace(/\|\|\|BOLD_END\|\|\|/g, '</strong>');
            text = text.replace(/\|\|\|ITALIC_START\|\|\|/g, '<em>');
            text = text.replace(/\|\|\|ITALIC_END\|\|\|/g, '</em>');
            text = text.replace(/\|\|\|UNDERLINE_START\|\|\|/g, '<u>');
            text = text.replace(/\|\|\|UNDERLINE_END\|\|\|/g, '</u>');
            
            var paragraphs = text.split('|||PARAGRAPH|||');
            var html = '';
            
            for (var i = 0; i < paragraphs.length; i++) {
                var para = paragraphs[i].trim();
                if (para && para.length > 3) {
                    para = para.replace(/\|\|\|LINEBREAK\|\|\|/g, '<br>');
                    html += '<p>' + para + '</p>';
                }
            }
            
            if (!html || paragraphs.length < 2) {
                text = text.replace(/\|\|\|PARAGRAPH\|\|\|/g, ' ').replace(/\|\|\|LINEBREAK\|\|\|/g, ' ');
                
                var sections = text.split(/\n\s*\n/);
                if (sections.length > 1) {
                    for (var j = 0; j < sections.length; j++) {
                        var section = sections[j].trim();
                        if (section) {
                            html += '<p>' + section + '</p>';
                        }
                    }
                } else {
                    var sentences = text.split(/\.\s+(?=[A-ZĄĆĘŁŃÓŚŹŻ])/);
                    var currentPara = '';
                    
                    for (var k = 0; k < sentences.length; k++) {
                        var sentence = sentences[k].trim();
                        if (sentence) {
                            currentPara += sentence + (k < sentences.length - 1 ? '. ' : '');
                            
                            if (currentPara.length > 300) {
                                html += '<p>' + currentPara + '</p>';
                                currentPara = '';
                            }
                        }
                    }
                    
                    if (currentPara.trim()) {
                        html += '<p>' + currentPara + '</p>';
                    }
                }
            }
            
            if (!html) {
                html = '<p>' + text + '</p>';
            }
            
            return html;
        }
        
        function toggleFocusMode() {
            if (isFocusMode) {
                exitFocusMode();
            } else {
                enterFocusMode();
            }
        }
        
        function enterFocusMode() {
            isFocusMode = true;
            
            var focusEditor = document.getElementById('focusEditor');
            var mainText = editor.innerText || editor.textContent || '';
            focusEditor.value = mainText;
            
            lastCursorPosition = 0;
            
            var family = fontFamily === 'Times New Roman' ? 'Times New Roman, serif' : 'Libre Baskerville, serif';
            focusEditor.style.fontFamily = family;
            
            document.body.classList.add('focus-active');
            
            var focusMode = document.getElementById('focusMode');
            focusMode.classList.add('active');
            
            var focusReadBtn = document.getElementById('focusReadBtn');
            var focusHideBtn = document.getElementById('focusHideBtn');
            var focusControls = document.getElementById('focusControls');
            var focusCounter = document.getElementById('focusWordCount');
            var focusCounterHideBtn = document.getElementById('focusCounterHideBtn');
            var focusTimer = document.getElementById('focusTimer');
            
            focusControls.classList.remove('hidden-controls');
            focusControlsHidden = false;
            
            focusCounter.classList.remove('hidden-counter');
            focusCounterHidden = false;
            
            if (timerRunning) {
                focusTimer.classList.remove('hidden-timer');
                focusTimerHidden = false;
            }
            
            updateWordCount();
            
            focusReadBtn.onclick = function() {
                if (isReading) {
                    stopFocusReading();
                } else {
                    focusEditor.focus();
                    
                    setTimeout(function() {
                        lastCursorPosition = focusEditor.selectionStart || 0;
                        startFocusReading();
                    }, 10);
                }
            };
            
            focusHideBtn.onclick = function() {
                focusControls.classList.add('hidden-controls');
                focusControlsHidden = true;
            };
            
            focusCounterHideBtn.onclick = function() {
                focusCounter.classList.add('hidden-counter');
                focusCounterHidden = true;
            };
            
            setTimeout(function() {
                var elem = document.documentElement;
                
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(function(err) {
                        console.log('Fullscreen error:', err);
                    });
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                }
                
                setTimeout(function() {
                    focusEditor.focus();
                    focusEditor.setSelectionRange(0, 0);
                    focusEditor.scrollTop = 0;
                }, 100);
                
            }, 50);
            
            focusEditor.oninput = null;
            focusEditor.oninput = function() {
                var newContent = focusEditor.value;
                if (newContent.trim()) {
                    var htmlContent = '<p>' + newContent.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
                    editor.innerHTML = htmlContent;
                    saveState();
                    updateWordCount();
                } else {
                    editor.innerHTML = '<p>Zacznij pisać swój dokument...</p>';
                    updateWordCount();
                }
            };
            
            focusEditor.addEventListener('mouseup', function() {
                lastCursorPosition = focusEditor.selectionStart;
            });
            
            focusEditor.addEventListener('keyup', function() {
                lastCursorPosition = focusEditor.selectionStart;
            });
            
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        }
        
        function startFocusReading() {
            if (!speechSynthesis) {
                return;
            }
            
            var focusEditor = document.getElementById('focusEditor');
            
            var cursorPos = lastCursorPosition || 0;
            var text = focusEditor.value.substring(cursorPos);
            
            if (!text.trim()) {
                return;
            }
            
            var utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pl-PL';
            utterance.rate = speechRate;
            utterance.pitch = 1;
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            var focusReadBtn = document.getElementById('focusReadBtn');
            
            utterance.onstart = function() {
                isReading = true;
                focusReadBtn.classList.add('active');
                focusReadBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
            };
            
            utterance.onend = function() {
                stopFocusReading();
            };
            
            utterance.onerror = function(e) {
                if (e.error === 'canceled' || e.error === 'interrupted') {
                    return;
                }
                stopFocusReading();
            };
            
            speechSynthesis.speak(utterance);
        }
        
        function stopFocusReading() {
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel();
            }
            isReading = false;
            var focusReadBtn = document.getElementById('focusReadBtn');
            if (focusReadBtn) {
                focusReadBtn.classList.remove('active');
                focusReadBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
            }
        }
        
        function handleFullscreenChange() {
            var isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                document.mozFullScreenElement || document.msFullscreenElement);
            
            if (!isFullscreen && isFocusMode) {
                exitFocusMode();
            }
        }
        
        function exitFocusMode() {
            if (!isFocusMode) return;
            
            if (isReading) {
                stopFocusReading();
            }
            
            isFocusMode = false;
            
            var focusControls = document.getElementById('focusControls');
            if (!focusControlsHidden) {
                focusControls.classList.remove('hidden-controls');
            }
            focusControlsHidden = false;
            
            var focusCounter = document.getElementById('focusWordCount');
            if (!focusCounterHidden) {
                focusCounter.classList.remove('hidden-counter');
            }
            focusCounterHidden = false;
            
            var focusTimer = document.getElementById('focusTimer');
            if (!focusTimerHidden) {
                focusTimer.classList.remove('hidden-timer');
            }
            focusTimerHidden = false;
            
            document.body.classList.remove('focus-active');
            
            document.removeEventListener('fullscreenchange', handleFullscreenChange);
            document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.removeEventListener('mozfullscreenchange', handleFullscreenChange);
            document.removeEventListener('MSFullscreenChange', handleFullscreenChange);
            
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(function(err) {
                    console.log('Exit fullscreen error:', err);
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            
            document.getElementById('focusMode').classList.remove('active');
            
            var focusEditor = document.getElementById('focusEditor');
            if (focusEditor.value.trim()) {
                var htmlContent = '<p>' + focusEditor.value.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
                editor.innerHTML = htmlContent;
                saveState();
                updateWordCount();
            }
            
            setTimeout(function() {
                editor.focus();
            }, 200);
        }
        
        document.addEventListener('DOMContentLoaded', init);

        window.addEventListener('load', function() {
            var textToRead = localStorage.getItem('textToRead');
            var shouldAutoRead = localStorage.getItem('autoReadText');
            
            if (textToRead && shouldAutoRead === 'true') {
                var paragraphs = textToRead.split('\n\n');
                var htmlContent = '';
                for (var i = 0; i < paragraphs.length; i++) {
                    var para = paragraphs[i].trim();
                    if (para) {
                        htmlContent += '<p>' + para + '</p>';
                    }
                }
                editor.innerHTML = htmlContent;
                
                localStorage.removeItem('textToRead');
                localStorage.removeItem('autoReadText');
                
                undoHistory = [];
                historyIndex = -1;
                saveState();
                updateWordCount();
                
                setTimeout(function() {
                    if (!speechSynthesis) {
                        return;
                    }
                    
                    var fullText = editor.innerText || editor.textContent || '';
                    
                    if (!fullText.trim()) {
                        return;
                    }
                    
                    var utterance = new SpeechSynthesisUtterance(fullText);
                    utterance.lang = 'pl-PL';
                    utterance.rate = speechRate;
                    utterance.pitch = 1;
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    var btn = document.getElementById('readBtn');
                    
                    utterance.onstart = function() {
                        isReading = true;
                        btn.classList.add('active');
                        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
                    };
                    
                    utterance.onend = function() {
                        stopReading();
                    };
                    
                    utterance.onerror = function(e) {
                        if (e.error === 'canceled' || e.error === 'interrupted') {
                            return;
                        }
                        console.error('Błąd czytania:', e.error);
                        stopReading();
                    };
                    
                    speechSynthesis.speak(utterance);
                }, 800);
            }
        });
    </script>
</body>
</html>
