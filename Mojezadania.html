<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zadania i kalendarz</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Zadania">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlphZGFuaWEgaSBrYWxlbmRhcnoiLAogICJzaG9ydF9uYW1lIjogIlphZGFuaWEiLAogICJzdGFydF91cmwiOiAiLi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyUyMzAwMCcvJTNFJTNDdGV4dCB4PSc1MCcgeT0nNTAnIGZvbnQtc2l6ZT0nNTAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGR5PScuM2VtJyBmaWxsPSclMjNmZmYnJTNFJUYwJTlGJTkzJTlEJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìù</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Libre Baskerville', serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            border: 2px solid #000;
            padding: 24px;
            margin-bottom: 16px;
        }

        h1 {
            font-size: 24px;
            color: #000;
            margin-bottom: 16px;
        }

        /* Main navigation tabs */
        .main-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .main-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #000;
            font-family: 'Libre Baskerville', serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            background: #fff;
            color: #000;
        }

        .main-tab.active {
            background: #000;
            color: #fff;
        }

        /* Tasks section */
        .stats-today {
            background: #fff;
            border: 2px solid #000;
            padding: 16px;
            margin-bottom: 16px;
        }

        .stats-label {
            font-size: 14px;
            color: #000;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .stats-number {
            font-size: 32px;
            color: #000;
            font-weight: bold;
        }

        .stats-subtitle {
            font-size: 12px;
            color: #4b5563;
            margin-top: 4px;
        }

        .history-btn {
            background: #fff;
            border: 2px solid #000;
            padding: 10px 16px;
            margin-top: 12px;
            width: 100%;
            font-family: 'Libre Baskerville', serif;
            cursor: pointer;
            font-size: 14px;
        }

        .history-btn:hover {
            background: #000;
            color: #fff;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: 2px solid #000;
            font-family: 'Libre Baskerville', serif;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            background: #fff;
            color: #000;
        }

        .tab.active {
            background: #000;
            color: #fff;
        }

        .progress-card {
            background: white;
            border: 2px solid #000;
            padding: 16px;
            margin-bottom: 16px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #000;
            margin-bottom: 8px;
        }

        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: #fff;
            border: 2px solid #000;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #000;
            transition: width 0.5s ease;
        }

        .add-task-card {
            background: white;
            border: 2px solid #000;
            padding: 16px;
            margin-bottom: 16px;
        }

        .add-task-form {
            display: flex;
            gap: 8px;
        }

        .task-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #000;
            font-family: 'Libre Baskerville', serif;
            font-size: 14px;
        }

        .task-input:focus {
            outline: none;
            border-color: #000;
        }

        .add-btn {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 20px;
            font-family: 'Libre Baskerville', serif;
            cursor: pointer;
            font-weight: bold;
        }

        .add-btn:hover {
            background: #fff;
            color: #000;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            background: white;
            border: 2px solid #000;
            padding: 16px;
            transition: opacity 0.3s;
        }

        .task-item.completed {
            opacity: 0.5;
        }

        .task-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #000;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .checkbox.checked {
            background: #000;
            border-color: #000;
        }

        .checkbox.checked::after {
            content: '‚úì';
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        .task-text {
            flex: 1;
            font-size: 14px;
            color: #000;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #666;
        }

        .delete-btn {
            color: #000;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #666;
        }

        .empty-emoji {
            font-size: 48px;
            margin-bottom: 8px;
        }

        /* Calendar section */
        .month-nav {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .month-nav button {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 8px 16px;
            font-family: 'Libre Baskerville', serif;
            cursor: pointer;
            font-size: 14px;
        }

        .month-nav button:hover {
            background: #fff;
            color: #000;
        }

        .month-nav span {
            font-size: 18px;
            font-weight: bold;
            min-width: 200px;
            text-align: center;
        }

        .calendar {
            background: white;
            border: 2px solid #000;
            padding: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
        }

        .calendar-header {
            text-align: center;
            padding: 12px;
            font-weight: bold;
            border: 1px solid #000;
            background: #000;
            color: #fff;
            font-size: 12px;
        }

        .calendar-day {
            border: 1px solid #000;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            position: relative;
            background: #fff;
        }

        .calendar-day:hover {
            background: #f5f5f5;
        }

        .calendar-day.other-month {
            background: #f9f9f9;
            color: #999;
        }

        .calendar-day.today {
            background: #f0f0f0;
            font-weight: bold;
        }

        .day-number {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .day-tasks-count {
            font-size: 10px;
            color: #666;
        }

        /* Day view */
        .day-view {
            background: white;
            border: 2px solid #000;
            padding: 24px;
        }

        .day-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #000;
        }

        .day-view-title {
            font-size: 20px;
            font-weight: bold;
        }

        .back-btn {
            background: #fff;
            border: 2px solid #000;
            padding: 8px 16px;
            font-family: 'Libre Baskerville', serif;
            cursor: pointer;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #000;
            color: #fff;
        }

        /* History view */
        .history-view {
            background: white;
            border: 2px solid #000;
            padding: 20px;
            margin-bottom: 16px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history-title {
            font-size: 20px;
            font-weight: bold;
        }

        .close-history-btn {
            background: #fff;
            border: 2px solid #000;
            padding: 8px 16px;
            font-family: 'Libre Baskerville', serif;
            cursor: pointer;
            font-size: 14px;
        }

        .close-history-btn:hover {
            background: #000;
            color: #fff;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-day {
            border: 2px solid #000;
            padding: 16px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-day:hover {
            background: #f5f5f5;
        }

        .history-day.today {
            border-color: #000;
            background: #f5f5f5;
        }

        .history-date {
            font-size: 14px;
            font-weight: bold;
            color: #000;
            margin-bottom: 8px;
        }

        .history-stats {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #000;
        }

        .history-stat {
            display: flex;
            flex-direction: column;
        }

        .history-stat-label {
            font-size: 11px;
            margin-bottom: 2px;
        }

        .history-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #000;
        }

        /* Streaks/Passes section */
        .streak-item {
            background: white;
            border: 2px solid #000;
            padding: 20px;
            margin-bottom: 12px;
        }

        .streak-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .streak-name {
            font-size: 16px;
            font-weight: bold;
            color: #000;
            flex: 1;
        }

        .streak-days {
            font-size: 36px;
            font-weight: bold;
            color: #000;
            text-align: center;
            margin: 16px 0;
        }

        .streak-days-label {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 16px;
        }

        .streak-actions {
            display: flex;
            gap: 8px;
        }

        .streak-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #000;
            font-family: 'Libre Baskerville', serif;
            cursor: pointer;
            font-size: 14px;
            background: #fff;
            color: #000;
            font-weight: bold;
        }

        .streak-btn:hover {
            background: #000;
            color: #fff;
        }

        .streak-btn.primary {
            background: #000;
            color: #fff;
        }

        .streak-btn.primary:hover {
            background: #fff;
            color: #000;
        }

        .streak-date {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin-top: 8px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        // Funkcje pomocnicze
        function getTodayString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        // Stan aplikacji
        let state = {
            activeMainTab: 'lista', // 'lista', 'kalendarz', 'passy'
            
            // Lista zada≈Ñ
            dailyTasks: [],
            oneTimeTasks: [],
            lastResetDate: getTodayString(),
            dailyStats: {},
            activeTaskTab: 'daily',
            showHistory: false,
            editingDay: null,
            
            // Kalendarz
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth(),
            selectedDate: null,
            calendarTasks: {},
            
            // Passy/Streaks
            streaks: []
        };

        const monthNames = [
            'Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec',
            'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'
        ];

        const dayNames = ['Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'So', 'Nd'];

        // Inicjalizacja z localStorage
        function loadState() {
            const saved = localStorage.getItem('unifiedAppState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                
                // Upewnij siƒô, ≈ºe streaks istnieje
                if (!state.streaks) {
                    state.streaks = [];
                }
                
                checkDayReset();
            } else {
                // Domy≈õlne zadania
                state.dailyTasks = [
                    { id: Date.now(), text: 'ƒÜwiczenia', completed: false },
                    { id: Date.now() + 1, text: 'Czytanie', completed: false },
                    { id: Date.now() + 2, text: 'Medytacja', completed: false }
                ];
                state.oneTimeTasks = [
                    { id: Date.now() + 3, text: 'Kupiƒá mleko', completed: false }
                ];
                state.streaks = [];
            }
        }

        function saveState() {
            localStorage.setItem('unifiedAppState', JSON.stringify(state));
        }

        // === FUNKCJE DLA LISTY ZADA≈É ===

        function checkDayReset() {
            const today = getTodayString();
            if (today !== state.lastResetDate) {
                const yesterday = state.lastResetDate;
                const completedYesterday = state.dailyTasks.filter(t => t.completed).length;
                const totalYesterday = state.dailyTasks.length;
                
                if (!state.dailyStats) state.dailyStats = {};
                state.dailyStats[yesterday] = {
                    completed: completedYesterday,
                    total: totalYesterday,
                    tasks: JSON.parse(JSON.stringify(state.dailyTasks))
                };

                state.dailyTasks = state.dailyTasks.map(task => ({ ...task, completed: false }));
                state.lastResetDate = today;
                saveState();
            }
        }

        function getCurrentDayStats() {
            const today = getTodayString();
            const completed = state.dailyTasks.filter(t => t.completed).length;
            const total = state.dailyTasks.length;
            
            if (!state.dailyStats) state.dailyStats = {};
            state.dailyStats[today] = {
                completed: completed,
                total: total,
                tasks: JSON.parse(JSON.stringify(state.dailyTasks))
            };
            
            return { completed, total };
        }

        function toggleTask(type, id) {
            const tasks = type === 'daily' ? state.dailyTasks : state.oneTimeTasks;
            const task = tasks.find(t => t.id === id);
            task.completed = !task.completed;
            saveState();
            render();
        }

        function togglePastDayTask(date, taskId) {
            if (!state.dailyStats[date] || !state.dailyStats[date].tasks) return;
            
            const task = state.dailyStats[date].tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.completed = !task.completed;
            
            const today = getTodayString();
            if (date === today) {
                const currentTask = state.dailyTasks.find(t => t.id === taskId);
                if (currentTask) {
                    currentTask.completed = task.completed;
                }
            }
            
            const completed = state.dailyStats[date].tasks.filter(t => t.completed).length;
            state.dailyStats[date].completed = completed;
            
            saveState();
            render();
        }

        function addTaskToList(type, text) {
            if (!text.trim()) return;

            const newTask = {
                id: Date.now(),
                text: text,
                completed: false
            };

            if (type === 'daily') {
                state.dailyTasks.push(newTask);
            } else {
                state.oneTimeTasks.push(newTask);
            }

            saveState();
            render();
        }

        function deleteTaskFromList(type, id) {
            if (type === 'daily') {
                state.dailyTasks = state.dailyTasks.filter(t => t.id !== id);
            } else {
                state.oneTimeTasks = state.oneTimeTasks.filter(t => t.id !== id);
            }

            saveState();
            render();
        }

        function deleteHistoryDayInternal(date) {
            if (confirm(`Czy na pewno chcesz usunƒÖƒá ${formatDateDisplay(date)} z historii?`)) {
                delete state.dailyStats[date];
                saveState();
                render();
            }
        }

        // === FUNKCJE DLA KALENDARZA ===

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            const day = new Date(year, month, 1).getDay();
            return day === 0 ? 6 : day - 1;
        }

        function formatDate(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function parseDate(dateString) {
            if (dateString.includes('-')) {
                const [year, month, day] = dateString.split('-').map(Number);
                return { year, month: month - 1, day };
            } else {
                const date = new Date(dateString);
                return { 
                    year: date.getFullYear(), 
                    month: date.getMonth(), 
                    day: date.getDate() 
                };
            }
        }

        function formatDateDisplay(dateString) {
            try {
                const { year, month, day } = parseDate(dateString);
                
                const today = new Date();
                const dateObj = new Date(year, month, day);
                const todayObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const yesterdayObj = new Date(todayObj);
                yesterdayObj.setDate(yesterdayObj.getDate() - 1);
                
                if (dateObj.getTime() === todayObj.getTime()) {
                    return 'Dzisiaj';
                } else if (dateObj.getTime() === yesterdayObj.getTime()) {
                    return 'Wczoraj';
                }
                
                return `${day} ${monthNames[month]} ${year}`;
            } catch (e) {
                console.error('Error formatting date:', dateString, e);
                return dateString;
            }
        }

        function getCalendarTasksForDate(dateString) {
            return state.calendarTasks[dateString] || [];
        }

        function addCalendarTask(dateString, taskText) {
            if (!state.calendarTasks[dateString]) {
                state.calendarTasks[dateString] = [];
            }
            state.calendarTasks[dateString].push(taskText);
            saveState();
        }

        function deleteCalendarTask(dateString, taskIndex) {
            if (state.calendarTasks[dateString]) {
                state.calendarTasks[dateString].splice(taskIndex, 1);
                if (state.calendarTasks[dateString].length === 0) {
                    delete state.calendarTasks[dateString];
                }
                saveState();
            }
        }

        function prevMonth() {
            state.currentMonth--;
            if (state.currentMonth < 0) {
                state.currentMonth = 11;
                state.currentYear--;
            }
            render();
        }

        function nextMonth() {
            state.currentMonth++;
            if (state.currentMonth > 11) {
                state.currentMonth = 0;
                state.currentYear++;
            }
            render();
        }

        // === FUNKCJE DLA PASS√ìW/STREAKS ===

        function addStreak(name) {
            if (!name.trim()) return;

            const newStreak = {
                id: Date.now(),
                name: name.trim(),
                days: 0,
                startDate: getTodayString(),
                lastUpdated: getTodayString()
            };

            state.streaks.push(newStreak);
            saveState();
            render();
        }

        function incrementStreak(id) {
            const streak = state.streaks.find(s => s.id === id);
            if (streak) {
                streak.days++;
                streak.lastUpdated = getTodayString();
                saveState();
                render();
            }
        }

        function resetStreak(id) {
            if (confirm('Czy na pewno chcesz zresetowaƒá tƒô passƒô?')) {
                const streak = state.streaks.find(s => s.id === id);
                if (streak) {
                    streak.days = 0;
                    streak.startDate = getTodayString();
                    streak.lastUpdated = getTodayString();
                    saveState();
                    render();
                }
            }
        }

        function deleteStreak(id) {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô passƒô?')) {
                state.streaks = state.streaks.filter(s => s.id !== id);
                saveState();
                render();
            }
        }

        // === RENDERING ===

        function renderTasksList() {
            const activeTab = state.activeTaskTab;
            const currentTasks = activeTab === 'daily' ? state.dailyTasks : state.oneTimeTasks;
            const { completed, total } = getCurrentDayStats();
            const completedCount = currentTasks.filter(t => t.completed).length;
            const totalCount = currentTasks.length;
            const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

            if (state.editingDay) {
                return renderDayEdit(state.editingDay);
            }

            if (state.showHistory) {
                return renderHistory();
            }

            return `
                <div class="stats-today">
                    <div class="stats-label">Dzisiaj</div>
                    <div class="stats-number">${completed} / ${total}</div>
                    <div class="stats-subtitle">zada≈Ñ codziennych wykonanych</div>
                    <button class="history-btn" onclick="openHistory()">Zobacz historiƒô</button>
                </div>

                <div class="tabs">
                    <button class="tab ${activeTab === 'daily' ? 'active' : ''}" onclick="switchTaskTab('daily')">
                        Codzienne
                    </button>
                    <button class="tab ${activeTab === 'onetime' ? 'active' : ''}" onclick="switchTaskTab('onetime')">
                        Jednorazowe
                    </button>
                </div>

                <div class="progress-card">
                    <div class="progress-info">
                        <span>Postƒôp</span>
                        <span>${completedCount} / ${totalCount}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                </div>

                <div class="add-task-card">
                    <div class="add-task-form">
                        <input 
                            type="text" 
                            class="task-input" 
                            id="taskInput" 
                            placeholder="Nowe zadanie..."
                            onkeypress="if(event.key==='Enter') addTaskHandler()"
                        />
                        <button class="add-btn" onclick="addTaskHandler()">+</button>
                    </div>
                </div>

                <div class="task-list">
                    ${currentTasks.map(task => `
                        <div class="task-item ${task.completed ? 'completed' : ''}">
                            <div class="task-content">
                                <div class="checkbox ${task.completed ? 'checked' : ''}" 
                                     onclick="toggleTask('${activeTab}', ${task.id})">
                                </div>
                                <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                                <button class="delete-btn" onclick="deleteTaskFromList('${activeTab}', ${task.id})">√ó</button>
                            </div>
                        </div>
                    `).join('')}
                    ${currentTasks.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-emoji">üìù</div>
                            <div>Brak zada≈Ñ. Dodaj pierwsze!</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderHistory() {
            const sortedDates = Object.keys(state.dailyStats || {}).sort((a, b) => new Date(b) - new Date(a));
            const today = getTodayString();

            return `
                <div class="history-view">
                    <div class="history-header">
                        <div class="history-title">Historia</div>
                        <button class="close-history-btn" onclick="closeHistory()">Zamknij</button>
                    </div>
                    <div class="history-list">
                        ${sortedDates.map(date => {
                            const stats = state.dailyStats[date];
                            const isToday = date === today;
                            return `
                                <div class="history-day ${isToday ? 'today' : ''}">
                                    <div onclick="openDayEdit('${date}')" style="flex: 1; cursor: pointer;">
                                        <div class="history-date">${formatDateDisplay(date)}</div>
                                        <div class="history-stats">
                                            <div class="history-stat">
                                                <span class="history-stat-label">Wykonane zadania</span>
                                                <span class="history-stat-value">${stats.completed}/${stats.total}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="delete-btn" onclick="event.stopPropagation(); deleteHistoryDay('${date}')" style="margin-left: 12px;">√ó</button>
                                </div>
                            `;
                        }).join('')}
                        ${sortedDates.length === 0 ? '<div class="empty-state"><div class="empty-emoji">üìä</div><div>Brak historii</div></div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderDayEdit(date) {
            const stats = state.dailyStats[date];
            if (!stats || !stats.tasks) return '';

            return `
                <div class="history-view">
                    <div class="history-header">
                        <div class="history-title">${formatDateDisplay(date)}</div>
                        <button class="close-history-btn" onclick="closeDayEdit()">Wr√≥ƒá</button>
                    </div>
                    
                    <div class="stats-today" style="margin-bottom: 20px;">
                        <div class="stats-label">Wykonane zadania</div>
                        <div class="stats-number">${stats.completed} / ${stats.total}</div>
                    </div>

                    <div class="task-list">
                        ${stats.tasks.map(task => `
                            <div class="task-item ${task.completed ? 'completed' : ''}">
                                <div class="task-content">
                                    <div class="checkbox ${task.completed ? 'checked' : ''}" 
                                         onclick="togglePastDayTask('${date}', ${task.id})">
                                    </div>
                                    <div class="task-text ${task.completed ? 'completed' : ''}">${task.text}</div>
                                </div>
                            </div>
                        `).join('')}
                        ${stats.tasks.length === 0 ? `
                            <div class="empty-state">
                                <div class="empty-emoji">üìù</div>
                                <div>Brak zada≈Ñ w tym dniu</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderCalendar() {
            if (state.selectedDate) {
                return renderCalendarDayView();
            }

            const daysInMonth = getDaysInMonth(state.currentYear, state.currentMonth);
            const firstDay = getFirstDayOfMonth(state.currentYear, state.currentMonth);
            const today = new Date();
            const todayString = formatDate(today.getFullYear(), today.getMonth(), today.getDate());

            let calendarHTML = '<div class="calendar-grid">';

            dayNames.forEach(day => {
                calendarHTML += `<div class="calendar-header">${day}</div>`;
            });

            const prevMonthDays = getDaysInMonth(
                state.currentMonth === 0 ? state.currentYear - 1 : state.currentYear,
                state.currentMonth === 0 ? 11 : state.currentMonth - 1
            );

            for (let i = 0; i < firstDay; i++) {
                const day = prevMonthDays - firstDay + i + 1;
                const prevMonth = state.currentMonth === 0 ? 11 : state.currentMonth - 1;
                const prevYear = state.currentMonth === 0 ? state.currentYear - 1 : state.currentYear;
                const dateString = formatDate(prevYear, prevMonth, day);
                const tasks = getCalendarTasksForDate(dateString);
                
                calendarHTML += `
                    <div class="calendar-day other-month" onclick="selectCalendarDate('${dateString}')">
                        <div class="day-number">${day}</div>
                        ${tasks.length > 0 ? `<div class="day-tasks-count">${tasks.length} zada≈Ñ</div>` : ''}
                    </div>
                `;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = formatDate(state.currentYear, state.currentMonth, day);
                const tasks = getCalendarTasksForDate(dateString);
                const isToday = dateString === todayString;

                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="selectCalendarDate('${dateString}')">
                        <div class="day-number">${day}</div>
                        ${tasks.length > 0 ? `<div class="day-tasks-count">${tasks.length} zada≈Ñ</div>` : ''}
                    </div>
                `;
            }

            const totalCells = firstDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);

            for (let i = 1; i <= remainingCells; i++) {
                const nextMonth = state.currentMonth === 11 ? 0 : state.currentMonth + 1;
                const nextYear = state.currentMonth === 11 ? state.currentYear + 1 : state.currentYear;
                const dateString = formatDate(nextYear, nextMonth, i);
                const tasks = getCalendarTasksForDate(dateString);

                calendarHTML += `
                    <div class="calendar-day other-month" onclick="selectCalendarDate('${dateString}')">
                        <div class="day-number">${i}</div>
                        ${tasks.length > 0 ? `<div class="day-tasks-count">${tasks.length} zada≈Ñ</div>` : ''}
                    </div>
                `;
            }

            calendarHTML += '</div>';

            return `
                <div class="month-nav">
                    <button onclick="prevMonth()">‚Üê</button>
                    <span>${monthNames[state.currentMonth]} ${state.currentYear}</span>
                    <button onclick="nextMonth()">‚Üí</button>
                </div>
                <div class="calendar">
                    ${calendarHTML}
                </div>
            `;
        }

        function renderCalendarDayView() {
            const tasks = getCalendarTasksForDate(state.selectedDate);
            const dateDisplay = formatDateDisplay(state.selectedDate);

            return `
                <div class="day-view">
                    <div class="day-view-header">
                        <div class="day-view-title">${dateDisplay}</div>
                        <button class="back-btn" onclick="backToCalendar()">Wr√≥ƒá do kalendarza</button>
                    </div>

                    <div class="add-task-form">
                        <input 
                            type="text" 
                            class="task-input" 
                            id="calendarTaskInput" 
                            placeholder="Co masz do zrobienia..."
                            onkeypress="if(event.key==='Enter') addCalendarTaskHandler()"
                        />
                        <button class="add-btn" onclick="addCalendarTaskHandler()">+</button>
                    </div>

                    <div class="task-list">
                        ${tasks.length > 0 ? tasks.map((task, index) => `
                            <div class="task-item">
                                <div class="task-text">${task}</div>
                                <button class="delete-btn" onclick="deleteCalendarTaskHandler(${index})">√ó</button>
                            </div>
                        `).join('') : `
                            <div class="empty-state">
                                <div class="empty-emoji">üìù</div>
                                <div>Brak zada≈Ñ na ten dzie≈Ñ</div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderStreaks() {
            return `
                <div class="add-task-card">
                    <div class="add-task-form">
                        <input 
                            type="text" 
                            class="task-input" 
                            id="streakInput" 
                            placeholder="Nowa seria..."
                            onkeypress="if(event.key==='Enter') addStreakHandler()"
                        />
                        <button class="add-btn" onclick="addStreakHandler()">+</button>
                    </div>
                </div>

                <div class="task-list">
                    ${state.streaks.map(streak => `
                        <div class="streak-item">
                            <div class="streak-header">
                                <div class="streak-name">${streak.name}</div>
                                <button class="delete-btn" onclick="deleteStreak(${streak.id})">√ó</button>
                            </div>
                            
                            <div class="streak-days">${streak.days}</div>
                            <div class="streak-days-label">${streak.days === 1 ? 'dzie≈Ñ' : streak.days < 5 || streak.days > 21 && streak.days % 10 >= 2 && streak.days % 10 <= 4 ? 'dni' : 'dni'}</div>
                            
                            <div class="streak-actions">
                                <button class="streak-btn primary" onclick="incrementStreak(${streak.id})">+1 dzie≈Ñ</button>
                                <button class="streak-btn" onclick="resetStreak(${streak.id})">Reset</button>
                            </div>
                            
                            <div class="streak-date">Start: ${formatDateDisplay(streak.startDate)}</div>
                        </div>
                    `).join('')}
                    
                    ${state.streaks.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-emoji">üî•</div>
                            <div>Brak serii. Dodaj pierwszƒÖ!</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            let content = '';
            
            if (state.activeMainTab === 'lista') {
                content = renderTasksList();
            } else if (state.activeMainTab === 'kalendarz') {
                content = renderCalendar();
            } else if (state.activeMainTab === 'passy') {
                content = renderStreaks();
            }
            
            app.innerHTML = `
                <div class="header">
                    <h1>Moje zadania</h1>
                    <div class="main-tabs">
                        <button class="main-tab ${state.activeMainTab === 'lista' ? 'active' : ''}" 
                                onclick="switchMainTab('lista')">
                            Lista zada≈Ñ
                        </button>
                        <button class="main-tab ${state.activeMainTab === 'kalendarz' ? 'active' : ''}" 
                                onclick="switchMainTab('kalendarz')">
                            Kalendarz
                        </button>
                        <button class="main-tab ${state.activeMainTab === 'passy' ? 'active' : ''}" 
                                onclick="switchMainTab('passy')">
                            Serie
                        </button>
                    </div>
                </div>

                ${content}
            `;
        }

        // === GLOBAL FUNCTIONS ===

        window.switchMainTab = function(tab) {
            state.activeMainTab = tab;
            state.showHistory = false;
            state.editingDay = null;
            state.selectedDate = null;
            render();
        };

        window.switchTaskTab = function(tab) {
            state.activeTaskTab = tab;
            render();
        };

        window.addTaskHandler = function() {
            const input = document.getElementById('taskInput');
            const type = state.activeTaskTab;
            addTaskToList(type, input.value);
            input.value = '';
        };

        window.openHistory = function() {
            state.showHistory = true;
            render();
        };

        window.closeHistory = function() {
            state.showHistory = false;
            render();
        };

        window.openDayEdit = function(date) {
            state.editingDay = date;
            state.showHistory = false;
            render();
        };

        window.closeDayEdit = function() {
            state.editingDay = null;
            state.showHistory = true;
            render();
        };

        window.selectCalendarDate = function(date) {
            state.selectedDate = date;
            render();
        };

        window.backToCalendar = function() {
            state.selectedDate = null;
            render();
        };

        window.addCalendarTaskHandler = function() {
            const input = document.getElementById('calendarTaskInput');
            const text = input.value.trim();
            
            if (text) {
                addCalendarTask(state.selectedDate, text);
                input.value = '';
                render();
            }
        };

        window.deleteCalendarTaskHandler = function(index) {
            deleteCalendarTask(state.selectedDate, index);
            render();
        };

        window.deleteHistoryDay = function(date) {
            deleteHistoryDayInternal(date);
        };

        window.addStreakHandler = function() {
            const input = document.getElementById('streakInput');
            const text = input.value.trim();
            
            if (text) {
                addStreak(text);
                input.value = '';
            }
        };

        // Inicjalizacja
        loadState();
        render();

        setInterval(() => {
            checkDayReset();
            saveState();
        }, 5000);
    </script>
</body>
</html>
