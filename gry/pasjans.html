<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasjans - Windows Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', sans-serif;
            background: #008000;
            background-image: 
                radial-gradient(circle at 20% 50%, transparent 20%, rgba(255,255,255,0.05) 21%, rgba(255,255,255,0.05) 34%, transparent 35%, transparent),
                linear-gradient(0deg, rgba(0,0,0,0.1) 50%, transparent 50%);
            min-height: 100vh;
            padding: 8px;
            user-select: none;
            cursor: default;
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .game-window {
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            margin: 0 auto;
            max-width: 800px;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .title-bar {
            background: linear-gradient(90deg, #0a246a 0%, #a6caf0 100%);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            cursor: pointer;
            padding: 2px 6px;
            border: 1px solid transparent;
            user-select: none;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .close-btn:active {
            background: rgba(255,255,255,0.4);
        }

        .menu-bar {
            background: #c0c0c0;
            border-bottom: 1px solid #808080;
            padding: 4px;
            font-size: 11px;
        }

        .menu-item {
            display: inline-block;
            padding: 4px 8px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .menu-item:hover {
            border: 1px outset #c0c0c0;
        }

        .status-bar {
            background: #c0c0c0;
            border-top: 1px inset #c0c0c0;
            padding: 4px 8px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }

        .game-area {
            background: #008000;
            padding: 20px;
            min-height: 400px;
        }

        .top-row {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            height: 96px;
        }

        .card-space {
            width: 71px;
            height: 96px;
            border: 1px solid #004000;
            background: rgba(0, 64, 0, 0.3);
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stock-space {
            background: rgba(0, 64, 0, 0.5);
            cursor: pointer;
        }

        .foundation-space::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            opacity: 0.4;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .foundation-space[data-suit="hearts"]::after {
            content: '♥';
            color: #ff0000;
        }

        .foundation-space[data-suit="diamonds"]::after {
            content: '♦';
            color: #ff0000;
        }

        .foundation-space[data-suit="clubs"]::after {
            content: '♣';
            color: #000000;
        }

        .foundation-space[data-suit="spades"]::after {
            content: '♠';
            color: #000000;
        }

        .tableau-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
        }

        .tableau-column {
            width: 100%;
            min-height: 300px;
            position: relative;
        }

        .card {
            width: 100%;
            max-width: 71px;
            height: 96px;
            position: absolute;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            border-radius: 4px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            transition: none;
        }

        .card.face-up {
            background: white;
            border: 1px solid #000000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
        }

        .card.face-down {
            border: 1px solid #000040;
        }

        .card.face-down.back-blue {
            background: linear-gradient(135deg, #000080 0%, #4169e1 50%, #000080 100%);
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px),
                repeating-linear-gradient(-45deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px);
        }

        .card.face-down.back-red {
            background: linear-gradient(135deg, #8b0000 0%, #dc143c 50%, #8b0000 100%);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.2) 2px, transparent 3px),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.2) 2px, transparent 3px),
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.2) 2px, transparent 3px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.2) 2px, transparent 3px);
            background-size: 20px 20px;
        }

        .card.face-down.back-green {
            background: linear-gradient(135deg, #006400 0%, #228b22 50%, #006400 100%);
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 4px, rgba(255,255,255,0.15) 4px, rgba(255,255,255,0.15) 8px),
                repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,0.15) 4px, rgba(255,255,255,0.15) 8px);
        }

        .card.face-down.back-castle {
            background: linear-gradient(135deg, #2f4f4f 0%, #708090 50%, #2f4f4f 100%);
            background-image: 
                repeating-linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 6px, transparent 6px, transparent 12px),
                repeating-linear-gradient(-45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 6px, transparent 6px, transparent 12px);
        }

        .card.face-down.back-beach {
            background: linear-gradient(135deg, #20b2aa 0%, #48d1cc 50%, #20b2aa 100%);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.3) 1px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.3) 1px, transparent 2px),
                linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
            background-size: 16px 16px, 16px 16px, 32px 32px;
        }

        .card.face-down.back-fishes {
            background: linear-gradient(135deg, #191970 0%, #4169e1 50%, #191970 100%);
            background-image: 
                radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.2) 3px, transparent 4px),
                radial-gradient(ellipse at 70% 70%, rgba(255,255,255,0.2) 3px, transparent 4px),
                linear-gradient(30deg, transparent 45%, rgba(255,255,255,0.1) 50%, transparent 55%);
            background-size: 24px 24px, 24px 24px, 12px 12px;
        }

        .card.face-down.back-hand {
            background: linear-gradient(135deg, #8b4513 0%, #d2691e 50%, #8b4513 100%);
            background-image: 
                repeating-linear-gradient(60deg, transparent, transparent 3px, rgba(255,255,255,0.15) 3px, rgba(255,255,255,0.15) 6px),
                repeating-linear-gradient(-60deg, transparent, transparent 3px, rgba(255,255,255,0.15) 3px, rgba(255,255,255,0.15) 6px);
        }

        .card.face-down.back-shell {
            background: linear-gradient(135deg, #8b008b 0%, #9370db 50%, #8b008b 100%);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 6px, transparent 8px),
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px);
            background-size: 20px 20px, 8px 8px;
        }

        .card.face-down.back-robot {
            background: linear-gradient(135deg, #556b2f 0%, #9acd32 50%, #556b2f 100%);
            background-image: 
                linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.2) 75%),
                linear-gradient(-45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.2) 75%);
            background-size: 12px 12px;
        }

        .card.dragging {
            z-index: 1000;
            box-shadow: 4px 8px 16px rgba(0,0,0,0.6);
            transform: rotate(3deg) scale(1.05);
            border: 2px solid #ffffff;
        }

        .card:hover {
            z-index: 100;
        }

        .card-top, .card-bottom {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 12px;
            line-height: 1;
        }

        .card-bottom {
            align-self: flex-end;
            transform: rotate(180deg);
        }

        .suit {
            font-size: 14px;
            line-height: 1;
        }

        .red {
            color: #ff0000;
        }

        .black {
            color: #000000;
        }



        .score-display {
            background: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px 6px;
            font-size: 11px;
            min-width: 60px;
            text-align: center;
        }

        .card-back-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 20px;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            z-index: 10000;
            font-size: 11px;
            text-align: center;
            min-width: 360px;
            max-width: 90vw;
        }

        .win-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 20px;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
            z-index: 10000;
            font-size: 11px;
            text-align: center;
        }

        .card-back-title, .win-title {
            background: linear-gradient(90deg, #0a246a 0%, #a6caf0 100%);
            color: white;
            padding: 4px 8px;
            margin: -20px -20px 15px -20px;
            font-weight: bold;
        }

        .card-back-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .card-back-preview {
            width: 70px;
            height: 90px;
            border: 2px solid #808080;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-back-preview:hover {
            border-color: #0078d4;
            transform: scale(1.05);
        }

        .card-back-preview.selected {
            border: 3px solid #0078d4;
            box-shadow: 0 0 8px rgba(0, 120, 212, 0.5);
            transform: scale(1.1);
        }

        .preview-card {
            width: 90%;
            height: 90%;
            border-radius: 2px;
            border: 1px solid #000040;
            position: relative;
        }

        .preview-card.face-down.back-blue {
            background: linear-gradient(135deg, #000080 0%, #4169e1 50%, #000080 100%);
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px),
                repeating-linear-gradient(-45deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px);
        }

        .preview-card.face-down.back-red {
            background: linear-gradient(135deg, #8b0000 0%, #dc143c 50%, #8b0000 100%);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.2) 2px, transparent 3px),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.2) 2px, transparent 3px),
                radial-gradient(circle at 20% 80%, rgba(255,255,255,0.2) 2px, transparent 3px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.2) 2px, transparent 3px);
            background-size: 20px 20px;
        }

        .preview-card.face-down.back-green {
            background: linear-gradient(135deg, #006400 0%, #228b22 50%, #006400 100%);
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 4px, rgba(255,255,255,0.15) 4px, rgba(255,255,255,0.15) 8px),
                repeating-linear-gradient(90deg, transparent, transparent 4px, rgba(255,255,255,0.15) 4px, rgba(255,255,255,0.15) 8px);
        }

        .preview-card.face-down.back-castle {
            background: linear-gradient(135deg, #2f4f4f 0%, #708090 50%, #2f4f4f 100%);
            background-image: 
                repeating-linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 6px, transparent 6px, transparent 12px),
                repeating-linear-gradient(-45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.1) 6px, transparent 6px, transparent 12px);
        }

        .preview-card.face-down.back-beach {
            background: linear-gradient(135deg, #20b2aa 0%, #48d1cc 50%, #20b2aa 100%);
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.3) 1px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.3) 1px, transparent 2px),
                linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
            background-size: 16px 16px, 16px 16px, 32px 32px;
        }

        .preview-card.face-down.back-fishes {
            background: linear-gradient(135deg, #191970 0%, #4169e1 50%, #191970 100%);
            background-image: 
                radial-gradient(ellipse at 30% 30%, rgba(255,255,255,0.2) 3px, transparent 4px),
                radial-gradient(ellipse at 70% 70%, rgba(255,255,255,0.2) 3px, transparent 4px),
                linear-gradient(30deg, transparent 45%, rgba(255,255,255,0.1) 50%, transparent 55%);
            background-size: 24px 24px, 24px 24px, 12px 12px;
        }

        .preview-card.face-down.back-hand {
            background: linear-gradient(135deg, #8b4513 0%, #d2691e 50%, #8b4513 100%);
            background-image: 
                repeating-linear-gradient(60deg, transparent, transparent 3px, rgba(255,255,255,0.15) 3px, rgba(255,255,255,0.15) 6px),
                repeating-linear-gradient(-60deg, transparent, transparent 3px, rgba(255,255,255,0.15) 3px, rgba(255,255,255,0.15) 6px);
        }

        .preview-card.face-down.back-shell {
            background: linear-gradient(135deg, #8b008b 0%, #9370db 50%, #8b008b 100%);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 6px, transparent 8px),
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 4px);
            background-size: 20px 20px, 8px 8px;
        }

        .preview-card.face-down.back-robot {
            background: linear-gradient(135deg, #556b2f 0%, #9acd32 50%, #556b2f 100%);
            background-image: 
                linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.2) 75%),
                linear-gradient(-45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.2) 75%);
            background-size: 12px 12px;
        }

        .dialog-button {
            background: #c0c0c0;
            border: 1px outset #c0c0c0;
            padding: 6px 16px;
            margin: 0 6px;
            cursor: pointer;
            font-size: 11px;
        }

        .dialog-button:hover {
            background: #e0e0e0;
        }

        .dialog-button:active {
            border: 1px inset #c0c0c0;
            background: #a0a0a0;
        }

        .stock-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ffff00;
            border: 1px solid #000000;
            color: #000000;
            padding: 1px 4px;
            font-size: 9px;
            font-weight: bold;
            border-radius: 2px;
            min-width: 16px;
            text-align: center;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .game-area {
                padding: 10px;
            }
            
            .top-row {
                gap: 8px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            
            .tableau-row {
                gap: 8px;
            }
            
            .card {
                max-width: 60px;
                height: 80px;
            }
            
            .card-space {
                width: 60px;
                height: 80px;
            }
            
            .card-top, .card-bottom {
                font-size: 10px;
            }
            
            .suit {
                font-size: 12px;
            }
            
            .card-back-options {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .card-back-preview {
                width: 60px;
                height: 75px;
            }
        }

        @media (max-width: 480px) {
            .top-row {
                justify-content: center;
            }
            
            .tableau-row {
                gap: 2px;
            }
            
            .card {
                max-width: 42px;
                height: 56px;
            }
            
            .card-space {
                width: 42px;
                height: 56px;
            }
            
            .card-top, .card-bottom {
                font-size: 7px;
                gap: 1px;
                padding: 2px;
            }
            
            .suit {
                font-size: 8px;
            }
            
            .card-back-dialog {
                min-width: 280px;
                padding: 15px;
            }
            
            .card-back-preview {
                width: 50px;
                height: 65px;
            }
        }

        @media (max-width: 360px) {
            .tableau-row {
                gap: 1px;
            }
            
            .card {
                max-width: 38px;
                height: 50px;
            }
            
            .card-space {
                width: 38px;
                height: 50px;
            }
            
            .card-top, .card-bottom {
                font-size: 6px;
                padding: 1px;
            }
            
            .suit {
                font-size: 7px;
            }
        }
    </style>
</head>
<body>
    <div class="game-window">
        <div class="title-bar">
            <span>Pasjans</span>
            <span class="close-btn" onclick="window.close()">×</span>
        </div>
        
        <div class="menu-bar">
            <span class="menu-item" onclick="newGame()">Nowa gra</span>
            <span class="menu-item" onclick="showCardBackOptions()">Odwrót karty</span>
            <span class="menu-item" onclick="showHelp()">Pomoc</span>
        </div>

        <div class="game-area">
            <div class="top-row">
                <div id="stock" class="card-space stock-space" onclick="dealCards()">
                    <div class="stock-count" id="stock-count">24</div>
                </div>
                <div id="waste" class="card-space"></div>
                <div class="card-space"></div>
                <div id="foundation-0" class="card-space foundation-space" data-suit="hearts"></div>
                <div id="foundation-1" class="card-space foundation-space" data-suit="diamonds"></div>
                <div id="foundation-2" class="card-space foundation-space" data-suit="clubs"></div>
                <div id="foundation-3" class="card-space foundation-space" data-suit="spades"></div>
            </div>

            <div class="tableau-row">
                <div id="tableau-0" class="tableau-column"></div>
                <div id="tableau-1" class="tableau-column"></div>
                <div id="tableau-2" class="tableau-column"></div>
                <div id="tableau-3" class="tableau-column"></div>
                <div id="tableau-4" class="tableau-column"></div>
                <div id="tableau-5" class="tableau-column"></div>
                <div id="tableau-6" class="tableau-column"></div>
            </div>
        </div>

        <div class="status-bar">
            <div>Wynik: <span class="score-display" id="score">0</span></div>
            <div>Czas: <span class="score-display" id="time">00:00</span></div>
        </div>
    </div>

    <script>
        class WindowsSolitaire {
            constructor() {
                this.suits = ['hearts', 'diamonds', 'clubs', 'spades'];
                this.ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                this.suitSymbols = {
                    hearts: '♥',
                    diamonds: '♦',
                    clubs: '♣',
                    spades: '♠'
                };
                
                this.deck = [];
                this.stock = [];
                this.waste = [];
                this.foundations = [[], [], [], []];
                this.tableau = [[], [], [], [], [], [], []];
                
                this.score = 0;
                this.startTime = Date.now();
                this.timer = null;
                
                this.draggedCards = [];
                this.draggedFrom = null;
                this.dragElement = null;
                
                this.cardBackStyle = 'back-blue';
                this.selectedCardBack = 'back-blue';
                
                this.init();
            }

            init() {
                this.createDeck();
                this.shuffle();
                this.deal();
                this.render();
                this.startTimer();
                this.setupEventListeners();
            }

            createDeck() {
                this.deck = [];
                for (let suit of this.suits) {
                    for (let rank of this.ranks) {
                        this.deck.push({
                            suit: suit,
                            rank: rank,
                            color: (suit === 'hearts' || suit === 'diamonds') ? 'red' : 'black',
                            faceUp: false,
                            id: `${suit}-${rank}`
                        });
                    }
                }
            }

            shuffle() {
                for (let i = this.deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
                }
            }

            deal() {
                this.stock = [...this.deck];
                this.waste = [];
                this.foundations = [[], [], [], []];
                this.tableau = [[], [], [], [], [], [], []];

                for (let col = 0; col < 7; col++) {
                    for (let row = 0; row <= col; row++) {
                        const card = this.stock.pop();
                        card.faceUp = (row === col);
                        this.tableau[col].push(card);
                    }
                }
            }

            startTimer() {
                this.timer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('time').textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            render() {
                this.renderStock();
                this.renderWaste();
                this.renderFoundations();
                this.renderTableau();
                this.updateScore();
            }

            renderStock() {
                const stockEl = document.getElementById('stock');
                const countEl = document.getElementById('stock-count');
                
                Array.from(stockEl.children).forEach(child => {
                    if (!child.classList.contains('stock-count')) {
                        child.remove();
                    }
                });
                
                if (this.stock.length > 0) {
                    const card = this.createCardElement(this.stock[this.stock.length - 1], false);
                    stockEl.appendChild(card);
                }
                countEl.textContent = this.stock.length;
            }

            renderWaste() {
                const wasteEl = document.getElementById('waste');
                wasteEl.innerHTML = '';
                
                if (this.waste.length > 0) {
                    const card = this.createCardElement(this.waste[this.waste.length - 1], true);
                    wasteEl.appendChild(card);
                }
            }

            renderFoundations() {
                for (let i = 0; i < 4; i++) {
                    const foundationEl = document.getElementById(`foundation-${i}`);
                    foundationEl.innerHTML = '';
                    
                    if (this.foundations[i].length > 0) {
                        const topCard = this.foundations[i][this.foundations[i].length - 1];
                        const card = this.createCardElement(topCard, true);
                        foundationEl.appendChild(card);
                    }
                }
            }

            renderTableau() {
                for (let col = 0; col < 7; col++) {
                    const columnEl = document.getElementById(`tableau-${col}`);
                    columnEl.innerHTML = '';
                    
                    this.tableau[col].forEach((card, index) => {
                        const cardEl = this.createCardElement(card, card.faceUp);
                        cardEl.style.top = `${index * 20}px`;
                        cardEl.style.zIndex = index + 1;
                        columnEl.appendChild(cardEl);
                    });
                }
            }

            createCardElement(card, faceUp) {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${faceUp ? 'face-up' : `face-down ${this.cardBackStyle}`} ${card.color}`;
                cardEl.dataset.suit = card.suit;
                cardEl.dataset.rank = card.rank;
                cardEl.dataset.id = card.id;
                
                if (faceUp) {
                    cardEl.innerHTML = `
                        <div class="card-top">
                            <span class="rank">${card.rank}</span>
                            <span class="suit">${this.suitSymbols[card.suit]}</span>
                        </div>
                        <div class="card-bottom">
                            <span class="rank">${card.rank}</span>
                            <span class="suit">${this.suitSymbols[card.suit]}</span>
                        </div>
                    `;
                }
                
                return cardEl;
            }

            setupEventListeners() {
                document.addEventListener('mousedown', this.handleMouseDown.bind(this));
                document.addEventListener('mousemove', this.handleMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleMouseUp.bind(this));
                
                document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
                
                document.addEventListener('dblclick', this.handleDoubleClick.bind(this));
                
                // Close button handler
                document.querySelector('.close-btn').addEventListener('click', () => {
                    if (window.close) {
                        window.close();
                    } else {
                        window.history.back();
                    }
                });
                
                // Prevent default touch behaviors on mobile
                document.addEventListener('touchmove', (e) => {
                    if (this.dragElement) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                document.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.card')) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }

            handleMouseDown(e) {
                const card = e.target.closest('.card');
                if (!card || !card.classList.contains('face-up')) return;
                
                this.startDrag(card, e.clientX, e.clientY);
                e.preventDefault();
            }

            handleTouchStart(e) {
                const touch = e.touches[0];
                const card = touch.target.closest('.card');
                if (!card || !card.classList.contains('face-up')) return;
                
                this.startDrag(card, touch.clientX, touch.clientY);
                e.preventDefault();
            }

            handleDoubleClick(e) {
                const card = e.target.closest('.card');
                if (!card || !card.classList.contains('face-up')) return;
                
                this.autoMoveToFoundation(card);
            }

            autoMoveToFoundation(cardEl) {
                const card = this.getCardFromElement(cardEl);
                
                for (let i = 0; i < 4; i++) {
                    const foundation = this.foundations[i];
                    
                    if (foundation.length === 0 && card.rank === 'A') {
                        this.draggedCards = [card];
                        this.draggedFrom = this.findCardLocation(cardEl);
                        this.executeMove(cardEl, document.getElementById(`foundation-${i}`));
                        return;
                    }
                    
                    if (foundation.length > 0) {
                        const topCard = foundation[foundation.length - 1];
                        const cardValue = this.getCardValue(card.rank);
                        const topValue = this.getCardValue(topCard.rank);
                        
                        if (card.suit === topCard.suit && cardValue === topValue + 1) {
                            this.draggedCards = [card];
                            this.draggedFrom = this.findCardLocation(cardEl);
                            this.executeMove(cardEl, document.getElementById(`foundation-${i}`));
                            return;
                        }
                    }
                }
            }

            startDrag(card, x, y) {
                this.draggedCards = this.getCardsToMove(card);
                this.draggedFrom = this.findCardLocation(card);
                
                this.dragElement = document.createElement('div');
                this.dragElement.style.position = 'fixed';
                this.dragElement.style.pointerEvents = 'none';
                this.dragElement.style.zIndex = '10000';
                this.dragElement.style.transition = 'none';
                
                this.draggedCards.forEach((dragCard, index) => {
                    const cardEl = this.createCardElement(dragCard, true); // Always show front
                    cardEl.style.position = 'absolute';
                    cardEl.style.top = `${index * 20}px`;
                    cardEl.style.left = '0px';
                    cardEl.classList.add('dragging');
                    this.dragElement.appendChild(cardEl);
                });
                
                document.body.appendChild(this.dragElement);
                
                const rect = card.getBoundingClientRect();
                this.dragOffset = {
                    x: x - rect.left - rect.width/2,
                    y: y - rect.top - rect.height/2
                };
                
                this.updateDragPosition(x, y);
                
                card.style.opacity = '0.3';
                card.style.transform = 'scale(0.95)';
            }

            getCardsToMove(cardEl) {
                const location = this.findCardLocation(cardEl);
                if (!location || location.type !== 'tableau') {
                    return [this.getCardFromElement(cardEl)];
                }
                
                const column = this.tableau[location.index];
                const startIndex = location.cardIndex;
                return column.slice(startIndex);
            }

            handleMouseMove(e) {
                if (this.dragElement) {
                    this.updateDragPosition(e.clientX, e.clientY);
                }
            }

            handleTouchMove(e) {
                if (this.dragElement) {
                    const touch = e.touches[0];
                    this.updateDragPosition(touch.clientX, touch.clientY);
                    e.preventDefault();
                }
            }

            updateDragPosition(x, y) {
                if (this.dragElement) {
                    this.dragElement.style.left = `${x + this.dragOffset.x}px`;
                    this.dragElement.style.top = `${y + this.dragOffset.y}px`;
                    this.dragElement.style.cursor = 'grabbing';
                }
            }

            handleMouseUp(e) {
                if (this.dragElement) {
                    this.endDrag(e.clientX, e.clientY);
                }
            }

            handleTouchEnd(e) {
                if (this.dragElement && e.changedTouches[0]) {
                    const touch = e.changedTouches[0];
                    this.endDrag(touch.clientX, touch.clientY);
                    e.preventDefault();
                }
            }

            endDrag(x, y) {
                const element = document.elementFromPoint(x, y);
                const dropZone = element?.closest('.card-space, .tableau-column');
                
                if (dropZone && this.isValidMove(dropZone)) {
                    this.executeMove(null, dropZone);
                }
                
                document.querySelectorAll('.card').forEach(card => {
                    card.style.opacity = '';
                    card.style.transform = '';
                });
                
                if (this.dragElement) {
                    document.body.removeChild(this.dragElement);
                    this.dragElement = null;
                }
                
                this.draggedCards = [];
                this.draggedFrom = null;
                this.render();
            }

            executeMove(cardEl, dropZone) {
                this.removeCardsFromSource();
                
                if (dropZone.classList.contains('foundation-space')) {
                    const foundationIndex = parseInt(dropZone.id.split('-')[1]);
                    this.foundations[foundationIndex].push(this.draggedCards[0]);
                    this.score += 10;
                } else if (dropZone.classList.contains('tableau-column')) {
                    const columnIndex = parseInt(dropZone.id.split('-')[1]);
                    this.draggedCards.forEach(card => {
                        this.tableau[columnIndex].push(card);
                    });
                    if (this.draggedFrom && this.draggedFrom.type === 'waste') {
                        this.score += 5;
                    }
                }
                
                this.checkForFlips();
                
                if (this.isGameWon()) {
                    this.showWinDialog();
                }
            }

            isValidMove(dropZone) {
                if (this.draggedCards.length === 0) return false;
                
                const card = this.draggedCards[0];
                
                if (dropZone.classList.contains('foundation-space')) {
                    return this.draggedCards.length === 1 && this.isValidFoundationMove(card, dropZone);
                } else if (dropZone.classList.contains('tableau-column')) {
                    return this.isValidTableauMove(card, dropZone);
                }
                
                return false;
            }

            isValidFoundationMove(card, foundationEl) {
                const foundationIndex = parseInt(foundationEl.id.split('-')[1]);
                const foundation = this.foundations[foundationIndex];
                
                if (foundation.length === 0) {
                    return card.rank === 'A';
                }
                
                const topCard = foundation[foundation.length - 1];
                const cardValue = this.getCardValue(card.rank);
                const topValue = this.getCardValue(topCard.rank);
                
                return card.suit === topCard.suit && cardValue === topValue + 1;
            }

            isValidTableauMove(card, columnEl) {
                const columnIndex = parseInt(columnEl.id.split('-')[1]);
                const column = this.tableau[columnIndex];
                
                if (column.length === 0) {
                    return card.rank === 'K';
                }
                
                const topCard = column[column.length - 1];
                if (!topCard.faceUp) return false;
                
                const cardValue = this.getCardValue(card.rank);
                const topValue = this.getCardValue(topCard.rank);
                
                return card.color !== topCard.color && cardValue === topValue - 1;
            }

            getCardValue(rank) {
                if (rank === 'A') return 1;
                if (rank === 'J') return 11;
                if (rank === 'Q') return 12;
                if (rank === 'K') return 13;
                return parseInt(rank);
            }

            findCardLocation(cardEl) {
                const id = cardEl.dataset.id;
                
                if (this.waste.length > 0 && this.waste[this.waste.length - 1].id === id) {
                    return { type: 'waste', index: 0, cardIndex: this.waste.length - 1 };
                }
                
                for (let i = 0; i < 4; i++) {
                    const foundation = this.foundations[i];
                    const cardIndex = foundation.findIndex(card => card.id === id);
                    if (cardIndex !== -1) {
                        return { type: 'foundation', index: i, cardIndex: cardIndex };
                    }
                }
                
                for (let col = 0; col < 7; col++) {
                    const cardIndex = this.tableau[col].findIndex(card => card.id === id);
                    if (cardIndex !== -1) {
                        return { type: 'tableau', index: col, cardIndex: cardIndex };
                    }
                }
                
                return null;
            }

            getCardFromElement(cardEl) {
                const id = cardEl.dataset.id;
                
                if (this.waste.length > 0 && this.waste[this.waste.length - 1].id === id) {
                    return this.waste[this.waste.length - 1];
                }
                
                for (let foundation of this.foundations) {
                    const card = foundation.find(c => c.id === id);
                    if (card) return card;
                }
                
                for (let column of this.tableau) {
                    const card = column.find(c => c.id === id);
                    if (card) return card;
                }
                
                return null;
            }

            removeCardsFromSource() {
                if (!this.draggedFrom) return;
                
                if (this.draggedFrom.type === 'waste') {
                    this.waste.pop();
                } else if (this.draggedFrom.type === 'foundation') {
                    this.foundations[this.draggedFrom.index].pop();
                } else if (this.draggedFrom.type === 'tableau') {
                    const column = this.tableau[this.draggedFrom.index];
                    column.splice(this.draggedFrom.cardIndex, this.draggedCards.length);
                }
            }

            checkForFlips() {
                for (let col = 0; col < 7; col++) {
                    const column = this.tableau[col];
                    if (column.length > 0) {
                        const topCard = column[column.length - 1];
                        if (!topCard.faceUp) {
                            topCard.faceUp = true;
                            this.score += 5;
                        }
                    }
                }
            }

            isGameWon() {
                return this.foundations.every(foundation => foundation.length === 13);
            }

            showWinDialog() {
                clearInterval(this.timer);
                const winEl = document.createElement('div');
                winEl.className = 'win-dialog';
                winEl.innerHTML = `
                    <div class="win-title">Pasjans</div>
                    <div style="margin: 15px 0;">
                        <div>🎉 Gratulacje! 🎉</div>
                        <div style="margin: 10px 0;">Ukończyłeś grę!</div>
                        <div>Twój wynik: ${this.score}</div>
                    </div>
                    <div>
                        <button class="dialog-button" onclick="newGame(); this.parentElement.parentElement.remove();">
                            Nowa gra
                        </button>
                        <button class="dialog-button" onclick="this.parentElement.parentElement.remove();">
                            Zamknij
                        </button>
                    </div>
                `;
                document.body.appendChild(winEl);
            }

            updateScore() {
                document.getElementById('score').textContent = this.score;
            }

            dealFromStock() {
                if (this.stock.length > 0) {
                    const card = this.stock.pop();
                    card.faceUp = true;
                    this.waste.push(card);
                } else if (this.waste.length > 0) {
                    while (this.waste.length > 0) {
                        const card = this.waste.pop();
                        card.faceUp = false;
                        this.stock.push(card);
                    }
                    this.score = Math.max(0, this.score - 100);
                }
                this.render();
            }

            applyCardBack() {
                this.cardBackStyle = this.selectedCardBack;
                this.render();
            }
        }

        let game;

        function newGame() {
            if (game && game.timer) {
                clearInterval(game.timer);
            }
            game = new WindowsSolitaire();
        }

        function dealCards() {
            if (game) {
                game.dealFromStock();
            }
        }

        function showCardBackOptions() {
            const dialog = document.createElement('div');
            dialog.className = 'card-back-dialog';
            dialog.innerHTML = `
                <div class="card-back-title">Wybierz wzór odwrotu karty</div>
                <div class="card-back-options">
                    <div class="card-back-preview ${game.cardBackStyle === 'back-blue' ? 'selected' : ''}" data-style="back-blue">
                        <div class="preview-card face-down back-blue"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-red' ? 'selected' : ''}" data-style="back-red">
                        <div class="preview-card face-down back-red"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-green' ? 'selected' : ''}" data-style="back-green">
                        <div class="preview-card face-down back-green"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-castle' ? 'selected' : ''}" data-style="back-castle">
                        <div class="preview-card face-down back-castle"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-beach' ? 'selected' : ''}" data-style="back-beach">
                        <div class="preview-card face-down back-beach"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-fishes' ? 'selected' : ''}" data-style="back-fishes">
                        <div class="preview-card face-down back-fishes"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-hand' ? 'selected' : ''}" data-style="back-hand">
                        <div class="preview-card face-down back-hand"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-shell' ? 'selected' : ''}" data-style="back-shell">
                        <div class="preview-card face-down back-shell"></div>
                    </div>
                    <div class="card-back-preview ${game.cardBackStyle === 'back-robot' ? 'selected' : ''}" data-style="back-robot">
                        <div class="preview-card face-down back-robot"></div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="dialog-button" onclick="applyCardBackSelection(); closeCardBackDialog();">OK</button>
                    <button class="dialog-button" onclick="closeCardBackDialog();">Anuluj</button>
                </div>
            `;
            
            dialog.querySelectorAll('.card-back-preview').forEach(preview => {
                preview.addEventListener('click', () => {
                    dialog.querySelectorAll('.card-back-preview').forEach(p => p.classList.remove('selected'));
                    preview.classList.add('selected');
                    game.selectedCardBack = preview.dataset.style;
                });
            });
            
            document.body.appendChild(dialog);
        }

        function applyCardBackSelection() {
            if (game) {
                game.applyCardBack();
            }
        }

        function closeCardBackDialog() {
            const dialog = document.querySelector('.card-back-dialog');
            if (dialog) {
                dialog.remove();
            }
        }

        function showHelp() {
            alert('Pasjans - Instrukcja:\n\n' +
                  '• Przeciągnij karty aby je przełożyć\n' +
                  '• Kliknij dwukrotnie kartę aby automatycznie przenieść do fundamentu\n' +
                  '• Kliknij talię aby rozdać nowe karty\n' +
                  '• Ułóż wszystkie karty w fundamentach według kolorów od Asa do Króla\n' +
                  '• Użyj "Odwrót karty" aby zmienić wzór odwrotu');
        }

        window.addEventListener('load', () => {
            newGame();
        });
    </script>
</body>
</html>
