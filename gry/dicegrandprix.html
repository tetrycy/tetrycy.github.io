<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mistrzostwa wiata - Rzut Komi</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 8px;
            font-family: 'MS Sans Serif', Arial, sans-serif;
            background-color: #008080;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .window {
            background-color: #c0c0c0;
            border: 2px outset #dfdfdf;
            padding: 2px;
        }
        
        .title-bar {
            background-color: #000080;
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .menu-bar {
            background-color: #c0c0c0;
            border-bottom: 2px solid #808080;
            padding: 4px;
            margin-bottom: 8px;
        }
        
        .menu-item {
            padding: 4px 8px;
            display: inline-block;
            cursor: pointer;
        }
        
        .content {
            padding: 12px;
        }
        
        .white-box {
            background-color: #ffffff;
            border: 2px inset #808080;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .button {
            background-color: #c0c0c0;
            border: 2px outset #dfdfdf;
            padding: 8px 20px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial;
            margin: 3px;
        }
        
        .button:active {
            border-style: inset;
        }
        
        .button-large {
            padding: 12px 32px;
            font-size: 16px;
        }
        
        .button-green {
            background-color: #008000;
            color: white;
            border: 2px outset #00a000;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            padding: 4px;
            border: 1px solid #808080;
        }
        
        thead tr {
            background-color: #c0c0c0;
        }
        
        .dice {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: white;
            border: 2px solid black;
            text-align: center;
            line-height: 20px;
            font-weight: bold;
            margin-right: 2px;
            font-family: Arial;
        }
        
        .dice-empty {
            background-color: #c0c0c0;
        }
        
        .status-bar {
            background-color: #c0c0c0;
            border-top: 2px solid #dfdfdf;
            padding: 4px 8px;
            margin-top: 2px;
            font-size: 11px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .scroll-box {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #808080;
        }
        
        .header-blue {
            background-color: #000080;
            color: white;
            padding: 6px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .header-green {
            background-color: #008000;
            color: white;
            padding: 6px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .header-purple {
            background-color: #800080;
            color: yellow;
            padding: 6px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .yellow-banner {
            background-color: #ffff00;
            border: 2px solid black;
            padding: 12px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .mode-button {
            background-color: #c0c0c0;
            border: 2px outset #dfdfdf;
            padding: 16px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial;
            text-align: left;
            margin-bottom: 16px;
            width: 100%;
        }
        
        .highlighted-row {
            border: 3px solid blue !important;
            outline: 2px solid darkblue;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="app"></div>
    </div>

    <script>
        const countries = [
            'Polska', 'Niemcy', 'Francja', 'Wlochy', 'Hiszpania', 'Tajlandia',
            'Brazylia', 'Turcja', 'Egipt', 'Japonia', 'Australia', 'Chiny'
        ];
        
        const cities = {
            'Polska': ['Warszawa', 'Krakow', 'Gdansk', 'Wroclaw'],
            'Niemcy': ['Berlin', 'Monachium', 'Hamburg', 'Frankfurt'],
            'Francja': ['Paryz', 'Marsylia', 'Lyon', 'Nicea'],
            'Wlochy': ['Rzym', 'Mediolan', 'Wenecja', 'Florencja'],
            'Hiszpania': ['Madryt', 'Barcelona', 'Sewilla', 'Walencja'],
            'Tajlandia': ['Bangkok', 'Phuket', 'Chiang Mai', 'Pattaya'],
            'Brazylia': ['Rio', 'Sao Paulo', 'Brasilia', 'Salvador'],
            'Turcja': ['Stambu', 'Ankara', 'Izmir', 'Antalya'],
            'Egipt': ['Kair', 'Aleksandria', 'Giza', 'Luksor'],
            'Japonia': ['Tokio', 'Osaka', 'Kioto', 'Jokohama'],
            'Australia': ['Sydney', 'Melbourne', 'Brisbane', 'Perth'],
            'Chiny': ['Pekin', 'Szanghaj', 'Guangzhou', 'Shenzhen']
        };
        
        const flags = {
            'Polska': '叼', 'Niemcy': '', 'Francja': '', 'Wlochy': '',
            'Hiszpania': '', 'Tajlandia': '桂', 'Brazylia': 'ю', 'Turcja': '桂',
            'Egipt': '', 'Japonia': '', 'Australia': '', 'Chiny': ''
        };

        const maleNames = {
            'Polska': ['Janusz', 'Waldemar'],
            'Niemcy': ['Hans', 'Fritz'],
            'Francja': ['Pierre', 'Jean'],
            'Wlochy': ['Marco', 'Luigi'],
            'Hiszpania': ['Carlos', 'Jose'],
            'Tajlandia': ['Somchai', 'Niran'],
            'Brazylia': ['Lucas', 'Pedro'],
            'Turcja': ['Mehmet', 'Ahmet'],
            'Egipt': ['Ahmed', 'Mohamed'],
            'Japonia': ['Yuki', 'Kenji'],
            'Australia': ['Jack', 'Oliver'],
            'Chiny': ['Wei', 'Chen']
        };

        const lastNames = {
            'Polska': ['Sobczak', 'Wiaz'],
            'Niemcy': ['Schmidt', 'Muller'],
            'Francja': ['Dubois', 'Martin'],
            'Wlochy': ['Rossi', 'Bianchi'],
            'Hiszpania': ['Garcia', 'Rodriguez'],
            'Tajlandia': ['Srisai', 'Panya'],
            'Brazylia': ['Silva', 'Santos'],
            'Turcja': ['Yilmaz', 'Kaya'],
            'Egipt': ['Hassan', 'Ali'],
            'Japonia': ['Tanaka', 'Suzuki'],
            'Australia': ['Wilson', 'Taylor'],
            'Chiny': ['Wang', 'Li']
        };

        let gameState = {
            seasonMode: null,
            totalRounds: 0,
            seasonNumber: 1,
            currentRound: 0,
            players: [],
            history: [],
            allSeasons: [],
            showQualifying: false,
            showFinal: false,
            currentQualifying: null,
            currentFinal: null,
            stepByStep: false,
            diceByDice: false,
            currentPlayerIndex: 0,
            currentDiceIndex: 0,
            qualifyingInProgress: [],
            finalInProgress: [],
            isQualifyingPhase: true,
            lastThrownPlayerId: null,
            viewingHistory: false,
            historyRoundIndex: null,
            selectedPlayer: null,
            viewingAllSeasons: false,
            selectedSeasonIndex: null
        };

        function initializePlayers() {
            const players = [];
            countries.forEach((country, countryIndex) => {
                for (let i = 0; i < 2; i++) {
                    players.push({
                        id: countryIndex * 2 + i,
                        name: `${maleNames[country][i]} ${lastNames[country][i]}`,
                        country: country,
                        seasonPoints: 0,
                        finalsCount: 0,
                        seasonStats: []
                    });
                }
            });
            return players;
        }

        function rollSingleDice(isHome) {
            if (isHome) {
                const roll1 = Math.floor(Math.random() * 6) + 1;
                const roll2 = Math.floor(Math.random() * 6) + 1;
                return Math.max(roll1, roll2);
            }
            return Math.floor(Math.random() * 6) + 1;
        }

        function rollDice(isHome) {
            return Array.from({ length: 6 }, () => rollSingleDice(isHome));
        }

        function sumDice(dice) {
            return dice.reduce((a, b) => a + b, 0);
        }

        function getCurrentCity() {
            const cityIndex = Math.floor(gameState.currentRound / 12);
            const countryIndex = gameState.currentRound % 12;
            return cities[countries[countryIndex]][cityIndex];
        }

        function getCurrentCountry() {
            const countryIndex = gameState.currentRound % 12;
            return countries[countryIndex];
        }

        function compareByHighestDice(diceA, diceB) {
            const sortedA = [...diceA].sort((a, b) => b - a);
            const sortedB = [...diceB].sort((a, b) => b - a);
            
            for (let i = 0; i < 6; i++) {
                if (sortedA[i] !== sortedB[i]) {
                    return sortedB[i] - sortedA[i];
                }
            }
            
            for (let value = 6; value >= 1; value--) {
                const indexA = diceA.indexOf(value);
                const indexB = diceB.indexOf(value);
                
                if (indexA !== -1 && indexB !== -1) {
                    if (indexA !== indexB) {
                        return indexA - indexB;
                    }
                }
            }
            
            return 0;
        }

        function sortPlayersByDice(playersWithDice) {
            return playersWithDice.sort((a, b) => {
                if (a.total !== b.total) {
                    return b.total - a.total;
                }
                return compareByHighestDice(a.dice, b.dice);
            });
        }

        function getPlayersInStartOrder() {
            return [...gameState.players].sort((a, b) => a.seasonPoints - b.seasonPoints);
        }

        function selectSeasonMode(mode) {
            gameState.seasonMode = mode;
            if (mode === 'fast') {
                gameState.totalRounds = 12;
            } else if (mode === 'medium') {
                gameState.totalRounds = 24;
            } else if (mode === 'slow') {
                gameState.totalRounds = 48;
            }
            gameState.players = initializePlayers();
            render();
        }

        function startRoundInstant() {
            const roundCountry = getCurrentCountry();
            const roundCity = getCurrentCity();
            
            const playersInOrder = getPlayersInStartOrder();
            
            const qualifyingResults = playersInOrder.map(player => {
                const isHome = player.country === roundCountry;
                const dice = rollDice(isHome);
                const total = sumDice(dice);
                return { ...player, dice, total, isHome };
            });
            
            const sortedQualifying = sortPlayersByDice(qualifyingResults);
            const finalistsReversed = [...sortedQualifying.slice(0, 10)].reverse();
            
            const qualifyingBonuses = {
                [sortedQualifying[0].id]: 3,
                [sortedQualifying[1].id]: 2,
                [sortedQualifying[2].id]: 1
            };

            const finalResults = finalistsReversed.map(player => {
                const isHome = player.country === roundCountry;
                const dice = rollDice(isHome);
                const total = sumDice(dice);
                return { ...player, finalDice: dice, finalTotal: total, finalIsHome: isHome };
            });
            
            const sortedFinal = sortPlayersByDice(finalResults.map(p => ({...p, dice: p.finalDice, total: p.finalTotal})))
                .map(p => ({...p, dice: p.finalDice}));

            sortedQualifying.forEach((player, qIndex) => {
                const inFinal = qIndex < 10;
                let finalPos = null;
                let points = 0;
                
                if (inFinal) {
                    finalPos = sortedFinal.findIndex(fp => fp.id === player.id) + 1;
                    const finalPoints = 10 - (finalPos - 1);
                    const bonusPoints = qualifyingBonuses[player.id] || 0;
                    points = finalPoints + bonusPoints;
                    
                    const playerObj = gameState.players.find(p => p.id === player.id);
                    playerObj.seasonPoints += points;
                    playerObj.finalsCount++;
                }
                
                // Zapisz statystyki dla WSZYSTKICH zawodnik贸w, nie tylko finalist贸w
                const playerObj = gameState.players.find(p => p.id === player.id);
                playerObj.seasonStats.push({
                    roundNumber: gameState.currentRound + 1,
                    city: roundCity,
                    country: roundCountry,
                    qualifyingPosition: qIndex + 1,
                    inFinal,
                    finalPosition: finalPos,
                    pointsEarned: points
                });
            });

            gameState.history.push({
                roundNumber: gameState.currentRound + 1,
                country: roundCountry,
                city: roundCity,
                qualifying: sortedQualifying,
                final: sortedFinal,
                qualifyingBonuses
            });

            gameState.currentQualifying = sortedQualifying;
            gameState.currentFinal = sortedFinal;
            gameState.showQualifying = true;
            gameState.showFinal = true;
            gameState.stepByStep = false;
            gameState.diceByDice = false;
            
            render();
        }

        function startRoundStepByStep() {
            gameState.stepByStep = true;
            gameState.diceByDice = false;
            gameState.showQualifying = true;
            gameState.showFinal = false;
            gameState.currentPlayerIndex = 0;
            gameState.currentDiceIndex = 0;
            gameState.qualifyingInProgress = [];
            gameState.finalInProgress = [];
            gameState.isQualifyingPhase = true;
            gameState.lastThrownPlayerId = null;
            render();
        }

        function startRoundDiceByDice() {
            gameState.stepByStep = false;
            gameState.diceByDice = true;
            gameState.showQualifying = true;
            gameState.showFinal = false;
            gameState.currentPlayerIndex = 0;
            gameState.currentDiceIndex = 0;
            gameState.qualifyingInProgress = [];
            gameState.finalInProgress = [];
            gameState.isQualifyingPhase = true;
            gameState.lastThrownPlayerId = null;
            render();
        }

        function nextPlayer() {
            const roundCountry = getCurrentCountry();
            const roundCity = getCurrentCity();
            
            if (gameState.isQualifyingPhase) {
                const playersInOrder = getPlayersInStartOrder();
                if (gameState.currentPlayerIndex < playersInOrder.length) {
                    const player = playersInOrder[gameState.currentPlayerIndex];
                    gameState.lastThrownPlayerId = player.id;
                    const isHome = player.country === roundCountry;
                    const dice = rollDice(isHome);
                    const total = sumDice(dice);
                    
                    gameState.qualifyingInProgress.push({ ...player, dice, total, isHome });
                    gameState.currentPlayerIndex++;
                    
                    if (gameState.currentPlayerIndex === playersInOrder.length) {
                        gameState.currentQualifying = sortPlayersByDice([...gameState.qualifyingInProgress]);
                    }
                }
            } else {
                const finalists = [...gameState.currentQualifying.slice(0, 10)].reverse();
                if (gameState.currentPlayerIndex < finalists.length) {
                    const player = finalists[gameState.currentPlayerIndex];
                    gameState.lastThrownPlayerId = player.id;
                    const isHome = player.country === roundCountry;
                    const dice = rollDice(isHome);
                    const total = sumDice(dice);
                    
                    gameState.finalInProgress.push({ ...player, finalDice: dice, finalTotal: total, finalIsHome: isHome });
                    gameState.currentPlayerIndex++;
                    
                    if (gameState.currentPlayerIndex === finalists.length) {
                        const sorted = sortPlayersByDice(gameState.finalInProgress.map(p => ({...p, dice: p.finalDice, total: p.finalTotal})))
                            .map(p => ({...p, dice: p.finalDice}));
                        gameState.currentFinal = sorted;
                        
                        finishRound(sorted);
                    }
                }
            }
            
            render();
        }

        function nextDice() {
            const roundCountry = getCurrentCountry();
            const roundCity = getCurrentCity();
            
            if (gameState.isQualifyingPhase) {
                const playersInOrder = getPlayersInStartOrder();
                if (gameState.currentPlayerIndex < playersInOrder.length) {
                    const player = playersInOrder[gameState.currentPlayerIndex];
                    const isHome = player.country === roundCountry;
                    
                    if (gameState.currentDiceIndex === 0) {
                        gameState.lastThrownPlayerId = player.id;
                    }
                    
                    let playerInProgress = gameState.qualifyingInProgress.find(p => p.id === player.id);
                    
                    if (!playerInProgress) {
                        playerInProgress = { ...player, dice: [], total: 0, isHome };
                        gameState.qualifyingInProgress.push(playerInProgress);
                    }
                    
                    if (gameState.currentDiceIndex < 6) {
                        const newDice = rollSingleDice(isHome);
                        playerInProgress.dice.push(newDice);
                        playerInProgress.total = sumDice(playerInProgress.dice);
                        
                        gameState.currentDiceIndex++;
                        
                        if (gameState.currentDiceIndex === 6) {
                            gameState.currentPlayerIndex++;
                            gameState.currentDiceIndex = 0;
                            
                            if (gameState.currentPlayerIndex === playersInOrder.length) {
                                gameState.currentQualifying = sortPlayersByDice([...gameState.qualifyingInProgress]);
                            }
                        }
                    }
                }
            } else {
                const finalists = [...gameState.currentQualifying.slice(0, 10)].reverse();
                if (gameState.currentPlayerIndex < finalists.length) {
                    const player = finalists[gameState.currentPlayerIndex];
                    const isHome = player.country === roundCountry;
                    
                    if (gameState.currentDiceIndex === 0) {
                        gameState.lastThrownPlayerId = player.id;
                    }
                    
                    let playerInProgress = gameState.finalInProgress.find(p => p.id === player.id);
                    
                    if (!playerInProgress) {
                        playerInProgress = { ...player, finalDice: [], finalTotal: 0, finalIsHome: isHome };
                        gameState.finalInProgress.push(playerInProgress);
                    }
                    
                    if (gameState.currentDiceIndex < 6) {
                        const newDice = rollSingleDice(isHome);
                        playerInProgress.finalDice.push(newDice);
                        playerInProgress.finalTotal = sumDice(playerInProgress.finalDice);
                        
                        gameState.currentDiceIndex++;
                        
                        if (gameState.currentDiceIndex === 6) {
                            gameState.currentPlayerIndex++;
                            gameState.currentDiceIndex = 0;
                            
                            if (gameState.currentPlayerIndex === finalists.length) {
                                const sorted = sortPlayersByDice(gameState.finalInProgress.map(p => ({...p, dice: p.finalDice, total: p.finalTotal})))
                                    .map(p => ({...p, dice: p.finalDice}));
                                gameState.currentFinal = sorted;
                                
                                finishRound(sorted);
                            }
                        }
                    }
                }
            }
            
            render();
        }

        function finishRound(sortedFinal) {
            const roundCountry = getCurrentCountry();
            const roundCity = getCurrentCity();
            
            const qualifyingBonuses = {
                [gameState.currentQualifying[0].id]: 3,
                [gameState.currentQualifying[1].id]: 2,
                [gameState.currentQualifying[2].id]: 1
            };
            
            gameState.currentQualifying.forEach((player, qIndex) => {
                const inFinal = qIndex < 10;
                let finalPos = null;
                let points = 0;
                
                if (inFinal) {
                    finalPos = sortedFinal.findIndex(fp => fp.id === player.id) + 1;
                    const finalPoints = 10 - (finalPos - 1);
                    const bonusPoints = qualifyingBonuses[player.id] || 0;
                    points = finalPoints + bonusPoints;
                    
                    const playerObj = gameState.players.find(p => p.id === player.id);
                    playerObj.seasonPoints += points;
                    playerObj.finalsCount++;
                }
                
                // Zapisz statystyki dla WSZYSTKICH zawodnik贸w
                const playerObj = gameState.players.find(p => p.id === player.id);
                playerObj.seasonStats.push({
                    roundNumber: gameState.currentRound + 1,
                    city: roundCity,
                    country: roundCountry,
                    qualifyingPosition: qIndex + 1,
                    inFinal,
                    finalPosition: finalPos,
                    pointsEarned: points
                });
            });
            
            gameState.history.push({
                roundNumber: gameState.currentRound + 1,
                country: roundCountry,
                city: roundCity,
                qualifying: gameState.currentQualifying,
                final: sortedFinal,
                qualifyingBonuses
            });
        }

        function completeCurrentPhase() {
            const roundCountry = getCurrentCountry();
            
            if (gameState.isQualifyingPhase) {
                const playersInOrder = getPlayersInStartOrder();
                const remainingPlayers = playersInOrder.slice(gameState.currentPlayerIndex);
                
                remainingPlayers.forEach(player => {
                    const isHome = player.country === roundCountry;
                    const dice = rollDice(isHome);
                    const total = sumDice(dice);
                    gameState.qualifyingInProgress.push({ ...player, dice, total, isHome });
                });
                
                gameState.currentQualifying = sortPlayersByDice([...gameState.qualifyingInProgress]);
                gameState.currentPlayerIndex = playersInOrder.length;
            } else {
                const finalists = [...gameState.currentQualifying.slice(0, 10)].reverse();
                const remainingPlayers = finalists.slice(gameState.currentPlayerIndex);
                
                remainingPlayers.forEach(player => {
                    const isHome = player.country === roundCountry;
                    const dice = rollDice(isHome);
                    const total = sumDice(dice);
                    gameState.finalInProgress.push({ ...player, finalDice: dice, finalTotal: total, finalIsHome: isHome });
                });
                
                const sorted = sortPlayersByDice(gameState.finalInProgress.map(p => ({...p, dice: p.finalDice, total: p.finalTotal})))
                    .map(p => ({...p, dice: p.finalDice}));
                gameState.currentFinal = sorted;
                gameState.showFinal = true;
                gameState.currentPlayerIndex = finalists.length;
                
                finishRound(sorted);
            }
            
            render();
        }

        function switchToFinal() {
            gameState.isQualifyingPhase = false;
            gameState.currentPlayerIndex = 0;
            gameState.currentDiceIndex = 0;
            gameState.showFinal = true;
            gameState.lastThrownPlayerId = null;
            render();
        }

        function switchToDiceByDice() {
            gameState.stepByStep = false;
            gameState.diceByDice = true;
            gameState.currentDiceIndex = 0;
            render();
        }

        function switchToStepByStep() {
            gameState.stepByStep = true;
            gameState.diceByDice = false;
            
            if (gameState.currentDiceIndex > 0 && gameState.currentDiceIndex < 6) {
                const roundCountry = getCurrentCountry();
                
                if (gameState.isQualifyingPhase) {
                    const playersInOrder = getPlayersInStartOrder();
                    const player = playersInOrder[gameState.currentPlayerIndex];
                    const isHome = player.country === roundCountry;
                    
                    let playerInProgress = gameState.qualifyingInProgress.find(p => p.id === player.id);
                    
                    while (playerInProgress.dice.length < 6) {
                        const newDice = rollSingleDice(isHome);
                        playerInProgress.dice.push(newDice);
                    }
                    playerInProgress.total = sumDice(playerInProgress.dice);
                    
                    gameState.currentPlayerIndex++;
                    gameState.currentDiceIndex = 0;
                } else {
                    const finalists = [...gameState.currentQualifying.slice(0, 10)].reverse();
                    const player = finalists[gameState.currentPlayerIndex];
                    const isHome = player.country === roundCountry;
                    
                    let playerInProgress = gameState.finalInProgress.find(p => p.id === player.id);
                    
                    while (playerInProgress.finalDice.length < 6) {
                        const newDice = rollSingleDice(isHome);
                        playerInProgress.finalDice.push(newDice);
                    }
                    playerInProgress.finalTotal = sumDice(playerInProgress.finalDice);
                    
                    gameState.currentPlayerIndex++;
                    gameState.currentDiceIndex = 0;
                }
            }
            
            render();
        }

        function nextRound() {
            gameState.showQualifying = false;
            gameState.showFinal = false;
            gameState.stepByStep = false;
            gameState.diceByDice = false;
            gameState.currentRound++;
            render();
        }

        function startNewSeason() {
            const currentSeasonData = {
                seasonNumber: gameState.seasonNumber,
                rounds: [...gameState.history],
                finalStandings: getStandings().map(p => ({
                    id: p.id,
                    name: p.name,
                    country: p.country,
                    points: p.seasonPoints,
                    finalsCount: p.finalsCount
                }))
            };
            
            gameState.allSeasons.push(currentSeasonData);
            
            gameState.players.forEach(player => {
                player.seasonPoints = 0;
                player.finalsCount = 0;
                player.seasonStats = [];
            });
            
            gameState.seasonNumber++;
            gameState.currentRound = 0;
            gameState.history = [];
            gameState.showQualifying = false;
            gameState.showFinal = false;
            gameState.stepByStep = false;
            gameState.diceByDice = false;
            
            render();
        }

        function openHistory() {
            if (gameState.history.length > 0 || gameState.allSeasons.length > 0) {
                gameState.viewingHistory = true;
                gameState.historyRoundIndex = null;
                gameState.viewingAllSeasons = false;
                gameState.selectedSeasonIndex = null;
                render();
            }
        }

        function closeHistory() {
            gameState.viewingHistory = false;
            gameState.historyRoundIndex = null;
            gameState.viewingAllSeasons = false;
            gameState.selectedSeasonIndex = null;
            render();
        }

        function viewHistoryRound(index) {
            gameState.historyRoundIndex = index;
            render();
        }

        function viewAllSeasons() {
            gameState.viewingAllSeasons = true;
            gameState.historyRoundIndex = null;
            render();
        }

        function viewSeasonDetails(index) {
            gameState.selectedSeasonIndex = index;
            gameState.viewingAllSeasons = false;
            render();
        }

        function backToAllSeasons() {
            gameState.viewingAllSeasons = true;
            gameState.selectedSeasonIndex = null;
            render();
        }

        function openPlayerStats(playerId) {
            gameState.selectedPlayer = gameState.players.find(p => p.id === playerId);
            render();
        }

        function closePlayerStats() {
            gameState.selectedPlayer = null;
            render();
        }

        function getStandings() {
            return [...gameState.players].sort((a, b) => b.seasonPoints - a.seasonPoints);
        }

        function getCountryStandings() {
            const countryPoints = {};
            countries.forEach(country => {
                countryPoints[country] = 0;
            });
            
            gameState.players.forEach(player => {
                countryPoints[player.country] += player.seasonPoints;
            });
            
            return Object.entries(countryPoints)
                .map(([country, points]) => ({ country, points }))
                .sort((a, b) => b.points - a.points);
        }

        function formatDice(dice) {
            return dice.map(d => `<span class="dice">${d}</span>`).join('');
        }

        function formatIncompleteDice(dice, maxDice = 6) {
            let html = '';
            for (let i = 0; i < maxDice; i++) {
                if (i < dice.length) {
                    html += `<span class="dice">${dice[i]}</span>`;
                } else {
                    html += `<span class="dice dice-empty">?</span>`;
                }
            }
            return html;
        }

        function renderHistoryModal() {
            // Widok szczeg贸贸w wybranego sezonu z archiwum
            if (gameState.selectedSeasonIndex !== null) {
                const season = gameState.allSeasons[gameState.selectedSeasonIndex];
                
                // Oblicz klasyfikacj kraj贸w
                const countryPoints = {};
                countries.forEach(country => {
                    countryPoints[country] = 0;
                });
                season.finalStandings.forEach(player => {
                    countryPoints[player.country] += player.points;
                });
                const countryStandings = Object.entries(countryPoints)
                    .map(([country, points]) => ({ country, points }))
                    .sort((a, b) => b.points - a.points);
                
                return `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 999;" onclick="closeHistory()"></div>
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #c0c0c0; border: 2px outset #dfdfdf; padding: 2px; z-index: 1000; min-width: 700px; max-width: 90vw; max-height: 80vh; overflow: auto;">
                        <div class="title-bar" style="background: #800080; color: yellow;">
                            <span>SEZON #${season.seasonNumber}</span>
                            <span style="cursor: pointer;" onclick="closeHistory()">X</span>
                        </div>
                        <div style="padding: 12px;">
                            <div class="white-box" style="margin-bottom: 12px;">
                                <strong>KLASYFIKACJA KONCOWA ZAWODNIKOW:</strong>
                                <table style="margin-top: 4px; font-size: 11px;">
                                    <tbody>
                                        ${season.finalStandings.map((player, index) => {
                                            const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                                            return `
                                                <tr style="background-color: ${bgColor};">
                                                    <td style="font-weight: bold;">${index + 1}</td>
                                                    <td style="font-weight: bold;">${flags[player.country]}</td>
                                                    <td>${player.name}</td>
                                                    <td style="text-align: right;">${player.points}</td>
                                                    <td style="text-align: center;">${player.finalsCount}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="white-box" style="margin-bottom: 12px;">
                                <strong>KLASYFIKACJA KRAJOW:</strong>
                                <table style="margin-top: 4px; font-size: 11px;">
                                    <tbody>
                                        ${countryStandings.map((item, index) => {
                                            const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                                            return `
                                                <tr style="background-color: ${bgColor};">
                                                    <td style="font-weight: bold; width: 35px;">${index + 1}</td>
                                                    <td style="font-weight: bold; width: 40px;">${flags[item.country]}</td>
                                                    <td style="font-weight: bold;">${item.country}</td>
                                                    <td style="text-align: right; font-weight: bold; width: 50px;">${item.points}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            ${season.rounds && season.rounds.length > 0 ? `
                                <div class="white-box">
                                    <strong>ZWYCIEZCY RUND:</strong>
                                    <div style="max-height: 300px; overflow-y: auto; margin-top: 4px;">
                                        <table style="font-size: 11px;">
                                            <tbody>
                                                ${season.rounds.map(round => {
                                                    const winner = round.final[0];
                                                    return `
                                                        <tr>
                                                            <td style="width: 60px;">Runda ${round.roundNumber}</td>
                                                            <td style="width: 120px;">${round.city}</td>
                                                            <td style="font-weight: bold;">${flags[winner.country]} ${winner.name}</td>
                                                            <td style="text-align: right;">${winner.finalTotal}${winner.finalIsHome ? '*' : ''}</td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="text-align: center; margin-top: 12px;">
                                <button class="button" onclick="backToAllSeasons()">Powrot do archiwum</button>
                                <button class="button" onclick="closeHistory()">Zamknij</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Widok listy wszystkich sezon贸w
            if (gameState.viewingAllSeasons) {
                return `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 999;" onclick="closeHistory()"></div>
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #c0c0c0; border: 2px outset #dfdfdf; padding: 2px; z-index: 1000; min-width: 500px; max-height: 80vh; overflow: auto;">
                        <div class="title-bar" style="background: #800080; color: yellow;">
                            <span>ARCHIWUM SEZONOW</span>
                            <span style="cursor: pointer;" onclick="closeHistory()">X</span>
                        </div>
                        <div style="padding: 12px;">
                            <div class="white-box" style="max-height: 400px; overflow-y: auto;">
                                ${gameState.allSeasons.map((season, index) => `
                                    <div style="background-color: #ffffff; border: 2px solid #808080; padding: 12px; margin-bottom: 8px; cursor: pointer;" onclick="viewSeasonDetails(${index})">
                                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">SEZON #${season.seasonNumber}</div>
                                        <div style="font-size: 12px;">
                                            Mistrz: ${season.finalStandings[0].name} (${flags[season.finalStandings[0].country]}) - ${season.finalStandings[0].points} pkt
                                        </div>
                                        <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                            Kliknij aby zobaczyc szczegoly
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="text-align: center; margin-top: 12px;">
                                <button class="button" onclick="closeHistory()">Powrot</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Widok szczeg贸贸w rundy z bie偶cego sezonu
            if (gameState.historyRoundIndex !== null) {
                const round = gameState.history[gameState.historyRoundIndex];
                return `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 999;" onclick="closeHistory()"></div>
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #c0c0c0; border: 2px outset #dfdfdf; padding: 2px; z-index: 1000; min-width: 500px; max-height: 80vh; overflow: auto;">
                        <div class="title-bar" style="background: #800080; color: yellow;">
                            <span>RUNDA ${round.roundNumber} - ${round.city}, ${round.country}</span>
                            <span style="cursor: pointer;" onclick="closeHistory()">X</span>
                        </div>
                        <div style="padding: 12px;">
                            <div class="white-box">
                                <strong>KWALIFIKACJE:</strong>
                                <table style="margin-top: 4px;">
                                    <tbody>
                                        ${round.qualifying.slice(0, 10).map((player, index) => `
                                            <tr style="background-color: ${index < 3 ? '#ffff00' : '#00ff00'};">
                                                <td>${index + 1}</td>
                                                <td>${flags[player.country]}</td>
                                                <td>${player.name}</td>
                                                <td>${player.total}${player.isHome ? '*' : ''}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="white-box">
                                <strong>FINAL:</strong>
                                <table style="margin-top: 4px;">
                                    <tbody>
                                        ${round.final.map((player, index) => {
                                            const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                                            return `
                                                <tr style="background-color: ${bgColor};">
                                                    <td>${index + 1}</td>
                                                    <td>${flags[player.country]}</td>
                                                    <td>${player.name}</td>
                                                    <td>${player.finalTotal}${player.finalIsHome ? '*' : ''}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div style="text-align: center; margin-top: 12px;">
                                <button class="button" onclick="closeHistory()">Powrot do historii</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Domylny widok - lista rund z bie偶cego sezonu
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 999;" onclick="closeHistory()"></div>
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #c0c0c0; border: 2px outset #dfdfdf; padding: 2px; z-index: 1000; min-width: 500px; max-height: 80vh; overflow: auto;">
                    <div class="title-bar">
                        <span>HISTORIA RUND - SEZON #${gameState.seasonNumber}</span>
                        <span style="cursor: pointer;" onclick="closeHistory()">X</span>
                    </div>
                    <div style="padding: 12px;">
                        ${gameState.history.length > 0 ? `
                            <div class="white-box" style="max-height: 400px; overflow-y: auto;">
                                ${gameState.history.map((round, index) => `
                                    <div style="background-color: #ffffff; border: 1px solid #808080; padding: 8px; margin-bottom: 4px; cursor: pointer;" onclick="viewHistoryRound(${index})">
                                        <strong>Runda ${round.roundNumber}</strong> - ${round.city}, ${round.country}<br>
                                        Zwyciezca: ${round.final[0].name} (${flags[round.final[0].country]})
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="white-box"><em>Brak rund w tym sezonie</em></div>'}
                        <div style="text-align: center; margin-top: 12px;">
                            ${gameState.allSeasons.length > 0 ? `
                                <button class="button" onclick="viewAllSeasons()">Poprzednie sezony (${gameState.allSeasons.length})</button>
                            ` : ''}
                            <button class="button" onclick="closeHistory()">Zamknij</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayerStatsModal() {
            const player = gameState.selectedPlayer;
            return `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 999;" onclick="closePlayerStats()"></div>
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #c0c0c0; border: 2px outset #dfdfdf; padding: 2px; z-index: 1000; min-width: 500px; max-height: 80vh; overflow: auto;">
                    <div class="title-bar">
                        <span>STATYSTYKI - ${player.name}</span>
                        <span style="cursor: pointer;" onclick="closePlayerStats()">X</span>
                    </div>
                    <div style="padding: 12px;">
                        <div class="white-box" style="margin-bottom: 12px;">
                            <div style="margin-bottom: 8px;">
                                <strong>Kraj:</strong> ${flags[player.country]} ${player.country}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Laczne punkty:</strong> ${player.seasonPoints}
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Liczba finalow:</strong> ${player.finalsCount}/${gameState.totalRounds}
                            </div>
                        </div>
                        
                        ${player.seasonStats.length > 0 ? `
                            <div class="white-box">
                                <div class="header-green">WYNIKI W RUNDACH</div>
                                <table style="font-size: 11px;">
                                    <thead>
                                        <tr>
                                            <th>Runda</th>
                                            <th>Lokalizacja</th>
                                            <th>Kwal.</th>
                                            <th>Final</th>
                                            <th>Pkt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${player.seasonStats.map(stat => `
                                            <tr style="background-color: ${stat.inFinal ? '#e0ffe0' : '#ffe0e0'};">
                                                <td style="text-align: center;">${stat.roundNumber}</td>
                                                <td>${stat.city}</td>
                                                <td style="text-align: center;">${stat.qualifyingPosition}</td>
                                                <td style="text-align: center; font-weight: bold;">${stat.inFinal ? stat.finalPosition : '-'}</td>
                                                <td style="text-align: center; font-weight: bold;">${stat.pointsEarned || 0}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="white-box"><em>Brak danych z rund</em></div>'}
                        
                        <div style="text-align: center; margin-top: 12px;">
                            <button class="button" onclick="closePlayerStats()">Zamknij</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (gameState.seasonMode === null) {
                app.innerHTML = renderModeSelection();
            } else {
                app.innerHTML = renderGame();
            }
        }

        function renderModeSelection() {
            return `
                <div class="window">
                    <div class="title-bar">
                        <span>MISTRZOSTWA SWIATA - RZUT KOSCMI - WYBOR TRYBU</span>
                    </div>
                    <div style="padding: 32px; text-align: center;">
                        <div class="white-box">
                            <h2 style="margin-top: 0; font-size: 20px;">WYBIERZ TEMPO SEZONU</h2>
                            <p style="color: #800000; font-size: 14px; margin-bottom: 24px;">
                                UWAGA: Po wyborze nie bedzie mozna zmienic!
                            </p>
                            <div style="max-width: 500px; margin: 0 auto;">
                                <button class="mode-button" onclick="selectSeasonMode('fast')">
                                    <div style="font-size: 18px; margin-bottom: 8px;"> SZYBKIE SEZONY</div>
                                    <div style="font-size: 13px; font-weight: normal;">
                                        12 rund (1 turniej w kazdym kraju)
                                    </div>
                                </button>
                                <button class="mode-button" onclick="selectSeasonMode('medium')">
                                    <div style="font-size: 18px; margin-bottom: 8px;"> SREDNIE SEZONY</div>
                                    <div style="font-size: 13px; font-weight: normal;">
                                        24 rundy (2 turnieje w kazdym kraju)
                                    </div>
                                </button>
                                <button class="mode-button" onclick="selectSeasonMode('slow')">
                                    <div style="font-size: 18px; margin-bottom: 8px;"> WOLNE SEZONY</div>
                                    <div style="font-size: 13px; font-weight: normal;">
                                        48 rund (4 turnieje w kazdym kraju)
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGame() {
            let modals = '';
            
            // Modal historii
            if (gameState.viewingHistory) {
                modals += renderHistoryModal();
            }
            
            // Modal statystyk zawodnika
            if (gameState.selectedPlayer) {
                modals += renderPlayerStatsModal();
            }
            
            return `
                ${modals}
                <div class="window">
                    <div class="title-bar">
                        <span>MISTRZOSTWA SWIATA - RZUT KOSCMI - SEZON #${gameState.seasonNumber}</span>
                        <span style="font-size: 16px;"></span>
                    </div>
                    
                    <div class="menu-bar">
                        <span class="menu-item">Plik</span>
                        <span class="menu-item">Edycja</span>
                        <span class="menu-item" style="cursor: pointer; ${gameState.history.length > 0 ? 'text-decoration: underline;' : ''}" onclick="openHistory()">Historia</span>
                        <span class="menu-item">Pomoc</span>
                    </div>
                    
                    <div class="content">
                        <div class="white-box">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">
                                    RUNDA ${gameState.currentRound + 1}/${gameState.totalRounds}
                                </div>
                                ${gameState.currentRound < gameState.totalRounds ? `
                                    <div style="font-size: 14px;">
                                        Lokalizacja: ${getCurrentCity()}, ${getCurrentCountry()}
                                        <div style="font-size: 11px; color: #800000; margin-top: 4px;">
                                            * Zawodnicy z ${getCurrentCountry()} maja wieksze szczescie (rzucaja 2x i bierze sie lepszy wynik)
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${renderMainContent()}
                        </div>
                        
                        <div class="grid-2">
                            <div class="white-box">
                                <div class="header-blue">KLASYFIKACJA ZAWODNIKOW</div>
                                <div class="scroll-box">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Poz</th>
                                                <th>Kraj</th>
                                                <th>Zawodnik</th>
                                                <th>Pkt</th>
                                                <th>F</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${renderPlayerStandings()}
                                        </tbody>
                                    </table>
                                </div>
                                <div style="font-size: 10px; margin-top: 4px; text-align: center; color: #666;">
                                    Kliknij na zawodnika aby zobaczyc statystyki
                                </div>
                            </div>
                            
                            <div class="white-box">
                                <div class="header-green">KLASYFIKACJA KRAJOW</div>
                                <div class="scroll-box">
                                    <table>
                                        <tbody>
                                            ${renderCountryStandings()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="status-bar">
                        Gospodarze: 2x rzut (lepszy) | Remis: 6&gt;5&gt;4&gt;3&gt;2&gt;1 | Historia: ${gameState.history.length}/${gameState.totalRounds} | Sezon #${gameState.seasonNumber}
                    </div>
                </div>
            `;
        }

        function renderMainContent() {
            if (gameState.currentRound < gameState.totalRounds && !gameState.showQualifying) {
                return `
                    <div style="text-align: center;">
                        <button class="button" onclick="startRoundInstant()">CALA RUNDA</button>
                        <button class="button" onclick="startRoundStepByStep()">ZAWODNIK PO ZAWODNIKU</button>
                        <button class="button" onclick="startRoundDiceByDice()">KOSC PO KOSCI</button>
                    </div>
                `;
            }
            
            if (gameState.currentRound >= gameState.totalRounds && !gameState.showQualifying) {
                return `
                    <div style="text-align: center;">
                        <div class="yellow-banner">*** KONIEC SEZONU #${gameState.seasonNumber} ***</div>
                        <button class="button button-large button-green" onclick="startNewSeason()">
                            ROZPOCZNIJ SEZON #${gameState.seasonNumber + 1}
                        </button>
                    </div>
                `;
            }
            
            let html = '';
            
            if (gameState.showQualifying && !gameState.showFinal) {
                html += `
                    <div class="header-blue">KWALIFIKACJE - ${getCurrentCity()}, ${getCurrentCountry()}</div>
                    <div class="white-box" style="max-height: 350px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Poz</th>
                                    <th>Kraj</th>
                                    <th>Zawodnik</th>
                                    <th>Kosci</th>
                                    <th>Suma</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderQualifying()}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        ${renderQualifyingControls()}
                    </div>
                `;
            }
            
            if (gameState.showFinal) {
                html += `
                    <div class="header-purple" style="margin-top: 12px;">*** FINAL - ${getCurrentCity()}, ${getCurrentCountry()} ***</div>
                    <div class="white-box">
                        <table>
                            <thead>
                                <tr>
                                    <th>Msc</th>
                                    <th>Kraj</th>
                                    <th>Zawodnik</th>
                                    <th>Kosci</th>
                                    <th>Suma</th>
                                    <th>Punkty</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderFinal()}
                            </tbody>
                        </table>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        ${renderFinalControls()}
                    </div>
                `;
            }
            
            return html;
        }

        function renderQualifyingControls() {
            const playersInOrder = getPlayersInStartOrder();
            
            if (gameState.stepByStep && gameState.isQualifyingPhase && gameState.currentPlayerIndex < playersInOrder.length) {
                const currentPlayer = playersInOrder[gameState.currentPlayerIndex];
                return `
                    <button class="button" onclick="nextPlayer()">
                        NASTEPNY: ${currentPlayer.name} (${gameState.currentPlayerIndex + 1}/24)
                    </button>
                    <button class="button" onclick="switchToDiceByDice()">KOSC PO KOSCI</button>
                    <button class="button" onclick="completeCurrentPhase()">ROZEGRAJ RESZTE</button>
                `;
            }
            
            if (gameState.diceByDice && gameState.isQualifyingPhase && gameState.currentPlayerIndex < playersInOrder.length) {
                const currentPlayer = playersInOrder[gameState.currentPlayerIndex];
                return `
                    <button class="button" onclick="nextDice()">
                        RZUT: ${currentPlayer.name} - kosc ${gameState.currentDiceIndex + 1}/6
                    </button>
                    <button class="button" onclick="switchToStepByStep()">ZAWODNIK PO ZAWODNIKU</button>
                    <button class="button" onclick="completeCurrentPhase()">ROZEGRAJ RESZTE</button>
                `;
            }
            
            return `
                <button class="button" onclick="switchToFinal()">POKAZ FINAL</button>
                <button class="button" onclick="startRoundInstant()">ROZEGRAJ RESZTE RUNDY</button>
            `;
        }

        function renderFinalControls() {
            const finalists = gameState.currentQualifying ? [...gameState.currentQualifying.slice(0, 10)].reverse() : [];
            
            if (gameState.stepByStep && !gameState.isQualifyingPhase && gameState.currentPlayerIndex < 10 && finalists[gameState.currentPlayerIndex]) {
                const currentPlayer = finalists[gameState.currentPlayerIndex];
                return `
                    <button class="button" onclick="nextPlayer()">
                        NASTEPNY: ${currentPlayer.name} (${gameState.currentPlayerIndex + 1}/10)
                    </button>
                    <button class="button" onclick="switchToDiceByDice()">KOSC PO KOSCI</button>
                    <button class="button" onclick="completeCurrentPhase()">ROZEGRAJ RESZTE</button>
                `;
            }
            
            if (gameState.diceByDice && !gameState.isQualifyingPhase && gameState.currentPlayerIndex < 10 && finalists[gameState.currentPlayerIndex]) {
                const currentPlayer = finalists[gameState.currentPlayerIndex];
                return `
                    <button class="button" onclick="nextDice()">
                        RZUT: ${currentPlayer.name} - kosc ${gameState.currentDiceIndex + 1}/6
                    </button>
                    <button class="button" onclick="switchToStepByStep()">ZAWODNIK PO ZAWODNIKU</button>
                    <button class="button" onclick="completeCurrentPhase()">ROZEGRAJ RESZTE</button>
                `;
            }
            
            if (gameState.currentRound < gameState.totalRounds) {
                return `
                    <button class="button" onclick="nextRound()">NASTEPNA RUNDA</button>
                    <button class="button" onclick="startRoundInstant()">ROZEGRAJ CALA NASTEPNA RUNDE</button>
                `;
            } else {
                return `
                    <div class="yellow-banner">*** KONIEC SEZONU #${gameState.seasonNumber} ***</div>
                    <button class="button button-large button-green" onclick="startNewSeason()">
                        ROZPOCZNIJ SEZON #${gameState.seasonNumber + 1}
                    </button>
                `;
            }
        }

        function renderQualifying() {
            if (gameState.stepByStep || gameState.diceByDice) {
                const sorted = sortPlayersByDice([...gameState.qualifyingInProgress]);
                return sorted.map((player, index) => {
                    const bgColor = index < 10 ? '#e0ffe0' : '#ffe0e0';
                    const isHighlighted = player.id === gameState.lastThrownPlayerId;
                    const rowClass = isHighlighted ? 'highlighted-row' : '';
                    return `
                        <tr class="${rowClass}" style="background-color: ${bgColor};">
                            <td style="font-weight: bold;">${index + 1}</td>
                            <td style="font-weight: bold;">${isHighlighted ? '' : ''} ${flags[player.country]}</td>
                            <td style="${isHighlighted ? 'font-weight: bold;' : ''}">${player.name}</td>
                            <td>${gameState.diceByDice ? formatIncompleteDice(player.dice) : formatDice(player.dice)}</td>
                            <td style="text-align: right; font-weight: bold;">${player.total}${player.isHome ? '*' : ''}</td>
                            <td style="text-align: center;">${index < 10 ? 'Q' : 'X'}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            if (!gameState.currentQualifying) return '';
            
            return gameState.currentQualifying.map((player, index) => {
                const bgColor = index < 10 ? '#00ff00' : '#ff0000';
                return `
                    <tr style="background-color: ${bgColor};">
                        <td style="font-weight: bold;">${index + 1}</td>
                        <td style="font-weight: bold;">${flags[player.country]}</td>
                        <td>${player.name}</td>
                        <td>${formatDice(player.dice)}</td>
                        <td style="text-align: right; font-weight: bold;">${player.total}${player.isHome ? '*' : ''}</td>
                        <td style="text-align: center; font-weight: bold;">
                            ${index < 10 ? 'FINAL' : 'OUT'}
                            ${index < 3 ? ` +${3-index}` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderFinal() {
            if (gameState.stepByStep || gameState.diceByDice) {
                if (!gameState.isQualifyingPhase && gameState.currentPlayerIndex < 10) {
                    const sorted = sortPlayersByDice(gameState.finalInProgress.map(p => ({...p, dice: p.finalDice, total: p.finalTotal})));
                    return sorted.map((player, index) => {
                        const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                        const isHighlighted = player.id === gameState.lastThrownPlayerId;
                        const rowClass = isHighlighted ? 'highlighted-row' : '';
                        return `
                            <tr class="${rowClass}" style="background-color: ${bgColor};">
                                <td style="font-weight: bold;">${index + 1}</td>
                                <td style="font-weight: bold;">${isHighlighted ? '' : ''} ${flags[player.country]}</td>
                                <td style="${isHighlighted ? 'font-weight: bold;' : ''}">${player.name}</td>
                                <td>${gameState.diceByDice ? formatIncompleteDice(player.dice) : formatDice(player.dice)}</td>
                                <td style="text-align: right; font-weight: bold;">${player.total}${player.isHome ? '*' : ''}</td>
                                <td style="text-align: right;">${10 - index} pkt</td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            if (!gameState.currentFinal) return '';
            
            const lastRound = gameState.history[gameState.history.length - 1];
            
            return gameState.currentFinal.map((player, index) => {
                const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                const bonus = lastRound ? (lastRound.qualifyingBonuses[player.id] || 0) : 0;
                const finalPoints = 10 - index;
                const totalPoints = finalPoints + bonus;
                
                return `
                    <tr style="background-color: ${bgColor};">
                        <td style="font-weight: bold;">${index + 1}</td>
                        <td style="font-weight: bold;">${flags[player.country]}</td>
                        <td style="font-weight: bold;">${player.name}</td>
                        <td>${formatDice(player.dice)}</td>
                        <td style="text-align: right; font-weight: bold;">${player.finalTotal}${player.finalIsHome ? '*' : ''}</td>
                        <td style="text-align: right; font-weight: bold;">
                            +${totalPoints}
                            ${bonus > 0 ? `<span style="font-size: 10px;"> (${finalPoints}+${bonus})</span>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPlayerStandings() {
            return getStandings().map((player, index) => {
                const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                return `
                    <tr style="background-color: ${bgColor}; cursor: pointer;" onclick="openPlayerStats(${player.id})">
                        <td style="font-weight: bold;">${index + 1}</td>
                        <td style="font-weight: bold;">${flags[player.country]}</td>
                        <td>${player.name}</td>
                        <td style="text-align: right; font-weight: bold;">${player.seasonPoints}</td>
                        <td style="text-align: center;">${player.finalsCount}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderCountryStandings() {
            return getCountryStandings().map((item, index) => {
                const bgColor = index === 0 ? '#ffff00' : index === 1 ? '#c0c0c0' : index === 2 ? '#ff8000' : '#ffffff';
                return `
                    <tr style="background-color: ${bgColor};">
                        <td style="font-weight: bold;">${index + 1}</td>
                        <td style="font-weight: bold;">${flags[item.country]}</td>
                        <td style="font-weight: bold;">${item.country}</td>
                        <td style="text-align: right; font-weight: bold;">${item.points}</td>
                    </tr>
                `;
            }).join('');
        }

        render();
    </script>
</body>
</html>
