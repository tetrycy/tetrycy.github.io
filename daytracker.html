<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Day Tracker - Pro Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --font-main: 'Libre Baskerville', serif;
            --primary: #2c3e50;
            --bg-body: #faf9f6;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #e0e0e0;
            --gap-pattern: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 10px, #faf9f6 10px, #faf9f6 20px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background: var(--bg-body);
            color: var(--text-main);
            padding-bottom: 100px;
            padding-top: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-body);
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: rgba(250, 249, 246, 0.95);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
        }

        .header h1 {
            grid-column: 2;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            font-weight: 700;
        }

        .settings-btn {
            grid-column: 3;
            justify-self: end;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            padding: 5px;
            font-size: 18px;
        }

        .date-controls {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .date-controls button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .date-controls button:hover { border-color: var(--text-main); }

        .current-date {
            font-size: 18px;
            font-style: italic;
            text-align: center;
            min-width: 180px;
        }

        /* TIMELINE */
        .timeline { padding: 30px 20px; position: relative; }

        .hour-line {
            display: flex;
            align-items: flex-start;
            height: 70px;
            position: relative;
        }

        .hour-line::after {
            content: '';
            position: absolute; left: 60px; right: 0; top: 0;
            height: 1px; background: #eee; z-index: 0;
        }

        .hour-label {
            width: 60px;
            font-size: 14px;
            color: var(--text-muted);
            padding-right: 15px;
            text-align: right;
            transform: translateY(-50%);
            font-variant-numeric: oldstyle-nums;
        }

        .hour-bar { flex-grow: 1; height: 100%; position: relative; border-left: 1px solid #f0f0f0; }

        /* BLOCKS */
        .activity-block {
            position: absolute; left: 5px; right: 5px;
            border-radius: 3px;
            padding: 0 10px;
            font-size: 13px;
            color: white;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            z-index: 10;
            transition: transform 0.2s;
        }
        
        .activity-block:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

        /* GAP BLOCKS (NEW) */
        .gap-block {
            position: absolute; left: 5px; right: 5px;
            background: var(--gap-pattern);
            border: 1px dashed #e0e0e0;
            border-radius: 3px;
            z-index: 5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .gap-block:hover { opacity: 1; background: #eee; }
        .gap-label { font-size: 10px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* Current Time Line */
        .current-time-indicator {
            position: absolute; left: 60px; right: 0;
            height: 1px; background: #c0392b; z-index: 20; pointer-events: none;
        }
        .current-time-indicator::before {
            content: ''; position: absolute; left: -4px; top: -4px;
            width: 8px; height: 8px; border-radius: 50%; background: #c0392b;
        }

        /* FAB */
        .add-activity-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--text-main); color: white;
            border: none; font-size: 28px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }

        /* MODALS */
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);
            z-index: 200; align-items: center; justify-content: center; padding: 20px;
        }
        .modal.active { display: flex; animation: fadeIn 0.3s ease; }

        .modal-content {
            background: white; border: 1px solid var(--border);
            padding: 30px; width: 100%; max-width: 450px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); border-radius: 2px;
            max-height: 90vh; overflow-y: auto;
        }

        .modal-header {
            font-size: 22px; margin-bottom: 25px; text-align: center;
            font-style: italic; display: flex; justify-content: space-between; align-items: center;
        }

        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; margin-bottom: 8px; font-size: 11px;
            text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted);
        }
        .form-group input[type="text"],
        .form-group input[type="time"] {
            width: 100%; padding: 10px 0; background: transparent;
            border: none; border-bottom: 2px solid #eee;
            font-size: 16px; font-family: inherit; color: var(--text-main);
            outline: none; transition: border-color 0.2s;
        }
        .form-group input:focus { border-color: var(--text-main); }

        .categories-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
        }

        .category-option {
            display: flex; align-items: center; padding: 10px;
            border: 1px solid #eee; background: white; cursor: pointer; transition: all 0.2s;
        }
        .category-option.selected { border-color: var(--text-main); background: #f8f8f8; }
        .category-color { width: 14px; height: 14px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        
        /* SETTINGS */
        .settings-list { margin-top: 20px; border-top: 1px solid #eee; }
        .setting-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid #eee;
        }
        .btn-icon { background: none; border: none; cursor: pointer; color: #e74c3c; padding: 5px; font-size: 18px; }
        .new-cat-form { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end; }
        .color-picker { width: 40px; height: 40px; border: none; background: none; cursor: pointer; padding: 0;}

        /* STATS & TOGGLE */
        .stats { padding: 30px 20px; border-top: 1px solid var(--border); }
        
        .stats-header {
            display: flex; align-items: center; justify-content: center; 
            margin-bottom: 25px; gap: 15px;
        }
        .stats-toggle {
            display: flex; background: #eee; padding: 3px; border-radius: 20px;
        }
        .toggle-btn {
            border: none; background: none; padding: 6px 15px; border-radius: 17px;
            font-family: inherit; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; color: var(--text-muted); transition: all 0.2s;
        }
        .toggle-btn.active { background: white; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; }
        .stat-card {
            background: white; padding: 15px; border: 1px solid rgba(0,0,0,0.05);
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            position: relative;
        }
        .stat-value { font-size: 20px; margin-bottom: 5px; font-variant-numeric: oldstyle-nums; }
        .stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }

        .btn-group { display: flex; gap: 10px; margin-top: 30px; }
        .btn {
            flex: 1; padding: 12px; border: none; font-family: inherit;
            font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--text-main); color: white; }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-danger { background: white; border: 1px solid #c0392b; color: #c0392b; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div></div> 
        <h1>Dziennik</h1>
        <button class="settings-btn" id="openSettingsBtn" title="Ustawienia">⚙</button>

        <div class="date-controls">
            <button id="prevDay">&larr;</button>
            <div class="current-date" id="currentDate"></div>
            <button id="nextDay">&rarr;</button>
        </div>
    </div>

    <div class="timeline" id="timeline"></div>

    <div class="stats">
        <div class="stats-header">
            <div class="stats-toggle">
                <button class="toggle-btn active" id="statsDayBtn">Dziś</button>
                <button class="toggle-btn" id="statsWeekBtn">7 Dni</button>
            </div>
        </div>
        <div class="stats-grid" id="stats"></div>
    </div>
</div>

<button class="add-activity-btn" id="addActivityBtn">+</button>

<div class="modal" id="activityModal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modalTitle">Nowy Wpis</span>
            <button class="close-btn" id="closeModal" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <form id="activityForm">
            <div class="time-inputs" style="display: flex; gap: 20px;">
                <div class="form-group" style="flex:1">
                    <label>Początek</label>
                    <input type="time" id="startTime" required>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Koniec</label>
                    <input type="time" id="endTime" required>
                </div>
            </div>

            <div class="form-group">
                <label>Opis (opcjonalnie, zamiast kategorii)</label>
                <input type="text" id="customDescription" placeholder="Np. Spacer z psem, Drzemka...">
            </div>

            <div class="form-group">
                <label>Kategorie (opcjonalnie)</label>
                <div class="categories-grid" id="categoriesGrid"></div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Anuluj</button>
                <button type="button" class="btn btn-danger" id="deleteBtn" style="display: none;">Usuń</button>
                <button type="submit" class="btn btn-primary">Zapisz</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Ustawienia</span>
            <button class="close-btn" id="closeSettings" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>

        <div style="font-size:12px; text-transform:uppercase; color:#999; margin-bottom:10px;">Kategorie</div>
        <div class="new-cat-form">
            <div style="flex:1;">
                <input type="text" id="newCatName" placeholder="Nowa kategoria" style="width:100%; padding:8px; border:none; border-bottom:1px solid #ccc;">
            </div>
            <div>
                <input type="color" id="newCatColor" class="color-picker" value="#3498db">
            </div>
            <button id="addCatBtn" class="btn btn-primary" style="padding: 8px 15px;">+</button>
        </div>

        <div class="settings-list" id="settingsList"></div>
    </div>
</div>

<script>
// --- KONFIGURACJA ---
const DEFAULT_CATEGORIES = [
    { id: 'praca', name: 'Praca', color: '#546de5' }, 
    { id: 'zuzia', name: 'Zuzia', color: '#e15f41' }, 
    { id: 'ignas', name: 'Ignaś', color: '#f7b731' }, 
    { id: 'zakupy', name: 'Zakupy', color: '#a29bfe' }, 
    { id: 'moj-czas', name: 'Mój czas', color: '#20bf6b' }, 
    { id: 'dom', name: 'Dom', color: '#95a5a6' }
];

let categoriesList = JSON.parse(localStorage.getItem('dayTrackerCategories')) || DEFAULT_CATEGORIES;
let currentDate = new Date();
let activities = JSON.parse(localStorage.getItem('dayTrackerActivities')) || {};
let selectedCategories = [];
let editingActivityId = null;
let statsMode = 'day'; // 'day' or 'week'

// --- HELPERY ---
function saveCategories() {
    localStorage.setItem('dayTrackerCategories', JSON.stringify(categoriesList));
    renderCategoriesGrid();
    renderSettingsList();
    updateDisplay();
}

function formatDate(date) {
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    let str = date.toLocaleDateString('pl-PL', options);
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function getDateKey(date) {
    return date.toISOString().split('T')[0];
}

function getCategoryById(id) {
    return categoriesList.find(c => c.id === id) || { name: 'Usunięta', color: '#ccc' };
}

function getDisplayText(activity) {
    if (activity.description && activity.description.trim() !== "") {
        return activity.description;
    }
    if (activity.categories && activity.categories.length > 0) {
        return activity.categories.map(id => getCategoryById(id).name).join(' + ');
    }
    return "(Brak opisu)";
}

function getMinutesFromTime(timeStr) {
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
}

function getTimeFromMinutes(totalMinutes) {
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
}

// --- RENDERING ---

function renderCategoriesGrid() {
    const grid = document.getElementById('categoriesGrid');
    grid.innerHTML = categoriesList.map(category => `
        <div class="category-option ${selectedCategories.includes(category.id) ? 'selected' : ''}" 
             data-id="${category.id}">
            <div class="category-color" style="background: ${category.color}"></div>
            <div style="font-size:13px;">${category.name}</div>
        </div>
    `).join('');

    grid.querySelectorAll('.category-option').forEach(option => {
        option.addEventListener('click', () => toggleCategory(option.dataset.id));
    });
}

function renderSettingsList() {
    const list = document.getElementById('settingsList');
    let html = categoriesList.map(cat => `
        <div class="setting-item">
            <div style="display:flex; align-items:center;">
                <div class="category-color" style="background: ${cat.color}"></div>
                <span>${cat.name}</span>
            </div>
            <button class="btn-icon" onclick="deleteCategory('${cat.id}')">&times;</button>
        </div>
    `).join('');

    // Sekcja Backup
    html += `
        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px dashed #eee;">
            <h4 style="font-size: 11px; text-transform: uppercase; color: #999; margin-bottom: 15px;">Kopia Zapasowa</h4>
            <div style="display: flex; gap: 10px;">
                <button onclick="exportData()" class="btn btn-secondary" style="font-size: 11px;">⬇ Pobierz</button>
                <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary" style="font-size: 11px;">⬆ Wgraj</button>
                <input type="file" id="importFile" style="display: none" onchange="importData(this)" accept=".json">
            </div>
        </div>
    `;
    list.innerHTML = html;
}

function toggleCategory(categoryId) {
    const index = selectedCategories.indexOf(categoryId);
    if (index > -1) selectedCategories.splice(index, 1);
    else selectedCategories.push(categoryId);
    renderCategoriesGrid();
}

function getActivityStyle(activity) {
    const cats = activity.categories || [];
    if (cats.length === 0) return { background: '#bdc3c7' };
    if (cats.length === 1) return { background: getCategoryById(cats[0]).color };
    const colors = cats.map(id => getCategoryById(id).color);
    const stripes = colors.map((c, i) => `${c} ${(i/colors.length)*100}%, ${c} ${((i+1)/colors.length)*100}%`).join(', ');
    return { background: `linear-gradient(135deg, ${stripes})` };
}

function renderTimeline() {
    const timeline = document.getElementById('timeline');
    const dateKey = getDateKey(currentDate);
    const dayActivities = activities[dateKey] || [];
    
    timeline.innerHTML = '';
    
    // Wskaźnik czasu
    const now = new Date();
    if (getDateKey(now) === dateKey) {
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        const line = document.createElement('div');
        line.className = 'current-time-indicator';
        line.style.top = `${(currentMinutes / 60) * 70}px`;
        timeline.appendChild(line);
    }

    // Grid Godzin
    for (let hour = 0; hour < 24; hour++) {
        timeline.innerHTML += `
            <div class="hour-line">
                <div class="hour-label">${hour.toString().padStart(2, '0')}:00</div>
                <div class="hour-bar" data-hour="${hour}"></div>
            </div>
        `;
    }

    // Sortowanie aktywności do wykrywania luk
    const sortedActivities = [...dayActivities].sort((a,b) => a.startTime.localeCompare(b.startTime));

    // Renderowanie aktywności
    sortedActivities.forEach(activity => {
        const startM = getMinutesFromTime(activity.startTime);
        const endM = getMinutesFromTime(activity.endTime);
        const duration = endM - startM;
        const [startHour, startMin] = activity.startTime.split(':').map(Number);
        
        const startHourBar = timeline.querySelector(`[data-hour="${startHour}"]`);
        if (startHourBar) {
            const block = document.createElement('div');
            block.className = 'activity-block';
            Object.assign(block.style, getActivityStyle(activity));
            
            block.style.top = `${(startMin / 60) * 70}px`;
            block.style.height = `${(duration / 60) * 70}px`;
            if(duration < 15) block.style.minHeight = '20px';
            block.textContent = getDisplayText(activity);
            
            block.addEventListener('click', (e) => {
                e.stopPropagation();
                editActivity(activity);
            });
            startHourBar.appendChild(block);
        }
    });

    // --- WYKRYWANIE LUK (GAPS) ---
    // Pokaż luki tylko dla przeszłości/teraźniejszości
    // Dla uproszczenia: pokazujemy luki na cały dzień, ale można klikać
    let lastTime = 0; // start dnia 00:00
    const endOfDay = 24 * 60;

    sortedActivities.forEach(act => {
        const startM = getMinutesFromTime(act.startTime);
        const endM = getMinutesFromTime(act.endTime);

        if (startM > lastTime) {
            renderGap(timeline, lastTime, startM);
        }
        lastTime = Math.max(lastTime, endM);
    });

    // Ostatnia luka do końca dnia (lub do teraz jeśli to dzisiaj?)
    // Renderujemy do końca, żeby można było planować
    if (lastTime < endOfDay) {
        renderGap(timeline, lastTime, endOfDay);
    }
}

function renderGap(container, startMinutes, endMinutes) {
    // Nie renderuj mikroluk < 5 min
    if (endMinutes - startMinutes < 5) return;

    const startHour = Math.floor(startMinutes / 60);
    const startMinRemainder = startMinutes % 60;
    const height = ((endMinutes - startMinutes) / 60) * 70;

    const hourBar = container.querySelector(`[data-hour="${startHour}"]`);
    if(hourBar) {
        const gap = document.createElement('div');
        gap.className = 'gap-block';
        gap.style.top = `${(startMinRemainder / 60) * 70}px`;
        gap.style.height = `${height}px`;
        
        // Etykieta przy większych lukach
        if(height > 30) {
            gap.innerHTML = '<span class="gap-label">+ Wypełnij</span>';
        }

        gap.addEventListener('click', () => {
            const h1 = getTimeFromMinutes(startMinutes);
            const h2 = getTimeFromMinutes(endMinutes);
            openModalForGap(h1, h2);
        });
        hourBar.appendChild(gap);
    }
}

function renderStats() {
    const statsContainer = document.getElementById('stats');
    const stats = {};
    let totalRecorded = 0;

    // Zbieranie dat
    let datesToProcess = [];
    if (statsMode === 'day') {
        datesToProcess.push(getDateKey(currentDate));
    } else {
        // Ostatnie 7 dni
        for(let i=0; i<7; i++) {
            const d = new Date(currentDate);
            d.setDate(d.getDate() - i);
            datesToProcess.push(getDateKey(d));
        }
    }

    // Agregacja
    datesToProcess.forEach(dateKey => {
        const dayActs = activities[dateKey] || [];
        dayActs.forEach(act => {
            const min = getMinutesFromTime(act.endTime) - getMinutesFromTime(act.startTime);
            totalRecorded += min;
            
            const cats = act.categories || [];
            if (cats.length === 0) {
                if (!stats['inne']) stats['inne'] = { minutes: 0, name: 'Inne / Własne', color: '#bdc3c7' };
                stats['inne'].minutes += min;
            } else {
                cats.forEach(cId => {
                    if(!stats[cId]) {
                        const c = getCategoryById(cId);
                        stats[cId] = { minutes: 0, name: c.name, color: c.color };
                    }
                    stats[cId].minutes += min;
                });
            }
        });
    });

    // Obliczanie "Nieudokumentowane"
    // Dzień = 24h * 60 = 1440 min
    // Ale w trybie tygodniowym to 7 * 1440
    // Opcjonalnie: można to pominąć dla tygodnia, bo robi się bałagan
    let totalPossible = datesToProcess.length * 1440;
    let unrecorded = totalPossible - totalRecorded;

    let html = '';
    
    // Karta sumy
    const hTot = Math.floor(totalRecorded/60);
    const mTot = totalRecorded%60;
    html += `
        <div class="stat-card" style="background:#f9f9f9;">
            <div class="stat-value">${hTot}h ${mTot}m</div>
            <div class="stat-label">Suma Zapisanych</div>
        </div>
    `;

    // Karty kategorii
    Object.values(stats).sort((a,b) => b.minutes - a.minutes).forEach(data => {
        const h = Math.floor(data.minutes / 60);
        const m = data.minutes % 60;
        html += `
            <div class="stat-card">
                <div style="width:10px; height:10px; background:${data.color}; border-radius:50%; margin:0 auto 5px;"></div>
                <div class="stat-value">${h}h ${m}m</div>
                <div class="stat-label">${data.name}</div>
            </div>
        `;
    });

    // Karta Nieudokumentowane
    if(unrecorded > 0) {
        const hUn = Math.floor(unrecorded/60);
        const mUn = unrecorded%60;
        html += `
            <div class="stat-card" style="opacity: 0.6;">
                <div class="stat-value" style="font-size:16px;">${hUn}h ${mUn}m</div>
                <div class="stat-label">Nieudokumentowane</div>
            </div>
        `;
    }

    statsContainer.innerHTML = html;
}

function updateDisplay() {
    document.getElementById('currentDate').textContent = formatDate(currentDate);
    renderTimeline();
    renderStats();
}

// --- MODAL & LOGIC ---

function openModal(editing = false) {
    document.getElementById('modalTitle').textContent = editing ? 'Edytuj Wpis' : 'Nowy Wpis';
    const deleteBtn = document.getElementById('deleteBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    
    deleteBtn.style.display = editing ? 'block' : 'none';
    cancelBtn.style.display = editing ? 'none' : 'block';
    
    document.getElementById('activityModal').classList.add('active');
}

function openModalForGap(start, end) {
    editingActivityId = null;
    document.getElementById('startTime').value = start;
    document.getElementById('endTime').value = end;
    document.getElementById('customDescription').value = '';
    selectedCategories = [];
    renderCategoriesGrid();
    openModal(false);
}

function closeModal() {
    document.getElementById('activityModal').classList.remove('active');
    setTimeout(() => {
        document.getElementById('activityForm').reset();
        document.getElementById('customDescription').value = '';
        editingActivityId = null;
        selectedCategories = [];
        renderCategoriesGrid();
    }, 200);
}

function editActivity(activity) {
    editingActivityId = activity.id;
    document.getElementById('startTime').value = activity.startTime;
    document.getElementById('endTime').value = activity.endTime;
    document.getElementById('customDescription').value = activity.description || '';
    selectedCategories = [...(activity.categories || [])];
    renderCategoriesGrid();
    openModal(true);
}

// --- EVENT LISTENERS ---

document.getElementById('activityForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const desc = document.getElementById('customDescription').value;
    
    if (selectedCategories.length === 0 && desc.trim() === "") {
        alert('Wybierz kategorię LUB wpisz opis.');
        return;
    }
    
    const dateKey = getDateKey(currentDate);
    if (!activities[dateKey]) activities[dateKey] = [];

    const activityData = {
        id: editingActivityId || Date.now(),
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        categories: [...selectedCategories],
        description: desc
    };

    if (editingActivityId) {
        const index = activities[dateKey].findIndex(a => a.id === editingActivityId);
        activities[dateKey][index] = activityData;
    } else {
        activities[dateKey].push(activityData);
    }
    activities[dateKey].sort((a, b) => a.startTime.localeCompare(b.startTime));
    localStorage.setItem('dayTrackerActivities', JSON.stringify(activities));
    updateDisplay();
    closeModal();
});

document.getElementById('deleteBtn').addEventListener('click', () => {
    if (confirm('Usunąć ten wpis?')) {
        const dateKey = getDateKey(currentDate);
        activities[dateKey] = activities[dateKey].filter(a => a.id !== editingActivityId);
        localStorage.setItem('dayTrackerActivities', JSON.stringify(activities));
        updateDisplay();
        closeModal();
    }
});

document.getElementById('addActivityBtn').addEventListener('click', () => {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const m = Math.floor(now.getMinutes() / 15) * 15;
    const minutes = m.toString().padStart(2, '0');
    let endM = m + 30;
    let endH = parseInt(hours);
    if(endM >= 60) { endM -= 60; endH = (endH + 1) % 24; }
    
    document.getElementById('startTime').value = `${hours}:${minutes}`;
    document.getElementById('endTime').value = `${endH.toString().padStart(2,'0')}:${endM.toString().padStart(2,'0')}`;
    openModal(false);
});

document.getElementById('closeModal').addEventListener('click', closeModal);
document.getElementById('cancelBtn').addEventListener('click', closeModal);
document.getElementById('prevDay').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); updateDisplay(); });
document.getElementById('nextDay').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); updateDisplay(); });

// Settings
document.getElementById('openSettingsBtn').addEventListener('click', () => {
    renderSettingsList();
    document.getElementById('settingsModal').classList.add('active');
});
document.getElementById('closeSettings').addEventListener('click', () => {
    document.getElementById('settingsModal').classList.remove('active');
});
document.getElementById('addCatBtn').addEventListener('click', () => {
    const name = document.getElementById('newCatName').value;
    const color = document.getElementById('newCatColor').value;
    if(!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '-');
    categoriesList.push({ id: newId, name: name, color: color });
    document.getElementById('newCatName').value = '';
    saveCategories();
});

// Stats Switch
document.getElementById('statsDayBtn').addEventListener('click', (e) => {
    statsMode = 'day';
    document.getElementById('statsDayBtn').classList.add('active');
    document.getElementById('statsWeekBtn').classList.remove('active');
    renderStats();
});
document.getElementById('statsWeekBtn').addEventListener('click', (e) => {
    statsMode = 'week';
    document.getElementById('statsWeekBtn').classList.add('active');
    document.getElementById('statsDayBtn').classList.remove('active');
    renderStats();
});

// Global helpers
window.deleteCategory = function(id) {
    if(confirm('Usunąć kategorię?')) {
        categoriesList = categoriesList.filter(c => c.id !== id);
        saveCategories();
    }
}
window.exportData = function() {
    const data = { categories: categoriesList, activities: activities, date: new Date().toISOString() };
    const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
    const node = document.createElement('a');
    node.setAttribute("href", str);
    node.setAttribute("download", `dziennik_backup_${getDateKey(new Date())}.json`);
    document.body.appendChild(node);
    node.click();
    node.remove();
}
window.importData = function(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const d = JSON.parse(e.target.result);
            if (d.categories && d.activities && confirm('Nadpisać obecne dane?')) {
                activities = d.activities;
                categoriesList = d.categories;
                saveCategories();
                localStorage.setItem('dayTrackerActivities', JSON.stringify(activities));
                updateDisplay();
                alert('Wczytano!');
            }
        } catch (err) { alert('Błąd pliku'); }
    };
    reader.readAsText(file);
    input.value = '';
}

// Init
renderCategoriesGrid();
updateDisplay();
setTimeout(() => {
    const startHour = document.querySelector('[data-hour="08"]');
    if(startHour) startHour.scrollIntoView({behavior: 'smooth', block: 'center'});
}, 500);

</script>

</body>
</html>
