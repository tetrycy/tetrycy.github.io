<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytor RTF</title>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f3f4f6;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .editor-container {
            min-height: 600px;
            width: 100%;
            max-width: 80rem;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .toolbar {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f9fafb;
        }
        
        .btn {
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            background: #e5e7eb;
        }
        
        .btn.active {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }
        
        .separator {
            width: 1px;
            height: 1.5rem;
            background: #d1d5db;
            margin: 0 0.25rem;
        }
        
        .select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background: white;
        }
        
        .filename {
            margin-left: 1rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .search-panel {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            background: #fef3c7;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }
        
        .search-panel.show {
            display: flex;
        }
        
        .search-input {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            flex: 1;
            max-width: 20rem;
        }
        
        .search-btn {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .search-btn.primary {
            background: #3b82f6;
            color: white;
        }
        
        .search-btn.primary:hover {
            background: #2563eb;
        }
        
        .search-btn.secondary {
            background: #6b7280;
            color: white;
        }
        
        .search-btn.secondary:hover {
            background: #4b5563;
        }
        
        .editor-area {
            flex: 1;
            padding: 1.5rem;
        }
        
        .editor {
            min-height: 100%;
            outline: none;
            color: black;
            line-height: 1.5;
        }
        
        /* Podświetlenie wyszukiwania */
        mark {
            background: yellow;
            padding: 0 2px;
        }
        
        /* TRYB FOCUS */
        .focus-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a1a;
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            overflow: hidden;
        }
        
        .focus-mode.active {
            display: flex;
        }
        
        /* Ukryj wszystko inne w trybie focus */
        body.focus-active > *:not(.focus-mode) {
            display: none !important;
        }
        
        body.focus-active {
            overflow: hidden;
        }
        
        .focus-editor {
            width: 100%;
            max-width: 50rem;
            min-height: 60vh;
            background: transparent;
            border: none;
            outline: none;
            color: #e5e5e5;
            font-size: 18px;
            line-height: 1.8;
            padding: 2rem;
            resize: none;
            font-family: inherit;
            overflow: auto;
        }
        
        .focus-editor::placeholder {
            color: #666;
        }
        
        .focus-mode::-webkit-scrollbar,
        .focus-editor::-webkit-scrollbar {
            display: none;
        }
        
        .focus-mode {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .focus-editor {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .focus-hint {
            position: absolute;
            top: 2rem;
            right: 2rem;
            color: #666;
            font-size: 0.875rem;
        }
        
        .hidden {
            display: none;
        }
        
        /* Wskaźnik zapisu */
        .save-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: #10b981;
            color: white;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="toolbar">
            <button class="btn" id="newBtn" title="Nowy (Ctrl+N)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>
            </button>
            
            <button class="btn" id="openBtn" title="Otwórz (Ctrl+O)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14,2 14,8 20,8"/>
                </svg>
            </button>
            
            <button class="btn" id="saveBtn" title="Zapisz (Ctrl+S)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17,21 17,13 7,13 7,21"/>
                    <polyline points="7,3 7,8 15,8"/>
                </svg>
            </button>
            
            <button class="btn" id="undoBtn" title="Cofnij (Ctrl+Z)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"/>
                    <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <button class="btn" id="focusBtn" title="Tryb Focus (F11)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <select class="select" id="fontSelect" title="Czcionka">
                <option value="Libre Baskerville" selected>Libre Baskerville</option>
                <option value="Times New Roman">Times New Roman</option>
            </select>
            
            <select class="select" id="fontSizeSelect" title="Rozmiar" style="width: 4rem;">
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12" selected>12</option>
                <option value="14">14</option>
                <option value="16">16</option>
                <option value="18">18</option>
                <option value="20">20</option>
                <option value="24">24</option>
                <option value="28">28</option>
                <option value="32">32</option>
                <option value="36">36</option>
            </select>
            
            <select class="select" id="speechRateSelect" title="Szybkość czytania" style="width: 4rem;">
                <option value="0.75">0.75x</option>
                <option value="1.0" selected>1.0x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2.0">2.0x</option>
            </select>
            
            <div class="separator"></div>
            
            <button class="btn" id="readBtn" title="Czytaj od miejsca kursora (Ctrl+R)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            </button>
            
            <div class="separator"></div>
            
            <button class="btn" id="searchBtn" title="Wyszukaj (Ctrl+F)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            </button>
            
            <div class="filename" id="fileName">dokument.rtf</div>
        </div>
        
        <div class="search-panel" id="searchPanel">
            <input type="text" class="search-input" id="searchInput" placeholder="Wyszukaj...">
            <button class="search-btn primary" id="findBtn">Znajdź</button>
            <button class="search-btn primary" id="findNextBtn">Następny</button>
            <button class="search-btn secondary" id="clearSearchBtn">Wyczyść</button>
            <button class="search-btn secondary" id="closeSearchBtn">Zamknij</button>
        </div>
        
        <div class="editor-area">
            <div class="editor" id="editor" contenteditable="true">
                <p>Zacznij pisać swój dokument...</p>
            </div>
        </div>
        
        <input type="file" class="hidden" id="fileInput" accept=".rtf,.txt">
    </div>

    <!-- TRYB FOCUS -->
    <div class="focus-mode" id="focusMode">
        <div class="focus-hint">ESC aby wyjść</div>
        <textarea class="focus-editor" id="focusEditor" placeholder="Pisz swobodnie..."></textarea>
    </div>
    
    <!-- Wskaźnik zapisu -->
    <div class="save-indicator" id="saveIndicator">Zapisano</div>

    <script>
        let editor, fileName, isReading, fontFamily, fontSize, speechRate, isFocusMode, undoHistory, historyIndex;
        let saveStateTimeout, currentSearchIndex = -1, searchMatches = [];
        
        function init() {
            editor = document.getElementById('editor');
            fileName = 'dokument.rtf';
            isReading = false;
            fontFamily = 'Libre Baskerville';
            fontSize = 12;
            speechRate = 1.0;
            isFocusMode = false;
            undoHistory = [];
            historyIndex = -1;
            
            // Zapisz początkowy stan
            saveState();
            
            // Przypisz event handlers
            document.getElementById('newBtn').onclick = newDoc;
            document.getElementById('openBtn').onclick = openDoc;
            document.getElementById('saveBtn').onclick = saveDoc;
            document.getElementById('undoBtn').onclick = undo;
            document.getElementById('searchBtn').onclick = toggleSearch;
            document.getElementById('readBtn').onclick = toggleReading;
            document.getElementById('focusBtn').onclick = toggleFocusMode;
            
            document.getElementById('fontSelect').onchange = function() { 
                fontFamily = this.value; 
                updateStyle();
            };
            document.getElementById('fontSizeSelect').onchange = function() { 
                fontSize = parseInt(this.value); 
                updateStyle();
            };
            document.getElementById('speechRateSelect').onchange = function() { 
                speechRate = parseFloat(this.value); 
            };
            
            document.getElementById('findBtn').onclick = doSearch;
            document.getElementById('findNextBtn').onclick = findNext;
            document.getElementById('clearSearchBtn').onclick = clearSearch;
            document.getElementById('closeSearchBtn').onclick = toggleSearch;
            document.getElementById('searchInput').onkeydown = function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (searchMatches.length > 0) {
                        findNext();
                    } else {
                        doSearch();
                    }
                }
            };
            
            document.getElementById('fileInput').onchange = loadFile;
            document.onkeydown = keyHandler;
            
            // Nasłuchuj zmian w edytorze z debouncingiem
            editor.addEventListener('input', debouncedSaveState);
            
            // Załaduj głosy Text-to-Speech
            if (window.speechSynthesis) {
                speechSynthesis.onvoiceschanged = function() {
                    console.log('Głosy TTS załadowane:', speechSynthesis.getVoices().length);
                };
                // Wymuś załadowanie głosów
                speechSynthesis.getVoices();
            }
            
            // Obsługa fullscreen events
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            
            updateStyle();
        }
        
        function debouncedSaveState() {
            clearTimeout(saveStateTimeout);
            saveStateTimeout = setTimeout(saveState, 300);
        }
        
        function saveState() {
            const currentState = editor.innerHTML;
            
            // Jeśli to jest nowy stan (różny od poprzedniego)
            if (undoHistory.length === 0 || undoHistory[historyIndex] !== currentState) {
                // Usuń wszystkie stany po aktualnym indeksie
                undoHistory = undoHistory.slice(0, historyIndex + 1);
                
                // Dodaj nowy stan
                undoHistory.push(currentState);
                historyIndex = undoHistory.length - 1;
                
                // Ogranicz historię do 50 stanów
                if (undoHistory.length > 50) {
                    undoHistory = undoHistory.slice(-50);
                    historyIndex = undoHistory.length - 1;
                }
            }
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                editor.innerHTML = undoHistory[historyIndex];
                
                // Przywróć focus
                editor.focus();
                
                // Umieść kursor na końcu
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(editor);
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        
        function keyHandler(e) {
            if (e.ctrlKey) {
                switch(e.key.toLowerCase()) {
                    case 'n': e.preventDefault(); newDoc(); break;
                    case 's': e.preventDefault(); saveDoc(); break;
                    case 'o': e.preventDefault(); openDoc(); break;
                    case 'f': e.preventDefault(); toggleSearch(); break;
                    case 'r': e.preventDefault(); toggleReading(); break;
                    case 'z': e.preventDefault(); undo(); break;
                }
            }
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFocusMode();
            }
            if (e.key === 'Escape') {
                if (isFocusMode) {
                    exitFocusMode();
                } else {
                    closeSearch();
                    if (isReading) stopReading();
                }
            }
        }
        
        function newDoc() {
            if (confirm('Czy na pewno chcesz utworzyć nowy dokument? Niezapisane zmiany zostaną utracone.')) {
                editor.innerHTML = '<p>Zacznij pisać swój dokument...</p>';
                fileName = 'dokument.rtf';
                document.getElementById('fileName').textContent = fileName;
                
                // Reset historii
                undoHistory = [];
                historyIndex = -1;
                saveState();
            }
        }
        
        function openDoc() {
            document.getElementById('fileInput').click();
        }
        
        function saveDoc() {
            const html = editor.innerHTML;
            const rtf = toRTF(html);
            const blob = new Blob([rtf], { type: 'application/rtf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
            
            // Pokaż wskaźnik zapisu
            showSaveIndicator();
        }
        
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }
        
        function loadFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Sprawdź rozmiar pliku
            if (file.size > 10 * 1024 * 1024) {
                alert('Plik jest zbyt duży (maksymalnie 10MB)');
                e.target.value = '';
                return;
            }
            
            fileName = file.name;
            document.getElementById('fileName').textContent = fileName;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const html = fileName.endsWith('.rtf') ? fromRTF(content) : textToHtml(content);
                    editor.innerHTML = html;
                    
                    // Reset historii i zapisz nowy stan
                    undoHistory = [];
                    historyIndex = -1;
                    saveState();
                } catch (error) {
                    console.error('Błąd wczytywania pliku:', error);
                    alert('Wystąpił błąd podczas wczytywania pliku');
                }
            };
            reader.onerror = function() {
                alert('Błąd odczytu pliku');
            };
            reader.readAsText(file, 'utf-8');
            
            // Reset input
            e.target.value = '';
        }
        
        function textToHtml(text) {
            return '<p>' + text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
        }
        
        function toggleSearch() {
            const panel = document.getElementById('searchPanel');
            const btn = document.getElementById('searchBtn');
            if (panel.classList.contains('show')) {
                closeSearch();
            } else {
                panel.classList.add('show');
                btn.classList.add('active');
                document.getElementById('searchInput').focus();
                document.getElementById('searchInput').select();
            }
        }
        
        function closeSearch() {
            document.getElementById('searchPanel').classList.remove('show');
            document.getElementById('searchBtn').classList.remove('active');
            clearSearch();
        }
        
        function clearSearch() {
            // Usuń wszystkie znaczniki
            let content = editor.innerHTML;
            content = content.replace(/<mark[^>]*>/gi, '').replace(/<\/mark>/gi, '');
            editor.innerHTML = content;
            searchMatches = [];
            currentSearchIndex = -1;
        }
        
        function doSearch() {
            const term = document.getElementById('searchInput').value;
            if (!term) return;
            
            clearSearch();
            
            const text = editor.innerText || '';
            const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            let match;
            
            while ((match = regex.exec(text)) !== null) {
                searchMatches.push(match.index);
            }
            
            if (searchMatches.length > 0) {
                highlightSearchResults(term);
                currentSearchIndex = 0;
                scrollToMatch(0);
                alert(`Znaleziono ${searchMatches.length} wyników`);
            } else {
                alert('Nie znaleziono wyników');
            }
        }
        
        function highlightSearchResults(term) {
            let content = editor.innerHTML;
            const regex = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            content = content.replace(regex, '<mark>$1</mark>');
            editor.innerHTML = content;
        }
        
        function findNext() {
            if (searchMatches.length === 0) {
                doSearch();
                return;
            }
            
            currentSearchIndex = (currentSearchIndex + 1) % searchMatches.length;
            scrollToMatch(currentSearchIndex);
        }
        
        function scrollToMatch(index) {
            const marks = editor.querySelectorAll('mark');
            if (marks[index]) {
                marks[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Podświetl aktualny wynik
                marks.forEach(m => m.style.background = 'yellow');
                marks[index].style.background = 'orange';
            }
        }
        
        function updateStyle() {
            const family = fontFamily === 'Times New Roman' ? 'Times New Roman, serif' : 'Libre Baskerville, serif';
            editor.style.fontFamily = family;
            editor.style.fontSize = fontSize + 'pt';
        }
        
        function getCursor() {
            const sel = window.getSelection();
            if (sel.rangeCount === 0) return 0;
            const range = sel.getRangeAt(0);
            const pre = range.cloneRange();
            pre.selectNodeContents(editor);
            pre.setEnd(range.startContainer, range.startOffset);
            return pre.toString().length;
        }
        
        function getTextFromCursor() {
            const fullText = editor.innerText || '';
            const cursorPos = getCursor();
            return fullText.substring(cursorPos);
        }
        
        function toggleReading() {
            if (isReading) {
                stopReading();
            } else {
                startReading();
            }
        }
        
        function startReading() {
            if (!window.speechSynthesis) {
                alert('Twoja przeglądarka nie obsługuje czytania tekstu.');
                return;
            }
            
            const text = getTextFromCursor();
            if (!text.trim()) {
                alert('Brak tekstu do czytania od pozycji kursora.');
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pl-PL';
            utterance.rate = speechRate;
            utterance.pitch = 1;
            
            // Wybierz polski głos
            const voices = speechSynthesis.getVoices();
            const polishVoice = voices.find(voice => voice.lang.includes('pl'));
            if (polishVoice) {
                utterance.voice = polishVoice;
                console.log('Używam głosu:', polishVoice.name);
            }
            
            const btn = document.getElementById('readBtn');
            
            utterance.onstart = function() {
                isReading = true;
                btn.classList.add('active');
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
            };
            
            utterance.onend = function() {
                stopReading();
            };
            
            utterance.onerror = function(e) {
                console.error('Błąd TTS:', e);
                stopReading();
                alert('Wystąpił błąd podczas czytania tekstu.');
            };
            
            try {
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Błąd rozpoczęcia czytania:', error);
                alert('Nie udało się rozpocząć czytania.');
            }
        }
        
        function stopReading() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            isReading = false;
            const btn = document.getElementById('readBtn');
            btn.classList.remove('active');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
        }
        
        function toRTF(html) {
            const font = fontFamily === 'Times New Roman' ? 'Times New Roman' : 'Libre Baskerville';
            let rtf = '{\\rtf1\\ansi\\ansicpg1250\\deff0 {\\fonttbl {\\f0 ' + font + ';}}\\f0\\fs' + (fontSize * 2) + ' ';
            
            let cleanText = html
                .replace(/<mark[^>]*>/gi, '') // Usuń znaczniki wyszukiwania
                .replace(/<\/mark>/gi, '')
                .replace(/<br\s*\/?>/gi, '\\line ')
                .replace(/<\/p>/gi, '\\par ')
                .replace(/<p[^>]*>/gi, '')
                .replace(/<b[^>]*>(.*?)<\/b>/gi, '{\\b $1}')
                .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '{\\b $1}')
                .replace(/<i[^>]*>(.*?)<\/i>/gi, '{\\i $1}')
                .replace(/<em[^>]*>(.*?)<\/em>/gi, '{\\i $1}')
                .replace(/<u[^>]*>(.*?)<\/u>/gi, '{\\ul $1}')
                .replace(/<[^>]+>/g, '');
            
            // Konwersja polskich znaków
            cleanText = cleanText
                .replace(/ą/g, "\\'b1")
                .replace(/Ą/g, "\\'a1")
                .replace(/ć/g, "\\'e6")
                .replace(/Ć/g, "\\'c6")
                .replace(/ę/g, "\\'ea")
                .replace(/Ę/g, "\\'ca")
                .replace(/ł/g, "\\'b3")
                .replace(/Ł/g, "\\'a3")
                .replace(/ń/g, "\\'f1")
                .replace(/Ń/g, "\\'d1")
                .replace(/ó/g, "\\'f3")
                .replace(/Ó/g, "\\'d3")
                .replace(/ś/g, "\\'9c")
                .replace(/Ś/g, "\\'8c")
                .replace(/ź/g, "\\'9f")
                .replace(/Ź/g, "\\'8f")
                .replace(/ż/g, "\\'bf")
                .replace(/Ż/g, "\\'af");
            
            rtf += cleanText + '}';
            return rtf;
        }
        
        function fromRTF(rtf) {
            try {
                // Sprawdź czy to rzeczywiście RTF
                if (!rtf || rtf.indexOf('{\\rtf') !== 0) {
                    // Traktuj jako zwykły tekst
                    return textToHtml(rtf || '');
                }
                
                let text = rtf;
                
                // Oznacz miejsca podziału akapitów
                text = text.replace(/\\par\s*/g, '|||PARAGRAPH|||');
                text = text.replace(/\\line\s*/g, '|||LINEBREAK|||');
                
                // Konwertuj polskie znaki - wszystkie warianty
                text = text
                    // ą/Ą
                    .replace(/\\'b1/g, 'ą').replace(/'b1/g, 'ą').replace(/\\u185\?/g, 'ą')
                    .replace(/\\'a1/g, 'Ą').replace(/'a1/g, 'Ą').replace(/\\u260\?/g, 'Ą')
                    // ć/Ć  
                    .replace(/\\'e6/g, 'ć').replace(/'e6/g, 'ć').replace(/\\u263\?/g, 'ć')
                    .replace(/\\'c6/g, 'Ć').replace(/'c6/g, 'Ć').replace(/\\u262\?/g, 'Ć')
                    // ę/Ę
                    .replace(/\\'ea/g, 'ę').replace(/'ea/g, 'ę').replace(/\\u281\?/g, 'ę')
                    .replace(/\\'ca/g, 'Ę').replace(/'ca/g, 'Ę').replace(/\\u280\?/g, 'Ę')
                    // ł/Ł
                    .replace(/\\'b3/g, 'ł').replace(/'b3/g, 'ł').replace(/\\u322\?/g, 'ł')
                    .replace(/\\'a3/g, 'Ł').replace(/'a3/g, 'Ł').replace(/\\u321\?/g, 'Ł')
                    // ń/Ń
                    .replace(/\\'f1/g, 'ń').replace(/'f1/g, 'ń').replace(/\\u324\?/g, 'ń')
                    .replace(/\\'d1/g, 'Ń').replace(/'d1/g, 'Ń').replace(/\\u323\?/g, 'Ń')
                    // ó/Ó
                    .replace(/\\'f3/g, 'ó').replace(/'f3/g, 'ó').replace(/\\u243\?/g, 'ó')
                    .replace(/\\'d3/g, 'Ó').replace(/'d3/g, 'Ó').replace(/\\u211\?/g, 'Ó')
                    // ś/Ś
                    .replace(/\\'9c/g, 'ś').replace(/'9c/g, 'ś').replace(/\\u347\?/g, 'ś')
                    .replace(/\\'8c/g, 'Ś').replace(/'8c/g, 'Ś').replace(/\\u346\?/g, 'Ś')
                    // ź/Ź
                    .replace(/\\'9f/g, 'ź').replace(/'9f/g, 'ź').replace(/\\u378\?/g, 'ź')
                    .replace(/\\'8f/g, 'Ź').replace(/'8f/g, 'Ź').replace(/\\u377\?/g, 'Ź')
                    // ż/Ż
                    .replace(/\\'bf/g, 'ż').replace(/'bf/g, 'ż').replace(/\\u380\?/g, 'ż')
                    .replace(/\\'af/g, 'Ż').replace(/'af/g, 'Ż').replace(/\\u379\?/g, 'Ż')
                    // Znaki interpunkcyjne
                    .replace(/\\'84/g, '"').replace(/'84/g, '"')
                    .replace(/\\'94/g, '"').replace(/'94/g, '"')
                    .replace(/\\'96/g, '–').replace(/'96/g, '–')
                    .replace(/\\'97/g, '—').replace(/'97/g, '—');
                
                // Usuń główne znaczniki RTF
                text = text.replace(/^\{\\rtf[^{}]*/, '');
                text = text.replace(/\}$/, '');
                
                // Usuń wszystkie pozostałe kody sterujące RTF
                text = text.replace(/\\[a-z]+\d*\s*/gi, ' ');
                text = text.replace(/\{[^}]*\}/g, '');
                text = text.replace(/\\/g, '');
                
                // Wyczyść dodatkowe spacje
                text = text.replace(/\s+/g, ' ').trim();
                
                // Usuń nawiasy klamrowe
                text = text.replace(/^\{+/, '').replace(/\}+$/, '');
                
                // Podziel na akapity używając markerów
                const paragraphs = text.split('|||PARAGRAPH|||');
                let html = '';
                
                for (let i = 0; i < paragraphs.length; i++) {
                    let para = paragraphs[i].trim();
                    if (para && para.length > 3) {
                        // Obsłuż line breaks wewnątrz akapitu
                        para = para.replace(/\|\|\|LINEBREAK\|\|\|/g, '<br>');
                        html += '<p>' + para + '</p>';
                    }
                }
                
                // Jeśli nie udało się przetworzyć, zwróć jako tekst
                if (!html) {
                    html = textToHtml(text.replace(/\|\|\|PARAGRAPH\|\|\|/g, '\n').replace(/\|\|\|LINEBREAK\|\|\|/g, '\n'));
                }
                
                return html;
                
            } catch (error) {
                console.error('Błąd parsowania RTF:', error);
                // W przypadku błędu zwróć jako zwykły tekst
                return textToHtml(rtf.replace(/[{}\\\n]/g, ' '));
            }
        }
        
        function toggleFocusMode() {
            if (isFocusMode) {
                exitFocusMode();
            } else {
                enterFocusMode();
            }
        }
        
        function enterFocusMode() {
            isFocusMode = true;
            
            // Dodaj klasę do body
            document.body.classList.add('focus-active');
            
            const focusEditor = document.getElementById('focusEditor');
            focusEditor.value = editor.innerText || '';
            
            // Ustaw styl czcionki
            const family = fontFamily === 'Times New Roman' ? 'Times New Roman, serif' : 'Libre Baskerville, serif';
            focusEditor.style.fontFamily = family;
            
            const focusMode = document.getElementById('focusMode');
            focusMode.classList.add('active');
            
            // Listener dla synchronizacji
            focusEditor.addEventListener('input', focusInputHandler);
            
            // Spróbuj wejść w tryb pełnoekranowy
            setTimeout(function() {
                const elem = document.documentElement;
                
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.log('Nie można wejść w tryb pełnoekranowy:', err);
                    });
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                }
                
                // Focus na edytorze
                setTimeout(() => focusEditor.focus(), 100);
                
            }, 50);
        }
        
        function focusInputHandler() {
            const focusEditor = document.getElementById('focusEditor');
            const lines = focusEditor.value.split('\n');
            const html = lines.map(line => line.trim() ? `<p>${line}</p>` : '<p><br></p>').join('');
            editor.innerHTML = html || '<p><br></p>';
            debouncedSaveState();
        }
        
        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                  document.mozFullScreenElement || document.msFullscreenElement);
            
            if (!isFullscreen && isFocusMode) {
                exitFocusMode();
            }
        }
        
        function exitFocusMode() {
            if (!isFocusMode) return;
            
            isFocusMode = false;
            
            // Usuń klasę z body
            document.body.classList.remove('focus-active');
            
            // Usuń listener
            const focusEditor = document.getElementById('focusEditor');
            focusEditor.removeEventListener('input', focusInputHandler);
            
            // Wyjście z fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => {
                    console.log('Błąd wyjścia z fullscreen:', err);
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            }
            
            // Ukryj tryb focus
            document.getElementById('focusMode').classList.remove('active');
            
            // Ostatnia synchronizacja
            if (focusEditor.value.trim()) {
                const htmlContent = '<p>' + focusEditor.value.replace(/\n\s*\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
                editor.innerHTML = htmlContent;
                saveState();
            }
            
            // Przywróć focus do głównego edytora
            setTimeout(() => editor.focus(), 200);
        }
        
        // Inicjalizacja po załadowaniu DOM
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
