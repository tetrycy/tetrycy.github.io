<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OUTPOST: WASTELAND PROTOCOL</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --fallout-green: #20ff20;
            --fallout-bg: #050a05;
            --crt-glow: rgba(32, 255, 32, 0.1);
        }

        body {
            margin: 0; padding: 0; background: #000;
            color: var(--fallout-green); font-family: 'VT323', monospace;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* Widok terminala z zakrzywieniem */
        #viewport {
            flex-grow: 1; position: relative;
            background: #000; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        #viewport::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 10;
        }

        canvas {
            border: 4px solid #222;
            image-rendering: pixelated;
            box-shadow: 0 0 40px var(--crt-glow);
            background: #101510;
        }

        /* Sidebar Styl Pip-Boy */
        #sidebar {
            width: 320px; background: #1a1f1a;
            border-left: 5px solid #333;
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: -10px 0 30px #000; z-index: 20;
        }

        .screen {
            background: #020802; border: 2px solid var(--fallout-green);
            padding: 15px; margin-bottom: 20px; position: relative;
            box-shadow: inset 0 0 15px #000;
        }

        .btn {
            background: transparent; color: var(--fallout-green);
            border: 1px solid var(--fallout-green); padding: 12px;
            margin: 6px 0; cursor: pointer; font-family: 'VT323';
            font-size: 1.4em; text-align: left; text-transform: uppercase;
        }

        .btn:hover { background: var(--fallout-green); color: #000; }
        .btn.active { background: #082a08; border-left: 8px solid var(--fallout-green); }

        .stat { display: flex; justify-content: space-between; font-size: 1.5em; margin-bottom: 5px; }

        #msg { 
            position: absolute; top: 30px; width: 100%; text-align: center;
            font-size: 1.8em; text-shadow: 0 0 10px var(--fallout-green);
            pointer-events: none; z-index: 5;
        }
    </style>
</head>
<body>

<div id="viewport">
    <div id="msg">INITIALIZING VAULT-TEC BOOTLOADER...</div>
    <canvas id="gameCanvas" width="900" height="750"></canvas>
</div>

<div id="sidebar">
    <h2 style="text-align: center; border-bottom: 2px solid var(--fallout-green); padding-bottom: 10px;">V13 INTERFACE</h2>
    
    <div class="screen">
        <div class="stat"><span>CAPS:</span> <span id="caps">1000</span></div>
        <div class="stat"><span>PWR:</span> <span id="pwr">STABLE</span></div>
        <div class="stat"><span>HULL:</span> <span id="hp">100%</span></div>
    </div>

    <div id="buildMenu"></div>

    <button class="btn" id="waveBtn" onclick="initiateDefense()" style="margin-top:auto; background:#103010; font-weight:bold;">ENTER COMBAT MODE</button>
</div>

<script>
// --- KONFIGURACJA ISO ---
const ISO = {
    TILE_W: 72, TILE_H: 36,
    GRID: 12, OFF_X: 450, OFF_Y: 100
};

const SCHEMATICS = {
    POWER: { name: "GENERATOR", cost: 250, color: "#3a3a3a", h: 30, power: 100 },
    WELL: { name: "WATER PUMP", cost: 300, color: "#506080", h: 25, power: -20 },
    TURRET: { name: "SENTRY GUN", cost: 500, color: "#2d3a2d", h: 50, power: -50 }
};

let game = {
    money: 800, buildings: [], enemies: [], corpses: [], 
    debris: [], // Pęknięcia ziemi, trawa
    mode: 'BUILD', selected: null, hp: 100, 
    mouseGrid: {x:0, y:0}, shake: 0
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function toIso(x, y) {
    return {
        x: (x - y) * (ISO.TILE_W / 2) + ISO.OFF_X,
        y: (x + y) * (ISO.TILE_H / 2) + ISO.OFF_Y
    };
}

function fromIso(sx, sy) {
    let dx = sx - ISO.OFF_X;
    let dy = sy - ISO.OFF_Y;
    return {
        x: Math.floor((dy / (ISO.TILE_H / 2) + dx / (ISO.TILE_W / 2)) / 2),
        y: Math.floor((dy / (ISO.TILE_H / 2) - dx / (ISO.TILE_W / 2)) / 2)
    };
}

// --- GRAFIKA ---
function drawIsoTile(gx, gy, type) {
    let p = toIso(gx, gy);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x + ISO.TILE_W/2, p.y + ISO.TILE_H/2);
    ctx.lineTo(p.x, p.y + ISO.TILE_H);
    ctx.lineTo(p.x - ISO.TILE_W/2, p.y + ISO.TILE_H/2);
    ctx.closePath();
    
    // Brudny kolor ziemi
    ctx.fillStyle = (gx + gy) % 2 === 0 ? "#1a1d15" : "#1d2018";
    if(gx === game.mouseGrid.x && gy === game.mouseGrid.y) ctx.fillStyle = "#2a3a2a";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.2)";
    ctx.stroke();
}

function drawBuilding(b) {
    let p = toIso(b.gx, b.gy);
    let w = ISO.TILE_W / 2;
    
    // 1. DŁUGI CIEŃ (Cast Shadow)
    ctx.fillStyle = "rgba(0,0,0,0.3)";
    ctx.beginPath();
    ctx.moveTo(p.x, p.y + ISO.TILE_H/2);
    ctx.lineTo(p.x + w + b.h*0.8, p.y + ISO.TILE_H - b.h*0.4);
    ctx.lineTo(p.x + b.h*0.8, p.y + ISO.TILE_H*1.5 - b.h*0.4);
    ctx.lineTo(p.x - w, p.y + ISO.TILE_H);
    ctx.fill();

    // 2. STRUKTURA (Pseudo-3D)
    // Lewa ściana (Ciemna)
    ctx.fillStyle = shadeColor(b.color, -30);
    ctx.beginPath();
    ctx.moveTo(p.x - w, p.y + ISO.TILE_H/2);
    ctx.lineTo(p.x, p.y + ISO.TILE_H);
    ctx.lineTo(p.x, p.y + ISO.TILE_H - b.h);
    ctx.lineTo(p.x - w, p.y + ISO.TILE_H/2 - b.h);
    ctx.fill();

    // Prawa ściana (Bardzo ciemna)
    ctx.fillStyle = shadeColor(b.color, -50);
    ctx.beginPath();
    ctx.moveTo(p.x + w, p.y + ISO.TILE_H/2);
    ctx.lineTo(p.x, p.y + ISO.TILE_H);
    ctx.lineTo(p.x, p.y + ISO.TILE_H - b.h);
    ctx.lineTo(p.x + w, p.y + ISO.TILE_H/2 - b.h);
    ctx.fill();

    // Dach (Teksturowany szumem)
    ctx.fillStyle = b.color;
    ctx.beginPath();
    ctx.moveTo(p.x, p.y - b.h);
    ctx.lineTo(p.x + w, p.y + ISO.TILE_H/2 - b.h);
    ctx.lineTo(p.x, p.y + ISO.TILE_H - b.h);
    ctx.lineTo(p.x - w, p.y + ISO.TILE_H/2 - b.h);
    ctx.fill();

    // Szum/Rdza na dachu
    ctx.fillStyle = "rgba(255,255,255,0.05)";
    for(let i=0; i<10; i++) ctx.fillRect(p.x - 10 + Math.random()*20, p.y - b.h + Math.random()*15, 2, 2);
}

// --- LOGIKA ---
function init() {
    // Generuj detale otoczenia (trawa, pęknięcia)
    for(let i=0; i<30; i++) {
        game.debris.push({ gx: Math.random()*ISO.GRID, gy: Math.random()*ISO.GRID, type: Math.random() > 0.5 ? 'grass' : 'crack' });
    }

    canvas.addEventListener('mousemove', e => {
        const r = canvas.getBoundingClientRect();
        game.mouseGrid = fromIso((e.clientX - r.left)*(900/r.width), (e.clientY - r.top)*(750/r.height));
    });

    canvas.addEventListener('mousedown', () => {
        if(game.mode === 'BUILD' && game.selected) {
            const cfg = SCHEMATICS[game.selected];
            if(game.money >= cfg.cost && game.mouseGrid.x >= 0 && game.mouseGrid.x < ISO.GRID && game.mouseGrid.y >= 0 && game.mouseGrid.y < ISO.GRID) {
                game.buildings.push({ ...cfg, gx: game.mouseGrid.x, gy: game.mouseGrid.y, lastShot: 0 });
                game.money -= cfg.cost;
            }
        }
    });

    const menu = document.getElementById('buildMenu');
    for(let key in SCHEMATICS) {
        let btn = document.createElement('button');
        btn.className = 'btn'; btn.innerHTML = `${SCHEMATICS[key].name} <span style="float:right">${SCHEMATICS[key].cost}</span>`;
        btn.onclick = () => { game.selected = key; document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); };
        menu.appendChild(btn);
    }

    gameLoop();
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if(game.shake > 0) { ctx.translate(Math.random()*game.shake, Math.random()*game.shake); game.shake *= 0.9; }

    // 1. Podłoże
    for(let gy=0; gy<ISO.GRID; gy++) {
        for(let gx=0; gx<ISO.GRID; gx++) drawIsoTile(gx, gy);
    }

    // 2. Dekale (Trawa/Krew)
    game.debris.forEach(d => {
        let p = toIso(d.gx, d.gy);
        ctx.fillStyle = d.type === 'grass' ? "#2a3a1a" : "#111";
        ctx.fillRect(p.x, p.y + 15, 3, 3);
    });
    game.corpses.forEach(c => {
        let p = toIso(c.gx, c.gy);
        ctx.fillStyle = "#400"; ctx.beginPath(); ctx.arc(p.x, p.y+15, 6, 0, Math.PI*2); ctx.fill();
    });

    // 3. Sortowanie obiektów
    let objects = [...game.buildings, ...game.enemies];
    objects.sort((a,b) => (a.gx + a.gy) - (b.gx + b.gy));

    objects.forEach(obj => {
        if(obj.name) drawBuilding(obj);
        else drawEnemy(obj);
    });

    // Walka
    if(game.mode === 'DEFENSE') {
        game.buildings.forEach(b => {
            if(b.name === "SENTRY GUN") {
                let target = game.enemies.find(e => Math.hypot(e.gx - b.gx, e.gy - b.gy) < 4);
                if(target && Date.now() - b.lastShot > 400) {
                    shoot(b, target);
                    b.lastShot = Date.now();
                }
            }
        });
        updateEnemies();
    }

    document.getElementById('caps').innerText = game.money;
    document.getElementById('hp').innerText = game.hp + "%";

    ctx.setTransform(1,0,0,1,0,0);
    requestAnimationFrame(gameLoop);
}

function drawEnemy(e) {
    let p = toIso(e.gx, e.gy);
    ctx.fillStyle = "#800"; // Mutant Red
    ctx.beginPath(); ctx.arc(p.x, p.y + 15, 10, 0, Math.PI*2); ctx.fill();
    // Pasek życia
    ctx.fillStyle = "#f00"; ctx.fillRect(p.x - 10, p.y - 10, 20, 3);
    ctx.fillStyle = "#0f0"; ctx.fillRect(p.x - 10, p.y - 10, (e.hp/100)*20, 3);
}

function shoot(t, e) {
    let p1 = toIso(t.gx, t.gy); let p2 = toIso(e.gx, e.gy);
    ctx.strokeStyle = "#ff0"; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(p1.x, p1.y - t.h); ctx.lineTo(p2.x, p2.y + 10); ctx.stroke();
    e.hp -= 25;
    if(e.hp <= 0) {
        game.corpses.push({gx: e.gx, gy: e.gy});
        game.enemies = game.enemies.filter(item => item !== e);
        game.money += 20;
    }
    game.shake = 2;
}

function updateEnemies() {
    game.enemies.forEach((e, i) => {
        e.gx += 0.015; e.gy += 0.015;
        if(e.gx > ISO.GRID) { game.hp -= 5; game.enemies.splice(i, 1); }
    });
    if(game.enemies.length === 0) { game.mode = 'BUILD'; document.getElementById('msg').innerText = "SECTOR SECURED."; }
}

function initiateDefense() {
    game.mode = 'DEFENSE';
    document.getElementById('msg').innerText = "HOSTILE RAD-MUTANTS DETECTED!";
    for(let i=0; i<8; i++) game.enemies.push({ gx: -Math.random()*4, gy: -Math.random()*4, hp: 100 });
}

function shadeColor(color, percent) {
    let num = parseInt(color.replace("#",""),16), amt = Math.round(2.55 * percent), R = (num >> 16) + amt, G = (num >> 8 & 0x00FF) + amt, B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 + (R<255?R<0?0:R:255)*0x10000 + (G<255?G<0?0:G:255)*0x100 + (B<255?B<0?0:B:255)).toString(16).slice(1);
}

init();
</script>
</body>
</html>
