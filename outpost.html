<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OUTPOST: RED ALERT PROTOCOL</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ra2-metal: #5a6e7d;
            --ra2-metal-dark: #3a4e5d;
            --ra2-green: #00ff00;
            --ra2-red: #ff0000;
            --ra2-bg: #1a1a1a;
            --sidebar-width: 260px;
        }

        body {
            margin: 0; padding: 0; background: #000;
            height: 100vh; font-family: 'Chakra Petch', sans-serif;
            color: var(--ra2-green); display: flex; overflow: hidden;
        }

        #gameViewport {
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
            background-color: #242b1e; background-image: radial-gradient(#343b2e 1px, transparent 1px);
            background-size: 20px 20px; position: relative;
        }

        canvas { background: rgba(0,0,0,0.2); cursor: crosshair; }

        /* Sidebar RA2 Style */
        #sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(to right, var(--ra2-metal-dark), var(--ra2-metal));
            border-left: 4px ridge var(--ra2-metal);
            display: flex; flex-direction: column; padding: 10px; box-sizing: border-box;
        }

        #powerSection {
            height: 180px; background: #000; border: 3px inset #333;
            margin-bottom: 15px; position: relative; overflow: hidden;
        }

        #powerIndicator {
            position: absolute; bottom: 0; width: 100%;
            background: linear-gradient(to top, #f00, #ff0, #0f0);
            transition: height 0.4s ease-in-out;
        }

        .ra2-panel { background: rgba(0,0,0,0.5); border: 2px solid var(--ra2-metal); padding: 8px; margin-bottom: 10px; }

        .build-btn {
            background: linear-gradient(to bottom, #4a5e6d, #2a3e4d);
            border: 2px outset var(--ra2-metal); padding: 10px; margin: 4px 0;
            cursor: pointer; color: #fff; font-weight: bold; font-size: 0.9em;
            display: flex; justify-content: space-between;
        }

        .build-btn:hover { filter: brightness(1.2); }
        .build-btn.selected { border-color: var(--ra2-green); box-shadow: 0 0 10px var(--ra2-green); }

        #msgLog { position: absolute; top: 20px; left: 20px; color: var(--ra2-red); font-weight: bold; }
    </style>
</head>
<body>

<div id="gameViewport">
    <div id="msgLog"></div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
</div>

<div id="sidebar">
    <div style="text-align:center; font-size:0.8em; margin-bottom:4px;">POWER OUTPUT</div>
    <div id="powerSection">
        <div id="powerIndicator" style="height: 50%;"></div>
    </div>
    
    <div class="ra2-panel">
        <div style="display:flex; justify-content:space-between;">
            <span>CREDITS:</span><span id="statMoney">$0</span>
        </div>
    </div>

    <div class="ra2-panel" id="buildMenu">
        <div style="border-bottom: 1px solid var(--ra2-green); margin-bottom:5px; font-size:0.8em;">STRUCTURES</div>
    </div>
    
    <button id="waveBtn" onclick="startWave()" style="background:#800; color:#fff; border:none; padding:10px; cursor:pointer; font-family:'Chakra Petch'; font-weight:bold;">ESTABLISH DEFENSE</button>
</div>

<script>
const CONFIG = {
    CELL: 50, GRID: 10,
    BUILDINGS: {
        REACTOR: { name: 'TESLA REACTOR', cost: 300, power: 100, color: '#4a5e6d', roof: '#6a7e8d', h: 30 },
        REFINERY: { name: 'ORE REFINERY', cost: 500, power: -40, color: '#554433', roof: '#776655', h: 40 },
        FACTORY: { name: 'WAR FACTORY', cost: 1000, power: -60, color: '#552222', roof: '#774444', h: 35 },
        TESLA: { name: 'TESLA COIL', cost: 600, power: -75, color: '#222255', roof: '#444477', h: 50 }
    }
};

let game = {
    money: 1200, powerProd: 0, powerCons: 0,
    buildings: [], enemies: [], particles: [],
    selected: null, wave: 0, mode: 'base',
    mouse: {x:0, y:0}
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function init() {
    canvas.addEventListener('mousemove', e => {
        const r = canvas.getBoundingClientRect();
        game.mouse.x = e.clientX - r.left; game.mouse.y = e.clientY - r.top;
    });
    canvas.addEventListener('mousedown', () => {
        if(game.mode === 'base' && game.selected) placeBuilding();
    });
    
    // Generuj przyciski menu
    const menu = document.getElementById('buildMenu');
    for(let key in CONFIG.BUILDINGS) {
        const b = CONFIG.BUILDINGS[key];
        const btn = document.createElement('div');
        btn.className = 'build-btn';
        btn.innerHTML = `<span>${b.name}</span><span>$${b.cost}</span>`;
        btn.onclick = () => game.selected = key;
        menu.appendChild(btn);
    }
    
    requestAnimationFrame(update);
}

function placeBuilding() {
    const bCfg = CONFIG.BUILDINGS[game.selected];
    const gx = Math.floor(game.mouse.x / CONFIG.CELL);
    const gy = Math.floor(game.mouse.y / CONFIG.CELL);
    
    if(game.money >= bCfg.cost) {
        game.buildings.push({ ...bCfg, gx, gy, lastFire: 0 });
        game.money -= bCfg.cost;
        updatePower();
    } else {
        showMsg("INSUFFICIENT FUNDS");
    }
}

function updatePower() {
    game.powerProd = game.buildings.reduce((s, b) => s + (b.power > 0 ? b.power : 0), 0);
    game.powerCons = Math.abs(game.buildings.reduce((s, b) => s + (b.power < 0 ? b.power : 0), 0));
    
    const ratio = game.powerProd === 0 ? 0 : (game.powerCons / game.powerProd);
    document.getElementById('powerIndicator').style.height = Math.min(100, (game.powerCons/Math.max(game.powerProd, 100)) * 100) + "%";
    document.getElementById('powerIndicator').style.background = ratio > 1 ? "#f00" : "#0f0";
}

function drawPseudo3D(x, y, w, d, h, baseCol, roofCol) {
    // Cień
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(x+10, y+10, w, d);
    // Ściana frontowa
    ctx.fillStyle = baseCol;
    ctx.fillRect(x, y + d - h, w, h);
    // Dach
    ctx.fillStyle = roofCol;
    ctx.fillRect(x, y - h, w, d);
    // Krawędzie
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.strokeRect(x, y - h, w, d);
}

function update() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Siatka terenu
    ctx.strokeStyle = 'rgba(0,255,0,0.05)';
    for(let i=0; i<CONFIG.GRID; i++) {
        for(let j=0; j<CONFIG.GRID; j++) ctx.strokeRect(i*50, j*50, 50, 50);
    }

    // Budynki
    game.buildings.forEach(b => {
        drawPseudo3D(b.gx*50 + 5, b.gy*50 + 5, 40, 40, b.h, b.color, b.roof);
        
        // Atak Tesla Coil
        if(b.name === 'TESLA COIL' && game.mode === 'defense' && game.powerProd >= game.powerCons) {
            const now = Date.now();
            if(now - b.lastFire > 1000) {
                const target = game.enemies.find(e => Math.hypot(e.x - (b.gx*50+25), e.y - (b.gy*50+25)) < 200);
                if(target) {
                    drawLightning(b.gx*50+25, b.gy*50-b.h+20, target.x, target.y);
                    target.hp -= 100;
                    b.lastFire = now;
                }
            }
        }
    });

    // Duch budowania
    if(game.selected && game.mode === 'base') {
        const gx = Math.floor(game.mouse.x / CONFIG.CELL);
        const gy = Math.floor(game.mouse.y / CONFIG.CELL);
        ctx.fillStyle = 'rgba(0,255,0,0.2)';
        ctx.fillRect(gx*50, gy*50, 50, 50);
    }

    // Wrogowie
    game.enemies.forEach((e, i) => {
        e.y += 1.5;
        ctx.fillStyle = '#f00';
        ctx.fillRect(e.x-10, e.y-10, 20, 20);
        if(e.hp <= 0) {
            game.money += 50;
            game.enemies.splice(i, 1);
        }
    });

    document.getElementById('statMoney').innerText = `$${game.money}`;
    if(game.enemies.length === 0 && game.mode === 'defense') game.mode = 'base';

    requestAnimationFrame(update);
}

function drawLightning(x1, y1, x2, y2) {
    ctx.strokeStyle = '#0ff'; ctx.lineWidth = 3;
    ctx.shadowBlur = 10; ctx.shadowColor = '#0ff';
    ctx.beginPath(); ctx.moveTo(x1, y1);
    for(let i=0; i<5; i++) {
        ctx.lineTo(x1 + (x2-x1)*i/5 + (Math.random()-0.5)*20, y1 + (y2-y1)*i/5 + (Math.random()-0.5)*20);
    }
    ctx.lineTo(x2, y2); ctx.stroke();
    ctx.shadowBlur = 0;
}

function startWave() {
    game.mode = 'defense';
    game.wave++;
    for(let i=0; i<game.wave*3; i++) {
        game.enemies.push({ x: Math.random()*500, y: -Math.random()*200, hp: 100 });
    }
}

function showMsg(m) {
    const el = document.getElementById('msgLog');
    el.innerText = m; el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 2000);
}

init();
</script>
</body>
</html>
