<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-5-8: Wersja Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --table-color: #2d5a27;
            --table-pattern: #356b2e;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --card-width: 80px;
            --card-height: 115px;
            --accent: #ffd700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Libre Baskerville', serif;
            background: #1a1a1a;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- STÓŁ DO GRY --- */
        .game-container {
            width: 100%;
            height: 100%;
            max-width: 1200px;
            background-color: var(--table-color);
            background-image: radial-gradient(circle, transparent 20%, #1a3c15 100%),
                              repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 10px);
            position: relative;
            box-shadow: inset 0 0 100px #000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Drewniana ramka (opcjonalna, symulowana borderem) */
        .game-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 15px solid var(--wood-dark);
            pointer-events: none;
            z-index: 100;
        }

        /* --- MENU --- */
        .menu-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .menu-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 4px solid var(--wood-light);
            max-width: 400px;
            width: 90%;
        }

        .menu-title {
            font-size: 3rem;
            color: var(--wood-dark);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .menu-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }

        .player-list {
            text-align: left;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .btn {
            background: linear-gradient(to bottom, #8d6e63, #5d4037);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 4px 0 #3e2723;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:hover { filter: brightness(1.1); }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #3e2723; }
        .btn:disabled { background: #999; box-shadow: none; cursor: not-allowed; }

        /* --- HEADER & WYNIKI --- */
        .top-bar {
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            color: #fff;
            text-shadow: 1px 1px 2px black;
            z-index: 10;
        }

        .score-board {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            display: flex;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .score-item { text-align: center; min-width: 60px; }
        .score-name { font-size: 0.8rem; opacity: 0.8; margin-bottom: 2px; }
        .score-val { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        .trick-count { font-size: 0.8rem; color: #a5d6a7; }

        .game-info {
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: 20px;
        }
        .game-status { font-size: 1.2rem; color: var(--accent); font-weight: bold; margin-bottom: 5px; }
        .game-msg { font-size: 0.9rem; opacity: 0.9; }

        /* --- PRZECIWNICY --- */
        .opponents-area {
            display: flex;
            justify-content: space-around;
            width: 70%;
            margin: 0 auto;
            position: relative;
            top: -20px;
        }

        .opponent {
            text-align: center;
            transition: opacity 0.3s;
        }
        .opponent.active .op-name { color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        
        .op-name { color: white; margin-bottom: 5px; font-weight: bold; text-shadow: 1px 1px 3px black; }
        
        .op-cards {
            display: flex;
            justify-content: center;
        }
        .card-back {
            width: 35px;
            height: 50px;
            background: linear-gradient(135deg, #b71c1c 0%, #800000 100%);
            border: 2px solid #fff;
            border-radius: 4px;
            margin: 0 -20px; /* Zakładka kart */
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
        }
        .card-back:first-child { margin-left: 0; }

        /* --- STÓŁ (ŚRODEK) --- */
        .middle-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Strefa lewy (trick) */
        .trick-zone {
            width: 300px;
            height: 200px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .played-card-wrapper {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.5s ease-out;
        }
        
        /* Pozycjonowanie kart na stole */
        /* Gracz (dół) */
        .trick-p0 { transform: translateY(20px); z-index: 10; }
        /* Lewy (Darek) */
        .trick-p1 { transform: translate(-80px, -20px) rotate(-15deg); z-index: 5; }
        /* Prawy (Leszek) */
        .trick-p2 { transform: translate(80px, -20px) rotate(15deg); z-index: 5; }

        .played-label {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px black;
        }

        /* Strefa Wyboru (Modal wewnątrz gry) */
        .choice-overlay {
            position: absolute;
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
            backdrop-filter: blur(3px);
            z-index: 50;
            display: none; /* JS to włączy */
            flex-direction: column;
            gap: 15px;
        }
        .choice-title { color: white; font-weight: bold; margin-bottom: 10px; }
        .choice-btn-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

        /* --- GRACZ (DÓŁ) --- */
        .player-area {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding-bottom: 30px;
        }

        .my-name {
            color: white;
            margin-bottom: 10px;
            font-weight: bold;
            opacity: 0.7;
        }
        .my-name.active { color: var(--accent); opacity: 1; text-shadow: 0 0 10px var(--accent); }

        .hand {
            display: flex;
            justify-content: center;
            min-height: 140px; /* Minimum space for cards */
            height: auto; /* Allow it to grow */
            align-items: flex-end;
            flex-wrap: wrap; /* Allow cards to wrap on small screens */
            gap: 5px;
        }

        /* --- KARTA --- */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            margin: 0 5px; /* Odstęp między kartami */
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, margin 0.2s;
            position: relative;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
        }

        .card:hover {
            transform: translateY(-20px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            z-index: 100;
        }

        .card.selected {
            transform: translateY(-30px);
            box-shadow: 0 0 15px var(--accent);
            border: 2px solid var(--accent);
        }

        .card.disabled {
            filter: grayscale(100%) brightness(0.7);
            cursor: not-allowed;
            transform: none !important;
        }

        .card-top, .card-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }
        .card-bottom { transform: rotate(180deg); }
        
        .rank { font-size: 1.2rem; font-weight: bold; }
        .suit { font-size: 1.2rem; }

        .red { color: #d32f2f; }
        .black { color: #212121; }

        /* --- MEDIA QUERIES --- */
        @media (max-width: 700px) {
            :root { 
                --card-width: 45px; 
                --card-height: 65px; 
            }
            .game-container::after {
                border-width: 8px;
            }
            .top-bar { 
                padding: 10px; 
                flex-direction: column; 
                align-items: center; 
                gap: 10px; 
            }
            .score-board {
                padding: 8px 12px;
                gap: 12px;
            }
            .score-val {
                font-size: 1.2rem;
            }
            .game-info { 
                position: static; 
                transform: none; 
                margin-bottom: 10px; 
            }
            .game-status {
                font-size: 1rem;
            }
            .game-msg {
                font-size: 0.8rem;
            }
            .opponents-area {
                width: 95%;
                top: 0;
            }
            .card-back {
                width: 25px;
                height: 38px;
                margin: 0 -15px;
            }
            .hand { 
                height: 100px;
                margin: 0; 
            }
            .card { 
                margin: 0 2px;
                padding: 3px;
            }
            .card .rank {
                font-size: 0.9rem;
            }
            .card .suit {
                font-size: 1rem;
            }
            .card:hover {
                transform: translateY(-15px) scale(1.03);
            }
            .card.selected {
                transform: translateY(-20px);
            }
            .trick-zone { 
                width: 200px; 
                height: 120px; 
            }
            .trick-p1 { 
                transform: translate(-60px, -10px) rotate(-15deg); 
            }
            .trick-p2 { 
                transform: translate(60px, -10px) rotate(15deg); 
            }
            .choice-overlay {
                padding: 15px;
                max-width: 90%;
            }
            .choice-title {
                font-size: 0.9rem;
            }
            .btn {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .player-area {
                padding: 10px;
                padding-bottom: 20px;
            }
            .my-name {
                font-size: 0.9rem;
            }
        }

        /* --- MODAL KOŃCOWY --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: 0 0 30px black;
            text-align: center;
        }
        .modal-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

    <div class="menu-overlay" id="menu">
        <div class="menu-box">
            <div class="menu-title">3-5-8</div>
            
            <div class="player-list">
                <div style="margin-bottom:5px;"><strong>Ty</strong></div>
                <div style="margin-bottom:5px; color:#d32f2f;"><strong>Darek</strong> (Uwaga!)</div>
                <div style="color:#1976d2;"><strong>Leszek</strong> (Średni)</div>
            </div>
            
            <button class="btn" onclick="startGame()">Rozdaj karty</button>
        </div>
    </div>

    <div class="game-container" id="game" style="display: none;">
        
        <div class="top-bar">
            <div class="score-board">
                <div class="score-item">
                    <div class="score-name" style="color:#90caf9;">Ty</div>
                    <div class="score-val" id="scoreHuman">0</div>
                    <div class="trick-count">Lew: <span id="tricksHuman">0</span></div>
                </div>
                <div class="score-item">
                    <div class="score-name">Darek</div>
                    <div class="score-val" id="scoreDarek">0</div>
                    <div class="trick-count">Lew: <span id="tricksDarek">0</span></div>
                </div>
                <div class="score-item">
                    <div class="score-name">Leszek</div>
                    <div class="score-val" id="scoreLeszek">0</div>
                    <div class="trick-count">Lew: <span id="tricksLeszek">0</span></div>
                </div>
            </div>

            <div class="game-info">
                <div class="game-status" id="gameType">Rozdanie 1</div>
                <div class="game-msg" id="message">Oczekiwanie...</div>
                <div id="usedGames" style="font-size: 0.7rem; margin-top: 5px; opacity: 0.8;"></div>
                <button class="btn" onclick="showHistory()" style="margin-top: 10px; padding: 5px 15px; font-size: 0.8rem;">Historia</button>
            </div>
            
            <div style="width: 100px;"> </div>
        </div>

        <div class="opponents-area" id="opponents">
            </div>

        <div class="middle-area">
            
            <div class="trick-zone" id="trickZone">
                </div>

            <div class="choice-overlay" id="choiceZone">
                </div>
        </div>

        <div class="player-area">
            <div class="my-name" id="playerName">Twoja kolej</div>
            <div class="hand" id="playerHand">
                </div>
            <div id="playerActions" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-bottom: 20px; color:#3e2723;">Tytuł</h2>
            <div id="modalBody" style="margin-bottom: 20px;"></div>
            <button class="btn" onclick="closeModal()">Dalej</button>
        </div>
    </div>

    <script>
        const SUITS = ['♥', '♦', '♠', '♣'];
        const RANKS_FULL = ['2','3','4','5','6','7','8','9','10','W','D','K','A'];
        const VALUES = {2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,W:11,D:12,K:13,A:14};
        
        const PLAYERS = ['human','darek','leszek'];
        const NAMES = {human:'Ty',darek:'Darek',leszek:'Leszek'};
        
        // Helper: sortowanie kart
        function sortHand(hand) {
            const suitOrder = {'♠': 0, '♥': 1, '♦': 2, '♣': 3};
            hand.sort((a,b) => {
                if(a.suit !== b.suit) {
                    return suitOrder[a.suit] - suitOrder[b.suit];
                }
                // OD NAJWYŻSZEJ DO NAJNIŻSZEJ (A -> 2)
                return VALUES[b.rank] - VALUES[a.rank];
            });
        }
        const GAMES = [
            {id:'kier',name:'Kier',trump:'♥'},
            {id:'karo',name:'Karo',trump:'♦'},
            {id:'pik',name:'Pik',trump:'♠'},
            {id:'trefl',name:'Trefl',trump:'♣'},
            {id:'bezatu',name:'Bez Atu',trump:null},
            {id:'bezlew',name:'Bez Lew',trump:null}
        ];

        let state = {
            phase: 'menu',
            hands: {},
            musik: [],
            dealer: 0,
            current: 0,
            trick: [],
            scores: {human:0,darek:0,leszek:0},           // Suma kumulowana
            tricks: {human:0,darek:0,leszek:0},
            played: {human:[],darek:[],leszek:[]},
            lastRoundScores: {human:0,darek:0,leszek:0},  // Tylko ostatnia runda (windykacja)
            round: 1,
            gameType: null,
            trump: null,
            selected: [],
            history: [],  // Historia: [{round, dealer, gameType, scores, tricks}]
            windykacjaFrom: null,  // Kto oddaje karty
            windykacjaTo: null,    // Kto bierze karty
            windykacjaCount: 0     // Ile kart
        };

        function startGame() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game').style.display = 'flex';
            state.dealer = Math.floor(Math.random() * 3);
            state.round = 1;
            state.scores = {human:0,darek:0,leszek:0};
            state.played = {human:[],darek:[],leszek:[]};
            state.lastRoundScores = {human:0,darek:0,leszek:0};
            state.history = [];
            dealCards();
        }

        function createDeck() {
            let deck = [];
            for(let s of SUITS) {
                for(let r of RANKS_FULL) {
                    deck.push({suit:s, rank:r, id:r+s}); // Znowu z symbolami: "K♥"
                }
            }
            for(let i=deck.length-1; i>0; i--) {
                let j = Math.floor(Math.random()*(i+1));
                [deck[i],deck[j]] = [deck[j],deck[i]];
            }
            return deck;
        }

        function dealCards() {
            let deck = createDeck();
            state.hands = {human:[],darek:[],leszek:[]};
            state.musik = [];
            let idx = 0;
            
            for(let i=0; i<16; i++) {
                for(let p of PLAYERS) {
                    state.hands[p].push(deck[idx++]);
                }
            }
            for(let i=0; i<4; i++) {
                state.musik.push(deck[idx++]);
            }

            state.tricks = {human:0,darek:0,leszek:0};
            state.trick = [];
            state.selected = [];
            
            // Sortuj karty gracza
            sortHand(state.hands.human);
            
            let lead = (state.dealer + 1) % 3;
            state.current = lead;
            
            updateDisplay();
            
            let dealerName = NAMES[PLAYERS[state.dealer]];
            setMessage(`Rozdaje: ${dealerName}.`);
            
            // Sprawdź czy windykacja jest potrzebna
            setTimeout(() => checkWindykacja(), 1000);
        }
        
        function checkWindykacja() {
            // Czy poprzednia gra to BA/BL? (brak windykacji)
            let prevHistory = state.history[state.history.length - 1];
            let skipWindykacja = prevHistory && (prevHistory.gameType === 'bezatu' || prevHistory.gameType === 'bezlew');
            
            console.log('=== WINDYKACJA CHECK ===');
            console.log('Poprzednia gra:', prevHistory ? prevHistory.gameType : 'brak');
            console.log('Skip windykacja:', skipWindykacja);
            console.log('Last round scores:', state.lastRoundScores);
            
            if(skipWindykacja || state.round === 1) {
                // Brak windykacji - od razu wybór gry
                console.log('Brak windykacji - przejście do wyboru gry');
                startChoosing();
                return;
            }
            
            // Znajdź pary do windykacji
            let plusPlayers = PLAYERS.filter(p => state.lastRoundScores[p] > 0);
            let minusPlayers = PLAYERS.filter(p => state.lastRoundScores[p] < 0);
            
            console.log('Plus players:', plusPlayers);
            console.log('Minus players:', minusPlayers);
            
            if(plusPlayers.length === 0 || minusPlayers.length === 0) {
                // Brak windykacji (wszyscy 0 lub wszyscy plus/minus - niemożliwe)
                console.log('Brak par do windykacji');
                startChoosing();
                return;
            }
            
            // Sortuj graczy na plusie po zobowiązaniu (malejąco)
            plusPlayers.sort((a,b) => {
                let reqA = getRequiredForPlayer(a);
                let reqB = getRequiredForPlayer(b);
                return reqB - reqA;  // Od największego
            });
            
            console.log('Kolejność windykacji:', plusPlayers);
            
            // Rozpocznij windykację - używamy KOPII lastRoundScores
            state.windykacjaQueue = [];
            let tempScores = {...state.lastRoundScores};
            
            for(let plusPlayer of plusPlayers) {
                for(let minusPlayer of minusPlayers) {
                    let amount = Math.min(
                        tempScores[plusPlayer],
                        Math.abs(tempScores[minusPlayer])
                    );
                    if(amount > 0) {
                        state.windykacjaQueue.push({
                            from: minusPlayer,
                            to: plusPlayer,
                            count: amount
                        });
                        tempScores[plusPlayer] -= amount;
                        tempScores[minusPlayer] += amount;
                    }
                }
            }
            
            console.log('Windykacja queue:', state.windykacjaQueue);
            
            if(state.windykacjaQueue.length > 0) {
                processNextWindykacja();
            } else {
                startChoosing();
            }
        }
        
        function getRequiredForPlayer(pid) {
            let idx = PLAYERS.indexOf(pid);
            let lead = (state.dealer + 1) % 3;
            // Domyślnie zakładamy normalną grę dla sortowania
            if(idx === lead) return 8;
            if(idx === (lead+1)%3) return 5;
            return 3;
        }
        
        function processNextWindykacja() {
            if(!state.windykacjaQueue || state.windykacjaQueue.length === 0) {
                startChoosing();
                return;
            }
            
            let w = state.windykacjaQueue.shift();
            state.phase = 'windykacja';
            state.windykacjaFrom = w.from;
            state.windykacjaTo = w.to;
            state.windykacjaCount = w.count;
            state.selected = [];
            
            console.log(`Windykacja: ${NAMES[w.to]} (+) bierze ${w.count} od ${NAMES[w.from]} (-)`);
            
            if(w.to === 'human') {
                // Gracz daje karty
                showWindykacjaGive();
            } else if(w.from === 'human') {
                // Gracz oddaje karty
                showWindykacjaReceive();
            } else {
                // AI <-> AI
                aiWindykacja(w);
                setTimeout(() => processNextWindykacja(), 800);
            }
        }
        
        function showWindykacjaGive() {
            setMessage(`Windykacja: Wybierz ${state.windykacjaCount} słabych kart do oddania graczowi ${NAMES[state.windykacjaFrom]}`);
            updateDisplay();
            
            let zone = document.getElementById('choiceZone');
            zone.innerHTML = `
                <div class="choice-title">Windykacja: Ty (+) → ${NAMES[state.windykacjaFrom]} (-)</div>
                <div class="choice-title">Wybierz ${state.windykacjaCount} słabych kart do oddania (${state.selected.length}/${state.windykacjaCount})</div>
                <button class="btn" id="confirmWindGive" onclick="confirmWindykacjaGive()" disabled>Potwierdź</button>
            `;
            zone.style.display = 'flex';
        }
        
        function showWindykacjaReceive() {
            setMessage(`Windykacja: ${NAMES[state.windykacjaTo]} daje Ci ${state.windykacjaCount} słabych kart, oddasz najmocniejsze w ich kolorach`);
            
            // AI wybiera słabe karty
            let aiHand = state.hands[state.windykacjaTo];
            let sorted = [...aiHand].sort((a,b) => VALUES[a.rank] - VALUES[b.rank]);
            let givenCards = sorted.slice(0, state.windykacjaCount);
            
            // Zapisz w state
            state.windykacjaGivenCards = givenCards;
            
            updateDisplay();
            
            let zone = document.getElementById('choiceZone');
            let cardsHtml = '<div style="display:flex; gap:10px; justify-content:center; margin:15px 0;">';
            givenCards.forEach(c => {
                cardsHtml += renderCardHTML(c, false, true, false);
            });
            cardsHtml += '</div>';
            
            zone.innerHTML = `
                <div class="choice-title">Windykacja: ${NAMES[state.windykacjaTo]} (+) → Ty (-)</div>
                <div class="choice-title">${NAMES[state.windykacjaTo]} daje Ci:</div>
                ${cardsHtml}
                <div class="choice-title">Wybierz ${state.windykacjaCount} najmocniejszych w tych kolorach (${state.selected.length}/${state.windykacjaCount})</div>
                <button class="btn" id="confirmWindRec" onclick="confirmWindykacjaReceive()" disabled>Potwierdź</button>
            `;
            zone.style.display = 'flex';
        }
        
        function confirmWindykacjaGive() {
            if(state.selected.length !== state.windykacjaCount) return;
            
            let givenCards = [...state.selected];
            state.hands.human = state.hands.human.filter(c => !givenCards.find(g => g.id === c.id));
            
            // Przeciwnik oddaje najmocniejsze
            let oppHand = state.hands[state.windykacjaFrom];
            let received = [];
            
            for(let given of givenCards) {
                let suitCards = oppHand.filter(c => c.suit === given.suit);
                let strongest;
                if(suitCards.length > 0) {
                    strongest = suitCards.reduce((max, c) => VALUES[c.rank] > VALUES[max.rank] ? c : max);
                } else {
                    // Brak koloru - dowolna karta (najsłabsza)
                    strongest = oppHand.reduce((min, c) => VALUES[c.rank] < VALUES[min.rank] ? c : min);
                }
                received.push(strongest);
                oppHand = oppHand.filter(c => c.id !== strongest.id);
            }
            
            state.hands[state.windykacjaFrom] = oppHand;
            state.hands[state.windykacjaFrom].push(...givenCards);
            state.hands.human.push(...received);
            
            sortHand(state.hands.human);
            
            state.selected = [];
            document.getElementById('choiceZone').style.display = 'none';
            
            setTimeout(() => processNextWindykacja(), 500);
        }
        
        function confirmWindykacjaReceive() {
            if(state.selected.length !== state.windykacjaCount) return;
            
            let givenCards = state.windykacjaGivenCards;
            let returnCards = [...state.selected];
            
            state.hands.human = state.hands.human.filter(c => !returnCards.find(r => r.id === c.id));
            state.hands[state.windykacjaTo] = state.hands[state.windykacjaTo].filter(c => !givenCards.find(g => g.id === c.id));
            
            state.hands.human.push(...givenCards);
            state.hands[state.windykacjaTo].push(...returnCards);
            
            sortHand(state.hands.human);
            
            state.selected = [];
            state.windykacjaGivenCards = null;
            document.getElementById('choiceZone').style.display = 'none';
            
            setTimeout(() => processNextWindykacja(), 500);
        }
        
        function aiWindykacja(w) {
            let giverHand = state.hands[w.to];
            let receiverHand = state.hands[w.from];
            
            // AI daje najsłabsze
            let sorted = [...giverHand].sort((a,b) => VALUES[a.rank] - VALUES[b.rank]);
            let given = sorted.slice(0, w.count);
            
            // AI odbiera najmocniejsze w kolorach
            let received = [];
            for(let g of given) {
                let suitCards = receiverHand.filter(c => c.suit === g.suit);
                let strongest;
                if(suitCards.length > 0) {
                    strongest = suitCards.reduce((max, c) => VALUES[c.rank] > VALUES[max.rank] ? c : max);
                } else {
                    strongest = receiverHand.reduce((min, c) => VALUES[c.rank] < VALUES[min.rank] ? c : min);
                }
                received.push(strongest);
                receiverHand = receiverHand.filter(c => c.id !== strongest.id);
            }
            
            state.hands[w.to] = giverHand.filter(c => !given.find(g => g.id === c.id));
            state.hands[w.to].push(...received);
            
            state.hands[w.from] = receiverHand;
            state.hands[w.from].push(...given);
        }
        
        function startChoosing() {
            let lead = (state.dealer + 1) % 3;
            state.current = lead;
            state.phase = 'choosing';
            
            updateDisplay();
            setMessage(`${NAMES[PLAYERS[lead]]} wybiera grę.`);
            if(lead !== 0) {
                setTimeout(() => aiChooseGame(lead), 1500);
            } else {
                showGameChoice();
            }
        }

        function showGameChoice() {
            let available = GAMES.filter(g => !state.played.human.includes(g.id));
            let zone = document.getElementById('choiceZone');
            
            let handHtml = '<div style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;">';
            for(let i=0; i<5; i++) {
                handHtml += renderCardHTML(state.hands.human[i], false, true, false);
            }
            handHtml += '</div>';

            let html = `
                <div class="choice-title">Masz głos! Wybierz typ gry:</div>
                ${handHtml}
                <div class="choice-btn-row">
            `;
            
            for(let g of available) {
                let color = g.trump === '♥' || g.trump === '♦' ? '#d32f2f' : (g.trump ? '#000' : '#5d4037');
                html += `<button class="btn" style="background:${color}" onclick="chooseGame('${g.id}')">${g.name} ${g.trump||''}</button>`;
            }
            html += '</div>';
            
            zone.innerHTML = html;
            zone.style.display = 'flex';
        }

        function aiChooseGame(idx) {
            let pid = PLAYERS[idx];
            let hand = state.hands[pid];
            let first5 = hand.slice(0,5);
            let available = GAMES.filter(g => !state.played[pid].includes(g.id));
            
            // STRATEGIA WINDYKACYJNA
            let lastScore = state.lastRoundScores[pid] || 0;
            let prevGameType = state.history.length > 0 ? state.history[state.history.length - 1].gameType : null;
            
            console.log(`=== AI WYBÓR GRY: ${NAMES[pid]} ===`);
            console.log('Poprzednia gra:', prevGameType);
            console.log('Ostatni wynik:', lastScore);
            
            // Ocena siły kolorów
            let strength = {};
            for(let s of SUITS) {
                let cards = first5.filter(c => c.suit === s);
                strength[s] = cards.reduce((sum, c) => {
                    let v = VALUES[c.rank];
                    return sum + (v>=11 ? v-10 : 0) + 1;
                }, 0);
            }
            
            let maxStrength = Math.max(...Object.values(strength));
            console.log('Siły kolorów:', strength);
            console.log('Najsilniejszy kolor:', maxStrength);
            
            // Jeśli jesteś NA PLUSIE - NIE wybieraj BA/BL (stracisz przewagę z windykacji w następnej rundzie)
            if(lastScore > 0) {
                console.log('NA PLUSIE (+' + lastScore + ') - usuwam BA/BL z opcji');
                available = available.filter(g => g.id !== 'bezatu' && g.id !== 'bezlew');
                if(available.length === 0) {
                    // Wszystkie atuty zagrane - musi wybrać BA/BL
                    available = GAMES.filter(g => !state.played[pid].includes(g.id));
                    console.log('Wszystkie atuty zagrane - muszę wybrać BA/BL mimo plusu');
                }
            }
            
            // Jeśli jesteś NA MINUSIE i poprzednia gra NIE była BA/BL - rozważ ucieczkę
            if(lastScore < 0 && prevGameType !== 'bezatu' && prevGameType !== 'bezlew') {
                console.log('NA MINUSIE (' + lastScore + ') + BYŁA WINDYKACJA');
                
                let escapeGames = available.filter(g => g.id === 'bezatu' || g.id === 'bezlew');
                
                if(escapeGames.length > 0) {
                    // Jeśli mam BARDZO SILNY kolor (6+) - ryzykuj mimo minusa
                    if(maxStrength >= 6) {
                        console.log('Mam silny kolor (' + maxStrength + ') - ryzykuję mimo minusa');
                        // 30% szans na ucieczkę mimo silnej ręki
                        if(Math.random() < 0.3) {
                            console.log('Mimo silnej ręki wybieram BA/BL jako ucieczkę');
                            let escape = escapeGames[Math.floor(Math.random() * escapeGames.length)];
                            chooseGame(escape.id);
                            return;
                        }
                    } 
                    // Jeśli mam ŚREDNI kolor (4-5) - 50/50
                    else if(maxStrength >= 4) {
                        console.log('Średnia ręka (' + maxStrength + ') - rozważam BA/BL');
                        if(Math.random() < 0.5) {
                            console.log('Wybieram BA/BL jako ucieczkę');
                            let escape = escapeGames[Math.floor(Math.random() * escapeGames.length)];
                            chooseGame(escape.id);
                            return;
                        }
                    }
                    // Jeśli mam SŁABĄ rękę (< 4) - prawie zawsze ucieczka
                    else {
                        console.log('Słaba ręka (' + maxStrength + ') - priorytet BA/BL');
                        if(Math.random() < 0.8) {
                            console.log('Wybieram BA/BL jako ucieczkę');
                            let escape = escapeGames[Math.floor(Math.random() * escapeGames.length)];
                            chooseGame(escape.id);
                            return;
                        }
                    }
                }
            }
            
            // Standardowy wybór na podstawie siły kolorów
            let best = available[0];
            let bestScore = -100;
            
            for(let g of available) {
                let score = 0;
                if(g.trump) {
                    score = strength[g.trump] || 0;
                } else if(g.id === 'bezatu') {
                    // BA mniej atrakcyjne gdy jesteś na 0 (brak windykacji)
                    score = lastScore === 0 ? 3 : Object.values(strength).reduce((a,b)=>a+b,0) / 2;
                } else if(g.id === 'bezlew') {
                    score = lastScore === 0 ? 3 : 5;
                }
                if(score > bestScore) {
                    bestScore = score;
                    best = g;
                }
            }
            
            console.log('Wybrano:', best.name);
            chooseGame(best.id);
        }

        function chooseGame(gid) {
            let game = GAMES.find(g => g.id === gid);
            state.gameType = game.id;
            state.trump = game.trump;
            
            let lead = (state.dealer + 1) % 3;
            let pid = PLAYERS[lead];
            state.played[pid].push(game.id);
            
            document.getElementById('gameType').innerHTML = `${game.name} <span style="color:${(game.trump=='♥'||game.trump=='♦')?'red':'inherit'}">${game.trump||''}</span>`;
            document.getElementById('choiceZone').style.display = 'none';
            
            setMessage(`Wybrano: ${game.name}. Odkrywanie musika...`);
            
            setTimeout(() => {
                state.phase = 'musik';
                setMessage(`${NAMES[pid]} zabiera musik i oddaje 4 karty...`);
                if(lead !== 0) {
                    setTimeout(() => aiHandleMusik(lead), 1500);
                } else {
                    showMusik();
                }
            }, 1000);
        }

        function showMusik() {
            let zone = document.getElementById('choiceZone');
            let html = '<div class="choice-title">Musik:</div><div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">';
            for(let c of state.musik) {
                html += renderCardHTML(c, false, true, false);
            }
            html += '</div><button class="btn" onclick="takeMusik()">Weź musik</button>';
            zone.innerHTML = html;
            zone.style.display = 'flex';
        }

        function takeMusik() {
            console.log('=== BIORĘ MUSIK ===');
            console.log('Przed: Hand size =', state.hands.human.length, 'Musik size =', state.musik.length);
            
            state.hands.human.push(...state.musik);
            state.musik = [];
            state.selected = [];
            state.phase = 'musik';
            
            console.log('Po dodaniu: Hand size =', state.hands.human.length);
            
            if(state.hands.human.length !== 20) {
                console.error('BŁĄD! Po wzięciu musika powinno być 20 kart, jest:', state.hands.human.length);
            }
            
            sortHand(state.hands.human);

            document.getElementById('choiceZone').style.display = 'none';
            setMessage('Kliknij 4 karty do oddania (0/4)');
            updateDisplay();
        }

        function aiHandleMusik(idx) {
            let pid = PLAYERS[idx];
            state.hands[pid].push(...state.musik);
            state.musik = [];
            
            let sorted = [...state.hands[pid]].sort((a,b) => VALUES[a.rank] - VALUES[b.rank]);
            let discard = sorted.slice(0,4);
            state.hands[pid] = state.hands[pid].filter(c => !discard.find(d => d.id === c.id));
            
            startPlaying();
        }

        function confirmDiscard() {
            if(state.selected.length !== 4) return;
            state.hands.human = state.hands.human.filter(c => !state.selected.find(s => s.id === c.id));
            state.selected = [];
            
            // Sortuj po oddaniu
            sortHand(state.hands.human);
            
            updateDisplay();
            startPlaying();
        }

        function startPlaying() {
            state.phase = 'playing';
            let lead = (state.dealer + 1) % 3;
            state.current = lead;
            
            console.log('=== ROZPOCZYNAM GRĘ ===');
            console.log('Lead player:', lead, '(' + NAMES[PLAYERS[lead]] + ')');
            
            if(lead !== 0) {
                setMessage(`${NAMES[PLAYERS[lead]]} wychodzi...`);
                setTimeout(() => {
                    console.log('Lead AI timeout: wywołuję aiPlay');
                    aiPlay(lead);
                }, 800);
            } else {
                setMessage('Twoja kolej - wychodzisz!');
            }
            
            updateDisplay();
        }

        function getValid(hand, trick, trump) {
            console.log('=== GET VALID ===');
            console.log('Hand size:', hand.length);
            console.log('Trick size:', trick.length);
            console.log('Trump:', trump);
            
            // Pierwszy wychodzi - wszystkie karty dozwolone
            if(trick.length === 0) {
                console.log('Wychodzę - wszystkie karty OK');
                return hand;
            }
            
            let leadSuit = trick[0].card.suit;
            console.log('Kolor wyjścia:', leadSuit);
            
            // Znajdź najwyższą kartę w lewie
            let highestInTrick = trick[0].card;
            let highestIsTrump = trump && highestInTrick.suit === trump;
            
            for(let i = 1; i < trick.length; i++) {
                let card = trick[i].card;
                let cardIsTrump = trump && card.suit === trump;
                
                // Jeśli karta to atut a najwyższa nie
                if(cardIsTrump && !highestIsTrump) {
                    highestInTrick = card;
                    highestIsTrump = true;
                }
                // Jeśli obie atuty - wyższa wygrywa
                else if(cardIsTrump && highestIsTrump) {
                    if(VALUES[card.rank] > VALUES[highestInTrick.rank]) {
                        highestInTrick = card;
                    }
                }
                // Jeśli obie w kolorze wyjścia (nie atuty)
                else if(!cardIsTrump && !highestIsTrump && card.suit === leadSuit && highestInTrick.suit === leadSuit) {
                    if(VALUES[card.rank] > VALUES[highestInTrick.rank]) {
                        highestInTrick = card;
                    }
                }
            }
            
            console.log('Najwyższa w lewie:', highestInTrick.id, highestIsTrump ? '(ATUT)' : '(kolor)');
            
            // Karty w kolorze wyjścia
            let sameSuit = hand.filter(c => c.suit === leadSuit);
            console.log('Kart w kolorze:', sameSuit.length);
            
            // PRZYPADEK 1: Mam kolor wyjścia
            if(sameSuit.length > 0) {
                // Czy najwyższa w lewie to atut?
                if(highestIsTrump) {
                    // Lewa przebita atutem - nie muszę bić (mam tylko kolor)
                    console.log('Lewa przebita atutem - nie mogę przebić kolorem');
                    return sameSuit;
                }
                
                // Najwyższa to kolor - sprawdź czy mogę przebić
                let canBeat = sameSuit.filter(c => VALUES[c.rank] > VALUES[highestInTrick.rank]);
                
                if(canBeat.length > 0) {
                    // MUSISZ PRZEBIĆ
                    console.log('OBOWIĄZEK BICIA - mam wyższe karty w kolorze:', canBeat.length);
                    return canBeat;
                } else {
                    // Nie mogę przebić - dowolna karta w kolorze
                    console.log('Nie mogę przebić - dowolna karta w kolorze');
                    return sameSuit;
                }
            }
            
            // PRZYPADEK 2: Nie mam koloru
            console.log('Nie mam koloru');
            
            // Czy mam atut?
            if(trump) {
                let trumpCards = hand.filter(c => c.suit === trump);
                console.log('Kart atutowych:', trumpCards.length);
                
                if(trumpCards.length > 0) {
                    // Czy najwyższa w lewie to atut?
                    if(highestIsTrump) {
                        // Lewa już przebita atutem - sprawdź czy mogę przebić wyższym atutem
                        let canBeatTrump = trumpCards.filter(c => VALUES[c.rank] > VALUES[highestInTrick.rank]);
                        
                        if(canBeatTrump.length > 0) {
                            // MUSISZ PRZEBIĆ wyższym atutem
                            console.log('OBOWIĄZEK BICIA WYŻSZYM ATUTEM:', canBeatTrump.length);
                            return canBeatTrump;
                        } else {
                            // Nie masz wyższego atutu - dowolny atut
                            console.log('Nie masz wyższego atutu - dowolny atut');
                            return trumpCards;
                        }
                    } else {
                        // Lewa w kolorze - MUSISZ zabić atutem
                        console.log('OBOWIĄZEK BICIA ATUTEM');
                        return trumpCards;
                    }
                }
            }
            
            // Nie masz koloru ani atutu - dowolna karta
            console.log('Nie mam koloru ani atutu - wszystkie karty OK');
            return hand;
        }

        function aiPlay(idx) {
            console.log('=== AI GRA ===');
            console.log('Player index:', idx, '(' + NAMES[PLAYERS[idx]] + ')');
            console.log('Hand size:', state.hands[PLAYERS[idx]].length);
            
            let pid = PLAYERS[idx];
            let valid = getValid(state.hands[pid], state.trick, state.trump);
            
            console.log('Valid cards:', valid.length);
            
            if(valid.length === 0) {
                console.error('BŁĄD: AI nie ma żadnych dozwolonych kart!');
                return;
            }
            
            let card = valid[Math.floor(Math.random()*valid.length)];
            console.log('Wybrano kartę:', card.rank + card.suit);
            
            playCard(card, idx);
        }

        function playCard(card, idx) {
            console.log('=== PLAY CARD ===');
            console.log('Player:', NAMES[PLAYERS[idx]], '(', idx, ')');
            console.log('Card:', card.rank + card.suit);
            
            let pid = PLAYERS[idx];
            state.hands[pid] = state.hands[pid].filter(c => c.id !== card.id);
            
            // Sortuj rękę gracza po zagraniu
            if(pid === 'human') {
                sortHand(state.hands.human);
            }
            
            state.trick.push({player:idx, card:card});
            
            console.log('Lewa ma teraz', state.trick.length, 'karty');
            
            updateDisplay();
            
            if(state.trick.length === 3) {
                console.log('Lewa kompletna - wywołuję completeTrick za 1.2s');
                setTimeout(() => completeTrick(), 1200);
            } else {
                let next = (idx + 1) % 3;
                state.current = next;
                console.log('Następny gracz:', NAMES[PLAYERS[next]], '(', next, ')');
                setMessage(`${NAMES[PLAYERS[next]]} zagrywa...`);
                if(next !== 0) {
                    setTimeout(() => {
                        console.log('AI timeout: wywołuję aiPlay dla', NAMES[PLAYERS[next]]);
                        aiPlay(next);
                    }, 600);
                } else {
                    console.log('>>> TO TWOJA TURA! <<<');
                    setMessage('Twoja kolej!');
                    updateDisplay(); // WAŻNE! Odśwież UI
                }
            }
        }

        function completeTrick() {
            console.log('=== KOŃCZĘ LEWĘ ===');
            
            let leadSuit = state.trick[0].card.suit;
            let winner = state.trick[0];
            
            for(let i=1; i<state.trick.length; i++) {
                let p = state.trick[i];
                let w = winner;
                
                let pIsTrump = state.trump && p.card.suit === state.trump;
                let wIsTrump = state.trump && w.card.suit === state.trump;
                
                if (pIsTrump && !wIsTrump) {
                    winner = p;
                } else if (pIsTrump && wIsTrump) {
                    if(VALUES[p.card.rank] > VALUES[w.card.rank]) winner = p;
                } else if (!pIsTrump && !wIsTrump) {
                    if(p.card.suit === leadSuit) {
                        if(w.card.suit !== leadSuit || VALUES[p.card.rank] > VALUES[w.card.rank]) {
                            winner = p;
                        }
                    }
                }
            }
            
            let wid = PLAYERS[winner.player];
            state.tricks[wid]++;
            
            console.log('Wygrał:', NAMES[wid]);
            
            setMessage(`${NAMES[wid]} bierze lewę!`);
            updateDisplay();
            
            setTimeout(() => {
                state.trick = [];
                updateDisplay();
                
                if(state.hands.human.length === 0) {
                    console.log('Koniec rozdania!');
                    endRound();
                } else {
                    state.current = winner.player;
                    console.log('Następny zagrywa:', NAMES[PLAYERS[winner.player]]);
                    
                    if(winner.player !== 0) {
                        setMessage(`${NAMES[PLAYERS[winner.player]]} zagrywa...`);
                        setTimeout(() => {
                            console.log('Winner AI timeout: wywołuję aiPlay');
                            aiPlay(winner.player);
                        }, 600);
                    } else {
                        console.log('>>> GRACZ DOSTAJE TURĘ! <<<');
                        setMessage('Twoja kolej!');
                        updateDisplay();
                    }
                }
            }, 1500);
        }

        function getRequired(idx) {
            let lead = (state.dealer + 1) % 3;
            
            if(state.gameType === 'bezlew') {
                // W BEZ LEW odwrotnie - ten co ma musik ma najmniejsze zobowiązanie
                if(idx === lead) return 3;           // Wybierający (musik) → 3
                if(idx === (lead+1)%3) return 5;     // Następny → 5
                return 8;                            // Dealer → 8
            } else {
                // Normalna gra
                if(idx === lead) return 8;           // Wybierający (musik) → 8
                if(idx === (lead+1)%3) return 5;     // Następny → 5
                return 3;                            // Dealer → 3
            }
        }

        function endRound() {
            let roundScores = {};
            for(let i=0; i<3; i++) {
                let pid = PLAYERS[i];
                let req = getRequired(i);
                let taken = state.tricks[pid];
                
                // W BEZ LEW punktacja odwrócona - im mniej lew, tym lepiej
                if(state.gameType === 'bezlew') {
                    roundScores[pid] = req - taken;  // Zobowiązane MINUS wzięte
                } else {
                    roundScores[pid] = taken - req;  // Wzięte MINUS zobowiązane (normalnie)
                }
            }

            // Zapisz do historii
            state.history.push({
                round: state.round,
                dealer: state.dealer,
                gameType: state.gameType,
                trump: state.trump,
                roundScores: {...roundScores},
                tricks: {...state.tricks},
                cumulativeScores: {
                    human: state.scores.human + roundScores.human,
                    darek: state.scores.darek + roundScores.darek,
                    leszek: state.scores.leszek + roundScores.leszek
                }
            });
            
            // Zaktualizuj salda
            for(let pid of PLAYERS) {
                state.scores[pid] += roundScores[pid];
            }
            
            // Zapisz wyniki z ostatniej rundy (do windykacji)
            state.lastRoundScores = {...roundScores};
            
            console.log('=== KONIEC RUNDY ===');
            console.log('Round scores:', roundScores);
            console.log('Cumulative scores:', state.scores);
            console.log('Last round scores (windykacja):', state.lastRoundScores);
            
            let html = '';
            for(let i=0; i<3; i++) {
                let pid = PLAYERS[i];
                let req = getRequired(i);
                let sc = roundScores[pid];
                let color = sc >= 0 ? 'green' : 'red';
                html += `
                <div class="modal-row">
                    <span>${NAMES[pid]}</span>
                    <span>Wymagane: <strong>${req}</strong> | Wzięte: <strong>${state.tricks[pid]}</strong></span>
                    <span style="color:${color}; font-weight:bold">${sc>0?'+':''}${sc}</span>
                </div>`;
            }
            
            html += '<div style="margin-top:15px; padding-top:15px; border-top:1px solid #ccc;">';
            html += '<div style="font-weight:bold; margin-bottom:10px;">Suma po rundzie ' + state.round + ':</div>';
            for(let pid of PLAYERS) {
                let color = state.scores[pid] >= 0 ? 'green' : 'red';
                html += `<div>${NAMES[pid]}: <span style="color:${color}; font-weight:bold">${state.scores[pid]>0?'+':''}${state.scores[pid]}</span></div>`;
            }
            html += '</div>';
            
            showModal('Koniec rozdania ' + state.round + '/18', html);
            
            let btn = document.querySelector('#modal button');
            btn.onclick = () => {
                closeModal();
                if(state.played.human.length === 6 && state.played.darek.length === 6) {
                    endGame();
                } else {
                    nextRound();
                }
            };
        }

        function nextRound() {
            state.dealer = (state.dealer + 1) % 3;
            state.round++;
            state.gameType = null;
            state.trump = null;
            dealCards();
        }

        function showHistory() {
            if(state.history.length === 0) {
                alert('Brak historii - zagraj pierwszą rundę!');
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            html += '<table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">';
            html += '<tr style="background: #f0f0f0; font-weight: bold;"><th style="padding:8px; border:1px solid #ddd;">Runda</th><th style="border:1px solid #ddd;">Typ</th><th style="border:1px solid #ddd;">Dealer</th><th style="border:1px solid #ddd;">Ty</th><th style="border:1px solid #ddd;">Darek</th><th style="border:1px solid #ddd;">Leszek</th></tr>';
            
            state.history.forEach(h => {
                let gameSymbol = '';
                let g = GAMES.find(x => x.id === h.gameType);
                if(g) {
                    if(g.trump) gameSymbol = g.trump;
                    else if(g.id === 'bezatu') gameSymbol = 'BA';
                    else if(g.id === 'bezlew') gameSymbol = 'BL';
                }
                
                html += '<tr>';
                html += `<td style="padding:8px; border:1px solid #ddd; text-align:center;">${h.round}</td>`;
                html += `<td style="border:1px solid #ddd; text-align:center;">${gameSymbol}</td>`;
                html += `<td style="border:1px solid #ddd; text-align:center;">${NAMES[PLAYERS[h.dealer]]}</td>`;
                
                PLAYERS.forEach(pid => {
                    let score = h.roundScores[pid];
                    let cumScore = h.cumulativeScores[pid];
                    let color = score >= 0 ? 'green' : 'red';
                    html += `<td style="border:1px solid #ddd; text-align:center; padding:5px;">`;
                    html += `<div style="color:${color}; font-weight:bold;">${score>0?'+':''}${score}</div>`;
                    html += `<div style="font-size:0.8rem; opacity:0.7;">(${cumScore>0?'+':''}${cumScore})</div>`;
                    html += `</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</table></div>';
            html += '<div style="margin-top:15px; font-size:0.8rem; opacity:0.7;">Górna liczba: wynik rundy | (Dolna): suma kumulowana</div>';
            
            showModal('Historia gry', html);
        }

        function endGame() {
            let winner = PLAYERS.reduce((w, p) => state.scores[p] > state.scores[w] ? p : w, PLAYERS[0]);
            let html = `<div style="text-align:center; font-size:1.5rem; color:#2e7d32;">Wygrał: ${NAMES[winner]}!</div>`;
            html += '<br><div style="font-size:0.9rem;">Wciśnij Dalej, aby wrócić do menu.</div>';
            
            showModal('Koniec Gry', html);
            document.querySelector('#modal button').onclick = () => location.reload();
        }

        function updateDisplay() {
            // Wyniki
            ['Human','Darek','Leszek'].forEach(name => {
                let key = name.toLowerCase();
                document.getElementById('score'+name).textContent = state.scores[key];
                document.getElementById('tricks'+name).textContent = state.tricks[key];
            });
            
            // Wyświetl użyte typy gier
            let usedGamesHtml = '';
            PLAYERS.forEach(pid => {
                let played = state.played[pid] || [];
                if(played.length > 0) {
                    let symbols = played.map(gid => {
                        let g = GAMES.find(x => x.id === gid);
                        if(!g) return gid;
                        if(g.trump) return g.trump;
                        if(g.id === 'bezatu') return 'BA';
                        if(g.id === 'bezlew') return 'BL';
                        return g.name.substring(0,2);
                    }).join(' ');
                    usedGamesHtml += `<span style="margin-right:10px;"><strong>${NAMES[pid]}:</strong> ${symbols}</span>`;
                }
            });
            if(usedGamesHtml) {
                document.getElementById('usedGames').innerHTML = usedGamesHtml;
            }

            // Przeciwnicy (góra)
            let opHtml = '';
            let op1 = PLAYERS[1];
            let op2 = PLAYERS[2];
            
            [op1, op2].forEach(pid => {
                let idx = PLAYERS.indexOf(pid);
                let isActive = state.current === idx;
                let activeClass = isActive ? 'active' : '';
                opHtml += `
                    <div class="opponent ${activeClass}">
                        <div class="op-name">${NAMES[pid]}</div>
                        <div class="op-cards">`;
                for(let k=0; k<state.hands[pid].length; k++) {
                    opHtml += `<div class="card-back"></div>`;
                }
                opHtml += `</div></div>`;
            });
            document.getElementById('opponents').innerHTML = opHtml;

            // Stół (Lewa)
            let trickHtml = '';
            state.trick.forEach((t, i) => {
                let pClass = 'trick-p' + t.player;
                trickHtml += `
                    <div class="played-card-wrapper ${pClass}">
                        <div class="played-label">${NAMES[PLAYERS[t.player]]}</div>
                        ${renderCardHTML(t.card, false, true, false)}
                    </div>
                `;
            });
            document.getElementById('trickZone').innerHTML = trickHtml;

            let pName = document.getElementById('playerName');
            pName.className = 'my-name' + (state.current === 0 ? ' active' : '');
            
            // Komunikat zależny od fazy
            if(state.phase === 'musik' && state.musik.length === 0) {
                pName.textContent = `Wybierz 4 karty do oddania (${state.selected.length}/4)`;
            } else {
                pName.textContent = state.current === 0 ? 'Twoja kolej!' : (state.phase === 'choosing' ? 'Wybór gry...' : 'Czekaj...');
            }
            
            // RENDEROWANIE RĘKI GRACZA
            let handHtml = '';
            
            // Zawsze sprawdź czy gracz ma karty
            if(!state.hands.human || state.hands.human.length === 0) {
                console.error('BŁĄD: Brak kart w ręce gracza!');
                handHtml = '<div style="color:white;">Błąd: brak kart</div>';
            } else if(state.phase === 'windykacja') {
                // Windykacja - wybór kart do oddania/przyjęcia
                console.log('Renderuję karty w fazie WINDYKACJA');
                state.hands.human.forEach(card => {
                    let isSel = state.selected.find(c => c.id === card.id);
                    handHtml += renderCardHTML(card, isSel, true, true);
                });
            } else if(state.phase === 'musik' && state.musik.length === 0) {
                // Podczas fazy musik (oddawanie kart) - wszystkie karty klikalne
                console.log('Renderuję karty w fazie MUSIK');
                state.hands.human.forEach(card => {
                    let isSel = state.selected.find(c => c.id === card.id);
                    handHtml += renderCardHTML(card, isSel, true, true);
                });
            } else if(state.phase === 'playing' && state.current === 0) {
                // Podczas gry - tylko valid karty klikalne
                console.log('Renderuję karty w fazie PLAYING (moja kolej)');
                let valid = getValid(state.hands.human, state.trick, state.trump);
                console.log('Valid cards IDs:', valid.map(c => c.id));
                console.log('All hand IDs:', state.hands.human.map(c => c.id));
                
                state.hands.human.forEach(card => {
                    let canPlay = valid.find(c => c.id === card.id);
                    if(!canPlay) {
                        console.log('Karta DISABLED:', card.id);
                    }
                    handHtml += renderCardHTML(card, false, canPlay, true);
                });
            } else {
                // W innych fazach - karty widoczne ale nie klikalne
                console.log('Renderuję karty - nie moja kolej, phase:', state.phase);
                state.hands.human.forEach(card => {
                    handHtml += renderCardHTML(card, false, true, false);
                });
            }
            
            document.getElementById('playerHand').innerHTML = handHtml;
            
            // Make sure hand is visible
            document.getElementById('playerHand').style.display = 'flex';
            
            // Przycisk potwierdzenia podczas oddawania kart
            let actionsHtml = '';
            if(state.phase === 'musik' && state.musik.length === 0) {
                let disabled = state.selected.length !== 4 ? 'disabled' : '';
                actionsHtml = `<button class="btn" onclick="confirmDiscard()" ${disabled}>Potwierdź wybór (${state.selected.length}/4)</button>`;
            }
            document.getElementById('playerActions').innerHTML = actionsHtml;
            
            // Debug
            console.log('=== UPDATE DISPLAY ===');
            console.log('Phase:', state.phase);
            console.log('Current player:', state.current, '(' + NAMES[PLAYERS[state.current]] + ')');
            console.log('Musik length:', state.musik.length);
            console.log('Hand size:', state.hands.human ? state.hands.human.length : 'BRAK');
            console.log('Selected:', state.selected.length);
            console.log('Cards rendered:', handHtml ? 'TAK' : 'NIE');
        }

        function renderCardHTML(card, selected, enabled, clickable) {
            let colorClass = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
            let selClass = selected ? 'selected' : '';
            let disClass = !enabled ? 'disabled' : '';
            
            // data-card-id dla bezpieczeństwa z Unicode
            let dataAttr = (clickable && enabled) ? `data-card-id="${card.id}"` : '';
            let cursorStyle = (clickable && enabled) ? 'cursor:pointer;' : '';
            
            return `
                <div class="card ${colorClass} ${selClass} ${disClass}" ${dataAttr} style="${cursorStyle}">
                    <div class="card-top"><span class="rank">${card.rank}</span><span class="suit">${card.suit}</span></div>
                    <div class="card-bottom"><span class="rank">${card.rank}</span><span class="suit">${card.suit}</span></div>
                </div>
            `;
        }

        // === KLIKANIE KART - PROSTA WERSJA ===
        
        function playMyCard(cardId) {
            console.log('>>> KLIK KARTY:', cardId);
            
            // Znajdź kartę
            let card = state.hands.human.find(c => c.id === cardId);
            if(!card) {
                console.error('Nie ma takiej karty!');
                return;
            }
            
            // FAZA 0: Windykacja
            if(state.phase === 'windykacja') {
                console.log('Tryb: windykacja - wybieranie kart');
                
                // Czy już wybrana?
                let idx = state.selected.findIndex(c => c.id === cardId);
                if(idx >= 0) {
                    // Odznacz
                    state.selected.splice(idx, 1);
                    console.log('Odznaczono, teraz wybrano:', state.selected.length);
                } else {
                    // Zaznacz (max windykacjaCount)
                    if(state.selected.length < state.windykacjaCount) {
                        state.selected.push(card);
                        console.log('Zaznaczono, teraz wybrano:', state.selected.length);
                    }
                }
                
                // Aktywuj/dezaktywuj przycisk potwierdzenia
                let btn = document.getElementById('confirmWindGive') || document.getElementById('confirmWindRec');
                if(btn) {
                    btn.disabled = state.selected.length !== state.windykacjaCount;
                }
                
                updateDisplay();
                return;
            }
            
            // FAZA 1: Oddawanie kart (musik)
            if(state.phase === 'musik' && state.musik.length === 0) {
                console.log('Tryb: wybieranie kart do oddania');
                
                // Czy już wybrana?
                let idx = state.selected.findIndex(c => c.id === cardId);
                if(idx >= 0) {
                    // Odznacz
                    state.selected.splice(idx, 1);
                    console.log('Odznaczono, teraz wybrano:', state.selected.length);
                } else {
                    // Zaznacz (max 4)
                    if(state.selected.length < 4) {
                        state.selected.push(card);
                        console.log('Zaznaczono, teraz wybrano:', state.selected.length);
                    }
                }
                updateDisplay();
                return;
            }
            
            // FAZA 2: Granie
            if(state.phase === 'playing' && state.current === 0) {
                console.log('Tryb: granie karty');
                
                // Sprawdź czy dozwolona
                let valid = getValid(state.hands.human, state.trick, state.trump);
                let ok = valid.find(c => c.id === cardId);
                
                if(!ok) {
                    console.log('TA KARTA JEST NIEDOZWOLONA!');
                    alert('Nie możesz zagrać tej karty!');
                    return;
                }
                
                console.log('OK, zagrywa kartę!');
                playCard(card, 0);
                return;
            }
            
            console.log('Nie Twoja kolej lub zła faza');
        }
        
        // === EVENT DELEGATION - JEDEN LISTENER DLA WSZYSTKICH KART ===
        document.getElementById('playerHand').addEventListener('click', function(e) {
            // Znajdź kliknięty element karty
            let cardEl = e.target.closest('.card[data-card-id]');
            if(!cardEl) {
                console.log('Kliknięto, ale nie kartę');
                return;
            }
            
            let cardId = cardEl.getAttribute('data-card-id');
            console.log('>>> EVENT DELEGATION - KLIKNIĘTO:', cardId);
            playMyCard(cardId);
        });
        console.log('Event listener dodany do #playerHand');
        
        // === GLOBALNE FUNKCJE ===
        window.playMyCard = playMyCard;
        window.startGame = startGame;
        window.chooseGame = chooseGame;
        window.takeMusik = takeMusik;
        window.confirmDiscard = confirmDiscard;
        window.closeModal = closeModal;
        window.confirmWindykacjaGive = confirmWindykacjaGive;
        window.confirmWindykacjaReceive = confirmWindykacjaReceive;
        window.showHistory = showHistory;
        
        console.log('=== GRA ZAŁADOWANA ===');
        console.log('Dostępne funkcje globalne:', Object.keys(window).filter(k => ['playMyCard','startGame','chooseGame','takeMusik','confirmDiscard','closeModal'].includes(k)));
        console.log('Test playMyCard:', typeof window.playMyCard);
        
        // Funkcja testowa
        window.testClick = function() {
            alert('KLIK DZIAŁA!');
            console.log('TEST CLICK OK!');
        };
        
        // Test kliknięcia
        setTimeout(() => {
            console.log('>>> READY TO PLAY <<<');
            console.log('Aby przetestować klik, wywołaj w konsoli: testClick()');
        }, 1000);

        function setMessage(msg) {
            document.getElementById('message').textContent = msg;
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

    </script>
</body>
</html>
